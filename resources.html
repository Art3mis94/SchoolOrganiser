<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Tools</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .nav-active { background-color: #fff; color: #4338ca; box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06); }
    .tab-active { background-color: #fff; border-bottom: 2px solid #4f46e5; font-weight: 700; color: #4338ca; }
    .collapsible-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; padding:1rem; border-radius:0.75rem 0.75rem 0 0; }
    .drag-zone { border: 2px dashed #9ca3af; background-color: #f9fafb; text-align:center; padding:20px; margin-top:10px; border-radius:8px; transition:all 0.2s; }
    .drag-over { border-color:#4f46e5; background-color:#eef2ff; }
    button { transition:all 0.2s; }
</style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- Navbar -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
    <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
        <a href="dashboard.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
        <a href="curriculum_topics.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
        <a href="notes.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Notes üìù</a>
        <a href="todo.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">To-Do List ‚úÖ</a>
        <a href="resources.html" class="px-4 py-2 nav-active font-bold rounded-lg transition">Tools üõ†Ô∏è</a>
    </div>
</nav>

<!-- Page Content -->
<div class="container max-w-4xl mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-8 space-y-6">
    <h1 class="text-3xl font-bold text-center text-gray-800">Resources & Management Tools üõ†Ô∏è</h1>
    <p id="userIdDisplay" class="text-xs text-gray-400 mt-2 text-center">User ID: Loading...</p>

    <!-- Tabs -->
    <div class="flex border-b border-gray-300 mt-4">
        <button id="tabTools" onclick="showTab('tools')" class="tab-active py-2 px-4 text-gray-600 hover:text-indigo-700 transition">Management Tools</button>
        <button id="tabFiles" onclick="showTab('files')" class="py-2 px-4 text-gray-600 hover:text-indigo-700 transition">View Resources & Files</button>
    </div>

    <!-- Tools Tab -->
    <div id="contentTools" class="space-y-6">
        <!-- Lesson Resource Import -->
        <div class="bg-green-50 border-l-4 border-green-500 rounded-xl shadow-lg">
            <div class="collapsible-header bg-green-100" onclick="toggleCollapse('contentLessonImport', 'iconLessonImport')">
                <h2 class="text-xl font-bold text-green-700 flex items-center gap-3"><i class="fa-solid fa-file-import"></i> Bulk Import: Lesson Resources</h2>
                <i id="iconLessonImport" class="fa-solid fa-caret-down text-green-700"></i>
            </div>
            <div id="contentLessonImport" class="p-6 pt-0 space-y-4">
                <form id="lessonResourceImportForm" class="space-y-4">
                    <select id="importTopicSelect" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white" disabled>
                        <option value="">-- Select Parent Topic --</option>
                    </select>
                    <select id="importLessonSelect" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white" disabled>
                        <option value="">-- Select Target Lesson --</option>
                    </select>
                    <textarea id="importResourcesText" placeholder="Paste text resources or links here (one per line)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-y min-h-[100px]"></textarea>
                    <div id="fileLessonDropZone" class="drag-zone">
                        <p class="text-gray-500"><i class="fa-solid fa-file-circle-plus mr-2"></i> Drag & Drop File Here (No size limit)</p>
                        <input type="file" id="lessonFile" class="hidden">
                    </div>
                    <button type="submit" id="submitLessonImportBtn" class="w-full p-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition shadow-md">
                        <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Import Resource(s)
                    </button>
                </form>
                <p id="importLessonMessage" class="mt-4 text-center font-semibold hidden"></p>
            </div>
        </div>

        <!-- General Resource Import -->
        <div class="bg-indigo-50 border-l-4 border-indigo-500 rounded-xl shadow-lg">
            <div class="collapsible-header bg-indigo-100" onclick="toggleCollapse('contentGeneralImport', 'iconGeneralImport')">
                <h2 class="text-xl font-bold text-indigo-700 flex items-center gap-3"><i class="fa-solid fa-bookmark"></i> Quick Save: General Resources</h2>
                <i id="iconGeneralImport" class="fa-solid fa-caret-right text-indigo-700"></i>
            </div>
            <div id="contentGeneralImport" class="p-6 pt-0 space-y-4 hidden">
                <form id="generalResourceImportForm" class="space-y-4">
                    <textarea id="generalResourcesText" placeholder="Paste a general resource or link here" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y min-h-[80px]"></textarea>
                    <div id="fileDropZone" class="drag-zone">
                        <p class="text-gray-500"><i class="fa-solid fa-cloud-arrow-up mr-2"></i> Drag & Drop File Here (No size limit)</p>
                        <input type="file" id="generalFile" class="hidden">
                    </div>
                    <button type="submit" id="submitGeneralImportBtn" class="w-full p-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-md">
                        <i class="fa-solid fa-floppy-disk mr-2"></i> Save Resource
                    </button>
                </form>
                <p id="importGeneralMessage" class="mt-4 text-center font-semibold hidden"></p>
            </div>
        </div>
    </div>

    <!-- Files Tab -->
    <div id="contentFiles" class="hidden space-y-8">
        <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-xl shadow-inner">
            <h2 class="text-xl font-bold text-indigo-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-folder-open"></i> General Resources</h2>
            <div id="generalResourcesList" class="space-y-3">
                <p class="text-gray-500 italic p-2 text-center">Loading general resources...</p>
            </div>
        </div>
        <div class="p-4 bg-gray-50 border rounded-xl shadow-inner">
            <h2 class="text-xl font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-file-pdf"></i> Lesson Attachments</h2>
            <div id="uploadedFilesList" class="space-y-3">
                <p class="text-gray-500 italic p-2 text-center">Lesson attachments will appear here once curriculum data is loaded.</p>
            </div>
        </div>
    </div>
</div>

<!-- Firebase & App Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, orderBy, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- UI Elements ---
const userIdDisplay = document.getElementById('userIdDisplay');
const importTopicSelect = document.getElementById('importTopicSelect');
const importLessonSelect = document.getElementById('importLessonSelect');
const submitLessonImportBtn = document.getElementById('submitLessonImportBtn');
const submitGeneralImportBtn = document.getElementById('submitGeneralImportBtn');
const generalResourcesList = document.getElementById('generalResourcesList');
const uploadedFilesList = document.getElementById('uploadedFilesList');
const fileLessonDropZone = document.getElementById('fileLessonDropZone');
const fileDropZone = document.getElementById('fileDropZone');

let currentUser = null;
let curriculumTopics = [];
let curriculumLessons = {};

// --- Tabs ---
function showTab(tabId){
    document.getElementById('contentTools').classList.add('hidden');
    document.getElementById('contentFiles').classList.add('hidden');
    document.getElementById('tabTools').classList.remove('tab-active');
    document.getElementById('tabFiles').classList.remove('tab-active');
    document.getElementById('content'+tabId.charAt(0).toUpperCase()+tabId.slice(1)).classList.remove('hidden');
    document.getElementById('tab'+tabId.charAt(0).toUpperCase()+tabId.slice(1)).classList.add('tab-active');
}
window.showTab = showTab;

// --- Collapsible ---
function toggleCollapse(contentId, iconId){
    const content = document.getElementById(contentId);
    const icon = document.getElementById(iconId);
    if(content.classList.contains('hidden')){
        content.classList.remove('hidden');
        icon.classList.replace('fa-caret-right','fa-caret-down');
    } else {
        content.classList.add('hidden');
        icon.classList.replace('fa-caret-down','fa-caret-right');
    }
}
window.toggleCollapse = toggleCollapse;

// --- Firestore References ---
const topicsRef = (uid) => collection(db,'users',uid,'topics');
const generalResourcesRef = (uid) => collection(db,'users',uid,'generalResources');

// --- Load Topics and Lessons ---
async function loadCurriculumSelects(){
    if(!currentUser) return;
    const topicsSnapshot = await getDocs(query(topicsRef(currentUser.uid), orderBy('createdAt','asc')));
    curriculumTopics = []; curriculumLessons = {};
    importTopicSelect.innerHTML='<option value="">-- Select Parent Topic --</option>';
    importLessonSelect.innerHTML='<option value="">-- Select Target Lesson --</option>';

    const lessonPromises = [];
    topicsSnapshot.forEach(topicDoc=>{
        const topic = {id: topicDoc.id, ...topicDoc.data()};
        curriculumTopics.push(topic);
        const option = document.createElement('option');
        option.value = topic.id; option.textContent = topic.name;
        importTopicSelect.appendChild(option);

        const lessonsRef = collection(topicDoc.ref,'lessons');
        lessonPromises.push(getDocs(query(lessonsRef, orderBy('createdAt','asc'))).then(lessonsSnap=>{
            curriculumLessons[topic.id]=lessonsSnap.docs.map(l=>({id:l.id,...l.data()}));
        }));
    });
    await Promise.all(lessonPromises);
    importTopicSelect.disabled=false; importLessonSelect.disabled=true;
    loadAllLessonAttachments();
}

importTopicSelect.onchange = ()=>{
    const topicId = importTopicSelect.value;
    importLessonSelect.innerHTML='<option value="">-- Select Target Lesson --</option>'; importLessonSelect.disabled=true;
    if(topicId && curriculumLessons[topicId]){
        curriculumLessons[topicId].forEach(lesson=>{
            const option = document.createElement('option');
            option.value=lesson.id; option.textContent=lesson.title;
            importLessonSelect.appendChild(option);
        });
        importLessonSelect.disabled=false;
    }
};

// --- Drag & Drop ---
function setupDragAndDrop(dropZone,fileInput){
    dropZone.addEventListener('dragover',e=>{e.preventDefault(); dropZone.classList.add('drag-over');});
    dropZone.addEventListener('dragleave',()=>{dropZone.classList.remove('drag-over');});
    dropZone.addEventListener('drop',e=>{e.preventDefault(); dropZone.classList.remove('drag-over'); fileInput.files=e.dataTransfer.files;});
    fileInput.onchange=()=>{if(fileInput.files.length>0) dropZone.querySelector('p').innerHTML=`<i class="fa-solid fa-check mr-2"></i> File selected: ${fileInput.files[0].name}`;};
    dropZone.onclick=()=>fileInput.click();
}
setupDragAndDrop(fileLessonDropZone, document.getElementById('lessonFile'));
setupDragAndDrop(fileDropZone, document.getElementById('generalFile'));

// --- General Resources ---
function loadGeneralResources(){
    if(!currentUser) return;
    const q=query(generalResourcesRef(currentUser.uid), orderBy('createdAt','desc'));
    onSnapshot(q,snapshot=>{
        generalResourcesList.innerHTML='';
        if(snapshot.empty){ generalResourcesList.innerHTML='<p class="text-gray-500 italic p-2 text-center">No general resources saved yet.</p>'; }
        snapshot.docs.forEach(docSnap=>{
            const res={id:docSnap.id,...docSnap.data()};
            const div=document.createElement('div');
            div.className='flex justify-between items-center p-3 bg-white rounded-lg border shadow-sm';
            let link='#', text=res.text||'Untitled';
            let icon='fa-file-alt text-gray-600';
            if(res.url){ link=res.url; icon=res.type==='file'?'fa-file-upload text-purple-600':'fa-link text-blue-600'; text=res.text||res.url;}
            else if(res.text && res.text.startsWith('http')){ link=res.text; icon='fa-link text-blue-600';}
            div.innerHTML=`<div class="truncate flex items-center gap-2"><i class="fa-solid ${icon}"></i> <a href="${link}" target="_blank" class="text-gray-700 hover:text-indigo-600 truncate">${text}</a></div>
            <button class="deleteResourceBtn text-red-500 hover:text-red-700 ml-4 flex-shrink-0" data-id="${res.id}"><i class="fa-solid fa-trash"></i></button>`;
            generalResourcesList.appendChild(div);
        });
        generalResourcesList.querySelectorAll('.deleteResourceBtn').forEach(btn=>{
            btn.onclick=async e=>{
                const id=e.currentTarget.dataset.id;
                if(confirm('Delete this general resource?')) await deleteDoc(doc(generalResourcesRef(currentUser.uid),id));
            };
        });
    });
}

// --- Lesson Attachments ---
async function loadAllLessonAttachments(){
    uploadedFilesList.innerHTML='';
    let count=0;
    for(const topic of curriculumTopics){
        const lessons = curriculumLessons[topic.id] || [];
        for(const lesson of lessons){
            const files=lesson.files||[], links=lesson.links||[];
            files.forEach(file=>{
                count++; const div=document.createElement('div'); div.className='p-3 bg-white rounded-lg border shadow-sm flex justify-between items-center';
                div.innerHTML=`<div class="truncate flex items-center gap-2"><i class="fa-solid fa-file-pdf text-orange-600"></i> <a href="${file.url}" target="_blank" class="text-gray-700 hover:text-indigo-600 truncate">${file.name}</a></div><span class="text-xs text-gray-500 ml-4 flex-shrink-0">Linked to: ${topic.name} / ${lesson.title}</span>`;
                uploadedFilesList.appendChild(div);
            });
            links.forEach(link=>{
                count++; const div=document.createElement('div'); div.className='p-3 bg-white rounded-lg border shadow-sm flex justify-between items-center';
                div.innerHTML=`<div class="truncate flex items-center gap-2"><i class="fa-solid fa-link text-blue-600"></i> <a href="${link}" target="_blank" class="text-gray-700 hover:text-indigo-600 truncate">${link}</a></div><span class="text-xs text-gray-500 ml-4 flex-shrink-0">Linked to: ${topic.name} / ${lesson.title}</span>`;
                uploadedFilesList.appendChild(div);
            });
        }
    }
    if(count===0){
        uploadedFilesList.innerHTML='<p class="text-gray-500 italic p-2 text-center">No lesson attachments yet.</p>';
    }
}

// --- Handle General Resource Submission ---
document.getElementById('generalResourceImportForm').onsubmit = async (e)=>{
    e.preventDefault();
    if(!currentUser) return alert('User not authenticated.');
    const text = document.getElementById('generalResourcesText').value.trim();
    const fileInput = document.getElementById('generalFile');
    if(!text && fileInput.files.length===0) return alert('Please provide a resource or file.');

    let resData = {createdAt: new Date()};
    if(text) resData.text = text;
    if(fileInput.files.length>0){
        const file = fileInput.files[0];
        resData.type = 'file';
        resData.name = file.name;
        resData.url = URL.createObjectURL(file); // External blob URL, no Firebase upload
    } else { resData.type='link'; }
    
    await addDoc(generalResourcesRef(currentUser.uid), resData);
    document.getElementById('generalResourcesText').value='';
    fileInput.value=''; fileDropZone.querySelector('p').innerHTML='<i class="fa-solid fa-cloud-arrow-up mr-2"></i> Drag & Drop File Here (No size limit)';
    document.getElementById('importGeneralMessage').textContent='Saved successfully!';
    document.getElementById('importGeneralMessage').classList.remove('hidden');
    setTimeout(()=>document.getElementById('importGeneralMessage').classList.add('hidden'),2000);
};

// --- Handle Lesson Resource Submission ---
document.getElementById('lessonResourceImportForm').onsubmit = async (e)=>{
    e.preventDefault();
    if(!currentUser) return alert('User not authenticated.');
    const topicId = importTopicSelect.value;
    const lessonId = importLessonSelect.value;
    if(!topicId || !lessonId) return alert('Please select topic and lesson.');

    const textLines = document.getElementById('importResourcesText').value.split('\n').map(l=>l.trim()).filter(Boolean);
    const fileInput = document.getElementById('lessonFile');

    // Find lesson doc
    const lessonDocRef = doc(db, 'users', currentUser.uid, 'topics', topicId, 'lessons', lessonId);
    const lessonSnap = await getDocs(collection(lessonDocRef, 'dummy')); // to check existence
    // Since Firestore subcollections can be empty, we'll just update files and links arrays
    const lessonDataRef = doc(db,'users',currentUser.uid,'topics',topicId,'lessons',lessonId);

    // Existing data
    const lessonDocSnap = await getDocs(collection(db,'users',currentUser.uid,'topics',topicId,'lessons'));
    let lessonData = {};
    if(curriculumLessons[topicId]){
        const l = curriculumLessons[topicId].find(l=>l.id===lessonId);
        if(l) lessonData = {...l};
    }

    const files = lessonData.files || [];
    const links = lessonData.links || [];

    // Add text lines as links
    textLines.forEach(line=>links.push(line));

    // Add file
    if(fileInput.files.length>0){
        const file = fileInput.files[0];
        files.push({name:file.name, url:URL.createObjectURL(file)}); // external blob URL
    }

    await updateDoc(lessonDataRef, {files, links});

    document.getElementById('importResourcesText').value='';
    fileInput.value=''; fileLessonDropZone.querySelector('p').innerHTML='<i class="fa-solid fa-file-circle-plus mr-2"></i> Drag & Drop File Here (No size limit)';
    document.getElementById('importLessonMessage').textContent='Lesson resources synced successfully!';
    document.getElementById('importLessonMessage').classList.remove('hidden');
    setTimeout(()=>document.getElementById('importLessonMessage').classList.add('hidden'),2000);

    loadAllLessonAttachments();
};

// --- Auth Listener ---
onAuthStateChanged(auth,user=>{
    if(user){
        currentUser = user;
        userIdDisplay.textContent=`User ID: ${user.uid}`;
        loadCurriculumSelects();
        loadGeneralResources();
    } else {
        currentUser=null;
        userIdDisplay.textContent='Not signed in';
    }
});
</script>

</body>
</html>