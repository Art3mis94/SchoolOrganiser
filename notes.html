<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f4f6; }
  .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
  .note-box { @apply bg-white p-5 rounded-xl shadow-md border border-gray-200; }
  .collapsible-content { transition: max-height 0.24s ease-out, opacity 0.24s; overflow: hidden; }
  .modal-backdrop { background-color: rgba(17,24,39,0.6); }
  .small-muted { font-size:0.85rem; color:#6b7280; }
</style>
</head>
<body>

<!-- NAV -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4 items-center">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="curriculum_topics.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="signout-btn" class="ml-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<!-- CONTAINER -->
<div class="container max-w-4xl mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-8">

  <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Daily Notes üìù</h1>

  <!-- Loading / Status -->
  <div id="statusBar" class="text-center mb-4 hidden"></div>

  <!-- Create (collapsible) -->
  <div class="bg-indigo-50 p-5 rounded-xl mb-6">
    <div id="newNoteHeader" class="flex justify-between items-center cursor-pointer text-indigo-800">
      <h2 class="text-xl font-bold">Create a New Note</h2>
      <i id="toggleIcon" class="fa-solid fa-chevron-down"></i>
    </div>

    <div id="newNoteContent" class="collapsible-content mt-4 hidden">
      <input id="noteTitle" type="text" placeholder="Note Title..." class="w-full p-3 border rounded-lg mb-3" />
      <textarea id="noteText" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3" rows="5"></textarea>

      <label class="font-semibold block mb-1 text-gray-700">Attach Files (optional)</label>
      <input id="noteFiles" type="file" multiple class="w-full mb-3" />

      <label class="font-semibold block mb-1 text-gray-700">Add Links (optional)</label>
      <input id="noteLinks" type="text" placeholder="Comma-separated URLs (https://...)" class="w-full p-3 border rounded-lg mb-4" />

      <div class="flex gap-3">
        <button id="saveNoteBtn" class="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">Save Note</button>
        <button id="clearNoteBtn" class="py-3 px-4 bg-gray-100 rounded-lg hover:bg-gray-200">Clear</button>
      </div>

      <p class="small-muted mt-2">Files are uploaded to Firebase Storage. Max file size: <strong>20 MB</strong> each.</p>
    </div>
  </div>

  <!-- Notes list -->
  <div id="notesContainer" class="space-y-4">
    <p class="text-gray-500 italic text-center">Loading notes...</p>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-indigo-700">Edit Note</h3>
      <button id="closeEditModal" class="text-gray-500 hover:text-gray-800 text-2xl"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="space-y-4">
      <input id="editTitle" type="text" class="w-full p-3 border rounded-md" />
      <textarea id="editText" rows="5" class="w-full p-3 border rounded-md"></textarea>

      <div>
        <label class="font-semibold">Existing Attachments</label>
        <div id="existingFiles" class="space-y-2 mt-2"></div>
      </div>

      <div>
        <label class="font-semibold">Add More Files</label>
        <input id="editFiles" type="file" multiple class="w-full mt-2" />
      </div>

      <div>
        <label class="font-semibold">Links (comma-separated)</label>
        <input id="editLinks" type="text" class="w-full p-2 border rounded-md" />
      </div>

      <div class="flex gap-3 justify-end">
        <button id="saveEditBtn" class="py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700">Save</button>
        <button id="cancelEditBtn" class="py-2 px-4 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase + Logic -->
<script type="module">
/* Notes page with direct Firebase Storage uploads.
   - Per-file limit: 20 MB
   - Firestore path: artifacts / school-organiser-5f512 / users / <uid> / daily_notes
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, collection, doc, setDoc, addDoc, deleteDoc, onSnapshot, getDoc, updateDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const APP_ID = "school-organiser-5f512";
const MAX_FILE_BYTES = 20 * 1024 * 1024; // 20 MB

// --- Firebase config (same as your other pages) ---
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM refs
const newNoteHeader = document.getElementById('newNoteHeader');
const newNoteContent = document.getElementById('newNoteContent');
const toggleIcon = document.getElementById('toggleIcon');
const saveNoteBtn = document.getElementById('saveNoteBtn');
const clearNoteBtn = document.getElementById('clearNoteBtn');
const noteTitle = document.getElementById('noteTitle');
const noteText = document.getElementById('noteText');
const noteFiles = document.getElementById('noteFiles');
const noteLinks = document.getElementById('noteLinks');
const notesContainer = document.getElementById('notesContainer');
const statusBar = document.getElementById('statusBar');

const editModal = document.getElementById('editModal');
const closeEditModal = document.getElementById('closeEditModal');
const editTitle = document.getElementById('editTitle');
const editText = document.getElementById('editText');
const editFiles = document.getElementById('editFiles');
const editLinks = document.getElementById('editLinks');
const existingFilesEl = document.getElementById('existingFiles');
const saveEditBtn = document.getElementById('saveEditBtn');
const cancelEditBtn = document.getElementById('cancelEditBtn');

let currentUser = null;
let NOTES_REF = null;
let editingNoteId = null;

// collapse handler
newNoteHeader.addEventListener('click', () => {
  newNoteContent.classList.toggle('hidden');
  toggleIcon.classList.toggle('fa-chevron-up');
  toggleIcon.classList.toggle('fa-chevron-down');
});

// Sign out
document.getElementById('signout-btn').onclick = () => signOut(auth).then(()=>location.href='index.html').catch(e=>console.error(e));

// utility: set status
function setStatus(text = '', isError = false, autoHideMs = 3000) {
  if (!text) { statusBar.classList.add('hidden'); statusBar.textContent = ''; return; }
  statusBar.classList.remove('hidden');
  statusBar.textContent = text;
  statusBar.classList.toggle('text-red-600', isError);
  statusBar.classList.toggle('text-green-700', !isError);
  if (autoHideMs) setTimeout(()=> { statusBar.classList.add('hidden'); }, autoHideMs);
}

// format links to ensure http(s)
function normalizeLinksFromString(s) {
  if (!s) return [];
  return s.split(',').map(x => x.trim()).filter(Boolean).map(u => {
    return (/^https?:\/\//i.test(u)) ? u : `https://${u}`;
  });
}

// storage helper: upload a File object to path and return {name,url}
async function uploadFileToStorage(file, noteId) {
  if (file.size > MAX_FILE_BYTES) throw new Error(`${file.name} is larger than 20 MB`);
  const path = `artifacts/${APP_ID}/users/${currentUser.uid}/daily_notes/${noteId}/${file.name}`;
  const fileRef = ref(storage, path);
  await uploadBytes(fileRef, file);
  const url = await getDownloadURL(fileRef);
  return { name: file.name, url };
}

// delete file from storage by name
async function deleteFileFromStorage(name, noteId) {
  const path = `artifacts/${APP_ID}/users/${currentUser.uid}/daily_notes/${noteId}/${name}`;
  const fileRef = ref(storage, path);
  try {
    await deleteObject(fileRef);
  } catch (err) {
    // ignore not-found
    if (err && err.code !== 'storage/object-not-found') console.warn('Delete file error', err);
  }
}

// Auth + setup
onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = 'index.html';
    return;
  }
  currentUser = user;
  NOTES_REF = collection(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'daily_notes');
  startNotesListener();
});

// listen notes
function startNotesListener() {
  const q = query(NOTES_REF, orderBy('createdAt', 'desc'));
  onSnapshot(q, snapshot => {
    notesContainer.innerHTML = '';
    if (snapshot.empty) {
      notesContainer.innerHTML = `<p class="text-gray-500 italic text-center">No notes yet. Create one above.</p>`;
      return;
    }
    snapshot.forEach(docSnap => {
      const data = { id: docSnap.id, ...docSnap.data() };
      notesContainer.appendChild(renderNoteElement(data));
    });
  }, err => {
    console.error('notes listener error', err);
    notesContainer.innerHTML = `<p class="text-red-600 text-center">Failed to load notes. Check console.</p>`;
  });
}

// render single note
function renderNoteElement(note) {
  const div = document.createElement('div');
  div.className = 'note-box';

  const filesHtml = (note.files || []).map(f => 
    `<li><a class="text-indigo-600 hover:text-indigo-800 underline" href="${f.url}" target="_blank" rel="noopener noreferrer">${f.name}</a></li>`
  ).join('');

  const linksHtml = (note.links || []).map(l =>
    `<li><a class="text-indigo-600 hover:text-indigo-800 underline" href="${l}" target="_blank" rel="noopener noreferrer">${l}</a></li>`
  ).join('');

  div.innerHTML = `
    <div class="flex justify-between items-start cursor-pointer collapsible">
      <div>
        <h3 class="text-lg font-semibold">${escapeHtml(note.title)}</h3>
        <p class="small-muted">${note.createdAt ? new Date(note.createdAt.seconds ? note.createdAt.seconds*1000 : note.createdAt).toLocaleString() : ''}</p>
      </div>
      <div class="flex gap-2">
        <button class="editBtn text-blue-600" title="Edit"><i class="fa-solid fa-pen"></i></button>
        <button class="deleteBtn text-red-600" title="Delete"><i class="fa-solid fa-trash"></i></button>
      </div>
    </div>
    <div class="content mt-3 collapsible-content hidden">
      <p class="mb-3 whitespace-pre-wrap">${escapeHtml(note.text || '')}</p>
      ${linksHtml ? `<h4 class="font-semibold text-gray-700">Links</h4><ul class="list-disc ml-6 mb-3 text-sm">${linksHtml}</ul>` : ''}
      ${filesHtml ? `<h4 class="font-semibold text-gray-700">Attachments</h4><ul class="list-disc ml-6 mb-3 text-sm">${filesHtml}</ul>` : ''}
    </div>
  `;

  // toggle
  div.querySelector('.collapsible').addEventListener('click', (e) => {
    // don't toggle when pressing edit/delete buttons
    if (e.target.closest('.editBtn') || e.target.closest('.deleteBtn')) return;
    const content = div.querySelector('.content');
    content.classList.toggle('hidden');
  });

  // edit
  div.querySelector('.editBtn').onclick = (e) => {
    e.stopPropagation();
    openEditModal(note);
  };

  // delete
  div.querySelector('.deleteBtn').onclick = async (e) => {
    e.stopPropagation();
    if (!confirm('Delete this note and all its attachments?')) return;
    try {
      // delete files from storage first
      const files = note.files || [];
      await Promise.all(files.map(f => deleteFileFromStorage(f.name, note.id)));
      await deleteDoc(doc(NOTES_REF, note.id));
      setStatus('Note deleted', false, 2500);
    } catch (err) {
      console.error('delete note error', err);
      setStatus('Failed to delete note (see console)', true, 4000);
    }
  };

  return div;
}

// escape HTML to avoid injection
function escapeHtml(s='') {
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

// create note
saveNoteBtn.onclick = async () => {
  if (!currentUser) return setStatus('Not authenticated', true);
  const title = noteTitle.value.trim();
  const text = noteText.value.trim();
  const rawLinks = noteLinks.value.trim();
  const files = Array.from(noteFiles.files || []);

  if (!title || !text) { setStatus('Title and text required', true); return; }

  // check file sizes
  for (const f of files) {
    if (f.size > MAX_FILE_BYTES) {
      setStatus(`"${f.name}" exceeds 20 MB limit`, true, 5000);
      return;
    }
  }

  // create doc ref w/ id so we can upload files into that folder
  const docRef = doc(NOTES_REF);
  const noteId = docRef.id;

  saveNoteBtn.disabled = true;
  setStatus('Uploading files (if any) & saving note...', false, 0);

  try {
    // upload files
    const uploadedFiles = [];
    for (const f of files) {
      const uploaded = await uploadFileToStorage(f, noteId);
      uploadedFiles.push(uploaded);
    }

    const links = normalizeLinksFromString(rawLinks);

    await setDoc(docRef, {
      title,
      text,
      files: uploadedFiles,
      links,
      createdAt: new Date()
    });

    // reset UI
    noteTitle.value = '';
    noteText.value = '';
    noteFiles.value = '';
    noteLinks.value = '';
    newNoteContent.classList.add('hidden');
    toggleIcon.classList.replace('fa-chevron-up','fa-chevron-down');
    setStatus('Note saved', false, 2500);
  } catch (err) {
    console.error('save note error', err);
    setStatus('Error saving note (see console)', true, 5000);
  } finally {
    saveNoteBtn.disabled = false;
  }
};

// Clear create form
clearNoteBtn.onclick = () => {
  noteTitle.value = '';
  noteText.value = '';
  noteFiles.value = '';
  noteLinks.value = '';
};

// ---- Edit modal functions ----
function openEditModal(note) {
  editingNoteId = note.id;
  editTitle.value = note.title || '';
  editText.value = note.text || '';
  editLinks.value = (note.links || []).join(', ');
  existingFilesEl.innerHTML = '';
  (note.files || []).forEach((f, idx) => {
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between gap-3 p-2 bg-gray-50 rounded-md';
    row.innerHTML = `<div class="truncate"><a href="${f.url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">${f.name}</a></div>
      <div class="flex gap-2">
        <button data-name="${f.name}" class="removeExistingFileBtn text-red-600 px-2 py-1 rounded-md hover:bg-red-50">Remove</button>
      </div>`;
    existingFilesEl.appendChild(row);
  });

  // attach remove handlers
  existingFilesEl.querySelectorAll('.removeExistingFileBtn').forEach(btn => {
    btn.onclick = async (e) => {
      const name = e.currentTarget.dataset.name;
      if (!confirm(`Remove attachment "${name}" from this note (and delete from Storage)?`)) return;
      try {
        await deleteFileFromStorage(name, editingNoteId);
        // update Firestore doc by removing that file entry
        const docRef = doc(NOTES_REF, editingNoteId);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return;
        const noteData = docSnap.data();
        const newFiles = (noteData.files || []).filter(f => f.name !== name);
        await updateDoc(docRef, { files: newFiles });
        // refresh existingFilesEl by re-opening modal (or re-fetching doc)
        const updated = await getDoc(docRef);
        openEditModal({ id: editingNoteId, ...updated.data() });
        setStatus('Attachment removed', false, 2000);
      } catch (err) {
        console.error('remove existing file err', err);
        setStatus('Failed to remove file (see console)', true, 4000);
      }
    };
  });

  // show modal
  editModal.classList.remove('hidden');
  editModal.style.display = 'flex';
}

// close handlers
closeEditModal.onclick = closeEdit;
cancelEditBtn.onclick = closeEdit;
function closeEdit() {
  editingNoteId = null;
  editFiles.value = '';
  editModal.classList.add('hidden');
  editModal.style.display = 'none';
}

// save edits
saveEditBtn.onclick = async () => {
  if (!editingNoteId) return;
  const title = editTitle.value.trim();
  const text = editText.value.trim();
  const rawLinks = editLinks.value.trim();
  const addedFiles = Array.from(editFiles.files || []);

  if (!title || !text) { setStatus('Title and text required', true); return; }

  // size check
  for (const f of addedFiles) {
    if (f.size > MAX_FILE_BYTES) {
      setStatus(`"${f.name}" exceeds 20 MB limit`, true, 5000);
      return;
    }
  }

  saveEditBtn.disabled = true;
  setStatus('Saving changes & uploading new files...', false, 0);

  try {
    const docRef = doc(NOTES_REF, editingNoteId);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) throw new Error('Note not found');

    const noteData = docSnap.data();
    const existingFiles = noteData.files || [];

    // upload new files
    const uploaded = [];
    for (const f of addedFiles) {
      const u = await uploadFileToStorage(f, editingNoteId);
      uploaded.push(u);
    }

    const links = normalizeLinksFromString(rawLinks);

    await updateDoc(docRef, {
      title,
      text,
      links,
      files: [...existingFiles, ...uploaded]
    });

    closeEdit();
    setStatus('Note updated', false, 2500);
  } catch (err) {
    console.error('save edit err', err);
    setStatus('Failed to update note (see console)', true, 5000);
  } finally {
    saveEditBtn.disabled = false;
  }
};

// helper: upload file with storage path
async function uploadFileToStorage(file, noteId) {
  const path = `artifacts/${APP_ID}/users/${currentUser.uid}/daily_notes/${noteId}/${file.name}`;
  const storageRef = ref(storage, path);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);
  return { name: file.name, url };
}

// small helper - normalize link input for create as well
function normalizeLinksFromString(s) {
  if (!s) return [];
  return s.split(',').map(x => x.trim()).filter(Boolean).map(u => (/^https?:\/\//i.test(u) ? u : `https://${u}`));
}

// Escape function used above is defined in outer scope - add a safe shim if not present
if (typeof escapeHtml !== 'function') {
  window.escapeHtml = (s='') => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

// done
</script>
</body>
</html>