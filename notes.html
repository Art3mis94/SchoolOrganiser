<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
  .note-box { @apply bg-white p-5 rounded-xl shadow-md border border-gray-200; }
  .collapsible-content { transition: max-height 0.3s ease-out; overflow: hidden; }
</style>
</head>
<body>

<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="curriculum_topics.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="signout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-4xl mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-8">
  <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Daily Notes üìù</h1>

  <div class="bg-indigo-50 p-5 rounded-xl mb-6">
    <div id="newNoteHeader" class="flex justify-between items-center cursor-pointer text-indigo-800 hover:text-indigo-900 transition">
      <h2 class="text-xl font-bold">Create a New Note</h2>
      <i id="toggleIcon" class="fa-solid fa-chevron-down"></i>
    </div>
    <div id="newNoteContent" class="collapsible-content mt-4 hidden">
      <input id="noteTitle" type="text" placeholder="Note Title..." class="w-full p-3 border rounded-lg mb-3">
      <textarea id="noteText" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3" rows="4"></textarea>

      <label class="font-semibold block mb-1 text-gray-700">Attach Files (Local Only):</label>
      <input id="noteFiles" type="file" multiple class="w-full p-2 bg-white border rounded-lg mb-4">

      <label class="font-semibold block mb-1 text-gray-700">Add Links (optional):</label>
      <input id="noteLinks" type="text" placeholder="Comma-separated URLs..." class="w-full p-3 border rounded-lg mb-4">

      <button id="saveNoteBtn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">
        Save Note
      </button>
    </div>
  </div>

  <div id="notesContainer" class="space-y-4">
    <p class="text-gray-500 italic text-center">Loading notes...</p>
  </div>
</div>

<script type="module">
// --- MODULE IMPORTS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
// IndexedDB wrapper for local file storage
import localforage from "https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"; 

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let NOTES_REF = null; // Collection reference set after user auth

// Configure localForage (IndexedDB wrapper)
localforage.config({
  name: 'EducatorHubFiles',
  storeName: 'attached_notes_files'
});

// DOM Elements
const notesContainer = document.getElementById("notesContainer");
const saveNoteBtn = document.getElementById("saveNoteBtn");

// --- CORE FUNCTIONS ---

// Navbar Sign Out
document.getElementById("signout-btn").addEventListener('click', () => signOut(auth));

// Collapse handling
const newNoteHeader = document.getElementById("newNoteHeader");
const newNoteContent = document.getElementById("newNoteContent");
const toggleIcon = document.getElementById("toggleIcon");
newNoteHeader.addEventListener('click', () => {
  newNoteContent.classList.toggle('hidden');
  toggleIcon.classList.toggle('fa-chevron-up');
  toggleIcon.classList.toggle('fa-chevron-down');
});

/**
 * Retrieves a file from IndexedDB and opens it in a new tab using a temporary object URL.
 * This is the mechanism for "external" file opening without cloud storage.
 */
window.openLocalFile = async (fileId) => {
  try {
    const file = await localforage.getItem(fileId);
    if (file) {
      const url = URL.createObjectURL(file);
      const win = window.open(url, '_blank');
      
      if (win) {
        // Revoke the object URL after the new window loads to free up memory
        win.onload = () => URL.revokeObjectURL(url);
      } else {
        URL.revokeObjectURL(url); 
        alert("Please allow pop-ups to open the file in a new tab.");
      }
    } else {
      alert("File not found on this device. Attachments are saved locally and do not sync.");
    }
  } catch (err) {
    console.error("Error retrieving file from local storage:", err);
    alert("Could not open file due to a storage error.");
  }
};


// Render a single note
function renderNote(docId, note) {
  const div = document.createElement("div");
  div.className = "note-box";

  // Check for locally saved files
  const filesHtml = note.files?.length ? `<h4 class="font-semibold text-gray-700">Files:</h4>
    <ul class="list-disc ml-6 mb-3 text-sm">
      ${note.files.map(f => {
        if (f.localFileId) {
          // Use onclick handler for locally stored files
          return `<li><a href="#" 
                     class="text-indigo-600 hover:text-indigo-800 underline transition" 
                     onclick="openLocalFile('${f.localFileId}'); return false;">${f.name}</a></li>`;
        }
        // Fallback for links stored as externalUrl (e.g., old format)
        return `<li><a class="text-indigo-600 hover:text-indigo-800 underline transition" href="${f.externalUrl}" target="_blank" rel="noopener noreferrer">${f.name}</a></li>`;
      }).join('')}
    </ul>` : '';

  // Ensure external links always open in new tab
  const linksHtml = note.links?.length ? `<h4 class="font-semibold text-gray-700">Links:</h4>
    <ul class="list-disc ml-6 mb-3 text-sm">
      ${note.links.map(l => `<li><a class="text-indigo-600 hover:text-indigo-800 underline transition" href="${l}" target="_blank" rel="noopener noreferrer">${l}</a></li>`).join('')}
    </ul>` : '';

  div.innerHTML = `
    <div class="flex justify-between items-center cursor-pointer collapsible">
      <h3 class="text-xl font-semibold">${note.title}</h3>
      <i class="fa-solid fa-chevron-down"></i>
    </div>
    <div class="content mt-3 collapsible-content hidden">
      <p class="mb-3 whitespace-pre-wrap">${note.text}</p>
      ${linksHtml}
      ${filesHtml}
      <div class="flex gap-2 mt-4">
        <button class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition" onclick="editNote('${docId}')">Edit</button>
        <button class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition" onclick="deleteNote('${docId}')">Delete</button>
      </div>
    </div>
  `;

  div.querySelector(".collapsible").addEventListener("click", () => {
    const content = div.querySelector(".content");
    const icon = div.querySelector(".collapsible i");
    content.classList.toggle("hidden");
    icon.classList.toggle('fa-chevron-up');
    icon.classList.toggle('fa-chevron-down');
  });

  return div;
}

// Placeholder for edit
window.editNote = (id) => alert("Edit functionality coming soon!");

// Delete note
window.deleteNote = async (id) => {
  if (!NOTES_REF) return;
  if (confirm("Delete this note?")) {
    // Implement IndexedDB file cleanup here if needed
    await deleteDoc(doc(NOTES_REF, id));
  }
};

// Save Note
saveNoteBtn.onclick = async () => {
  const title = document.getElementById("noteTitle").value.trim();
  const text = document.getElementById("noteText").value.trim();
  const linkString = document.getElementById("noteLinks").value.trim();
  const filesInput = document.getElementById("noteFiles");

  if (!title || !text) return alert("Please enter a title and note text.");
  if (!auth.currentUser || !NOTES_REF) return alert("Authentication error. Please sign in again.");

  saveNoteBtn.disabled = true;
  saveNoteBtn.textContent = 'Saving...';

  const filesToUpload = Array.from(filesInput.files);
  const uid = auth.currentUser.uid;

  // Process files: Save to IndexedDB and get local IDs
  const filePromises = filesToUpload.map(async (file) => {
    // Generate a unique ID for the file using UID and timestamp
    const fileId = `${uid}_${Date.now()}_${file.name.replace(/[^\w\.]/g, '_')}`;
    
    // Save the actual File object (blob) to IndexedDB
    await localforage.setItem(fileId, file);
    
    // Return only the metadata to be saved in Firestore
    return {
      name: file.name,
      localFileId: fileId 
    };
  });

  const files = await Promise.all(filePromises);
  const links = linkString ? linkString.split(",").map(l => l.trim()).filter(l => l) : [];

  // Save the note document with the local file IDs
  await addDoc(NOTES_REF, { title, text, files, links, timestamp: new Date().toISOString() });

  // Clear fields and reset UI
  document.getElementById("noteTitle").value = "";
  document.getElementById("noteText").value = "";
  document.getElementById("noteLinks").value = "";
  filesInput.value = "";

  saveNoteBtn.disabled = false;
  saveNoteBtn.textContent = "Save Note";
  newNoteContent.classList.add('hidden');
  toggleIcon.classList.replace('fa-chevron-up', 'fa-chevron-down');
};

// Auth + Load Notes: This must be the reliable entry point
onAuthStateChanged(auth, (user) => {
  if (!user) return window.location.href = "index.html";
  
  const uid = user.uid;
  // Initialize the NOTES_REF based on the authenticated user's ID
  NOTES_REF = collection(db, "users", uid, "daily_notes");

  // Start listening for notes updates
  onSnapshot(NOTES_REF, snapshot => {
    notesContainer.innerHTML = "";
    if (snapshot.empty) {
      notesContainer.innerHTML = `<p class="text-gray-500 italic text-center">No notes yet.</p>`;
    } else {
      snapshot.forEach(docSnap => notesContainer.appendChild(renderNote(docSnap.id, docSnap.data())));
    }
  }, (error) => {
    // Added error handling for data retrieval
    console.error("Error fetching notes:", error);
    notesContainer.innerHTML = `<p class="text-red-500 italic text-center">Error loading notes. Check console for details.</p>`;
  });
});
</script>
</body>
</html>
