<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes Dashboard</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        .collapsible {
            cursor: pointer;
            font-weight: 600;
        }
        .collapsible-content {
            display: none;
            padding-top: 10px;
        }
        .rotate {
            transform: rotate(90deg);
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- NAV BAR -->
<nav class="bg-blue-600 p-4 text-white flex justify-between">
    <div class="text-xl font-bold">Notes</div>
    <div>
        <a href="dashboard.html" class="px-3">Dashboard</a>
        <a href="topics.html" class="px-3">Topics</a>
        <a href="index.html" class="px-3">Home</a>
        <button id="logoutBtn" class="ml-4 underline">Logout</button>
    </div>
</nav>

<div class="max-w-4xl mx-auto p-4">

    <!-- Collapsible CREATE NOTE -->
    <div class="bg-white rounded shadow p-4 my-4">
        <div class="flex justify-between items-center collapsible" id="createNoteToggle">
            <h2 class="text-lg">➕ Create a New Note</h2>
            <span id="createNoteArrow">▶</span>
        </div>

        <div id="createNoteContent" class="collapsible-content">
            <div class="mt-4">
                <label class="font-semibold">Topic</label>
                <select id="topicSelect" class="border p-2 w-full rounded"></select>
            </div>

            <div class="mt-2">
                <label class="font-semibold">Note Title</label>
                <input id="noteTitle" class="border p-2 w-full rounded" />
            </div>

            <div class="mt-2">
                <label class="font-semibold">Details</label>
                <textarea id="noteDetails" class="border p-2 w-full rounded h-28"></textarea>
            </div>

            <!-- MULTIPLE LINKS -->
            <div class="mt-4">
                <label class="font-semibold">Links</label>
                <div id="linksContainer"></div>
                <button id="addLinkBtn" class="mt-1 bg-blue-600 text-white px-3 py-1 rounded">Add Link</button>
            </div>

            <!-- MULTIPLE FILES -->
            <div class="mt-4">
                <label class="font-semibold">Files</label>
                <input type="file" id="fileInput" multiple class="border p-2 w-full rounded">
            </div>

            <button id="saveNoteBtn"
                class="mt-4 bg-green-600 text-white px-4 py-2 rounded w-full">Save Note</button>
        </div>
    </div>

    <!-- TOPICS + NOTES -->
    <div id="topicsList"></div>

</div>

<script>
/* -------------------- FIREBASE CONFIG -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCEYmvhNMeI5GtkjBagq0XDhaa049yqKYU",
  authDomain: "hangman-b5477.firebaseapp.com",
  projectId: "hangman-b5477",
  storageBucket: "hangman-b5477.firebasestorage.app",
  messagingSenderId: "659695148674",
  appId: "1:659695148674:web:a538354378ed8dddec5e9b",
  measurementId: "G-9N6C60EHH0"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ------------ AUTH PROTECTION ------------ */
let uid = null;
let appId = "default";

auth.onAuthStateChanged(user => {
    if (!user) return window.location.href = "index.html";
    uid = user.uid;
    loadTopics();
});


/* -------------------- COLLAPSIBLE -------------------- */
document.getElementById("createNoteToggle").addEventListener("click", () => {
    const box = document.getElementById("createNoteContent");
    const arrow = document.getElementById("createNoteArrow");

    box.style.display = box.style.display === "block" ? "none" : "block";
    arrow.classList.toggle("rotate");
});


/* -------------------- ADD MULTIPLE LINKS -------------------- */
document.getElementById("addLinkBtn").addEventListener("click", () => {
    const container = document.getElementById("linksContainer");

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "https://example.com";
    input.className = "border p-2 w-full rounded mt-1 linkInput";

    container.appendChild(input);
});


/* -------------------- LOAD TOPICS -------------------- */
async function loadTopics() {
    const topicSelect = document.getElementById("topicSelect");
    const topicsList = document.getElementById("topicsList");

    topicSelect.innerHTML = "";
    topicsList.innerHTML = "";

    const snap = await db
        .collection("artifacts")
        .doc(appId)
        .collection("users").doc(uid)
        .collection("topics")
        .get();

    snap.forEach(doc => {
        let t = doc.data();

        // Add to select dropdown
        let opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = t.title;
        topicSelect.appendChild(opt);

        // Build collapsible topic section
        const topicBlock = document.createElement("div");
        topicBlock.className = "bg-white rounded shadow p-4 mt-4";

        topicBlock.innerHTML = `
            <div class="flex justify-between items-center collapsible topicToggle" data-id="${doc.id}">
                <h2 class="font-bold text-xl">${t.title}</h2>
                <span>▶</span>
            </div>
            <div class="collapsible-content" id="topic-${doc.id}">
                <div class="mt-2" id="notes-${doc.id}"></div>
            </div>
        `;

        topicsList.appendChild(topicBlock);

        loadNotes(doc.id);
    });

    makeTopicCollapsible();
}


/* -------------------- COLLAPSIBLE TOPICS -------------------- */
function makeTopicCollapsible() {
    document.querySelectorAll(".topicToggle").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const box = document.getElementById("topic-" + id);
            box.style.display = box.style.display === "block" ? "none" : "block";
        });
    });
}


/* -------------------- LOAD NOTES FOR A TOPIC -------------------- */
async function loadNotes(topicId) {
    const notesBox = document.getElementById("notes-" + topicId);
    notesBox.innerHTML = "";

    const snap = await db
        .collection("artifacts").doc(appId)
        .collection("users").doc(uid)
        .collection("topics").doc(topicId)
        .collection("notes")
        .get();

    snap.forEach(doc => {
        const n = doc.data();

        const noteDiv = document.createElement("div");
        noteDiv.className = "border p-3 rounded mt-2 bg-gray-50";

        let linksHTML = "";
        if (n.links) {
            n.links.forEach(l => linksHTML += `<a href="${l}" class="text-blue-600 underline block" target="_blank">${l}</a>`);
        }

        noteDiv.innerHTML = `
            <h3 class="font-semibold text-lg">${n.title}</h3>
            <p class="mt-1">${n.details}</p>
            <div class="mt-2">${linksHTML}</div>

            <button class="bg-yellow-500 text-white px-3 py-1 rounded mt-2 editNoteBtn" 
                    data-topic="${topicId}" data-id="${doc.id}">Edit</button>

            <button class="bg-red-600 text-white px-3 py-1 rounded mt-2 deleteNoteBtn"
                    data-topic="${topicId}" data-id="${doc.id}">Delete</button>
        `;

        notesBox.appendChild(noteDiv);
    });

    setupNoteActions();
}


/* -------------------- SAVE NEW NOTE -------------------- */
document.getElementById("saveNoteBtn").addEventListener("click", async () => {

    const topicId = document.getElementById("topicSelect").value;
    const title = document.getElementById("noteTitle").value.trim();
    const details = document.getElementById("noteDetails").value.trim();

    const links = [...document.querySelectorAll(".linkInput")].map(i => i.value.trim()).filter(v => v !== "");

    const fileInput = document.getElementById("fileInput");
    const fileNames = [...fileInput.files].map(f => f.name); // not uploading, just saving names

    if (!title) return alert("Enter a title");

    await db.collection("artifacts").doc(appId)
        .collection("users").doc(uid)
        .collection("topics").doc(topicId)
        .collection("notes")
        .add({
            title,
            details,
            links,
            files: fileNames,
            created: Date.now()
        });

    alert("Note saved!");

    loadNotes(topicId);
});

/* -------------------- DELETE -------------------- */
function setupNoteActions() {
    document.querySelectorAll(".deleteNoteBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const topicId = btn.dataset.topic;
            const id = btn.dataset.id;

            await db.collection("artifacts").doc(appId)
                .collection("users").doc(uid)
                .collection("topics").doc(topicId)
                .collection("notes").doc(id)
                .delete();

            loadNotes(topicId);
        });
    });
}


/* -------------------- LOGOUT -------------------- */
document.getElementById("logoutBtn").addEventListener("click", () => {
    auth.signOut().then(() => {
        window.location.href = "index.html";
    });
});
</script>

</body>
</html>