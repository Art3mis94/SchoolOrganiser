<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .sidebar { width: 300px; max-width: 100%; }
  .note-item { cursor: pointer; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
  .note-item:hover { background-color: #e0e7ff; }
  .selected { background-color: #c7d2fe; }
  .file-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
  .link-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
</style>
</head>
<body class="flex h-screen">

<!-- Sidebar -->
<div class="sidebar bg-white shadow-lg flex flex-col">
  <div class="p-4 font-bold text-lg border-b">Your Notes</div>
  <div id="notesList" class="flex-1 overflow-y-auto">
    <p class="text-gray-500 text-center mt-4">Loading notes...</p>
  </div>
  <div class="p-4 border-t">
    <button id="newNoteBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">+ New Note</button>
  </div>
</div>

<!-- Main Content / Preview Panel -->
<div class="flex-1 p-6 overflow-y-auto" id="notePreviewContainer">
  <p class="text-gray-500 text-center mt-4">Select a note to preview</p>
</div>

<!-- New Note Modal -->
<div id="newNoteModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-start pt-20 hidden">
  <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
    <h2 class="text-2xl font-bold mb-4">Create New Note</h2>
    <input id="noteTitleInput" type="text" placeholder="Title" class="w-full p-3 border rounded-lg mb-3">
    <textarea id="noteTextInput" rows="4" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3"></textarea>

    <label class="font-semibold mb-1">Add Files (max 20MB each):</label>
    <input id="noteFilesInput" type="file" multiple class="w-full p-2 border rounded-lg mb-3">

    <label class="font-semibold mb-1">Add Links:</label>
    <div class="flex gap-2 mb-2">
      <input id="noteLinkInput" type="text" placeholder="Enter URL" class="flex-1 p-2 border rounded-lg">
      <button id="addLinkBtn" class="bg-indigo-600 text-white px-4 rounded-lg hover:bg-indigo-700 transition">Add</button>
    </div>
    <div id="linkList" class="mb-3"></div>

    <div class="flex justify-end gap-2 mt-4">
      <button id="cancelNoteBtn" class="px-4 py-2 rounded-lg border hover:bg-gray-100">Cancel</button>
      <button id="saveNoteBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Save Note</button>
    </div>
  </div>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// ---------- CONFIG ----------
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB

// ---------- INIT ----------
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUserId = null;
let notesRef = null;
let notesCache = []; // Store notes locally
let selectedNoteId = null;

// ---------- DOM ----------
const notesList = document.getElementById("notesList");
const notePreviewContainer = document.getElementById("notePreviewContainer");
const newNoteModal = document.getElementById("newNoteModal");
const newNoteBtn = document.getElementById("newNoteBtn");
const cancelNoteBtn = document.getElementById("cancelNoteBtn");
const saveNoteBtn = document.getElementById("saveNoteBtn");

const noteTitleInput = document.getElementById("noteTitleInput");
const noteTextInput = document.getElementById("noteTextInput");
const noteFilesInput = document.getElementById("noteFilesInput");

const noteLinkInput = document.getElementById("noteLinkInput");
const addLinkBtn = document.getElementById("addLinkBtn");
const linkList = document.getElementById("linkList");

let tempLinks = [];

// ---------- AUTH ----------
onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "index.html";
  currentUserId = user.uid;
  notesRef = collection(db, "users", currentUserId, "daily_notes");

  // Migrate old notes automatically
  await migrateOldNotes();

  loadNotes();
});

// ---------- MIGRATE OLD NOTES ----------
async function migrateOldNotes() {
  const oldRef = collection(db, "artifacts", "OLD_APP_ID", "users", currentUserId, "daily_notes");
  const oldSnap = await onSnapshot(oldRef, async snapshot => {
    snapshot.forEach(async docSnap => {
      const exists = await getDoc(doc(notesRef, docSnap.id));
      if (!exists.exists()) {
        // Copy note to new collection
        await setDoc(doc(notesRef, docSnap.id), docSnap.data());
      }
    });
  });
}

// ---------- LOAD NOTES ----------
function loadNotes() {
  onSnapshot(notesRef, snapshot => {
    notesCache = [];
    notesList.innerHTML = "";
    if (snapshot.empty) notesList.innerHTML = `<p class="text-gray-500 text-center mt-4">No notes yet</p>`;
    snapshot.forEach(docSnap => {
      const note = { id: docSnap.id, ...docSnap.data() };
      notesCache.push(note);
      const div = document.createElement("div");
      div.className = "note-item";
      div.textContent = note.title;
      div.onclick = () => selectNote(note.id);
      notesList.appendChild(div);
    });
  });
}

// ---------- SELECT NOTE ----------
function selectNote(noteId) {
  selectedNoteId = noteId;
  const note = notesCache.find(n => n.id === noteId);
  if (!note) return;

  // Highlight selected
  [...notesList.children].forEach(child => child.classList.remove("selected"));
  const item = [...notesList.children].find(c => c.textContent === note.title);
  if (item) item.classList.add("selected");

  // Render preview
  notePreviewContainer.innerHTML = `
    <h2 class="text-2xl font-bold mb-4">${note.title}</h2>
    <p class="mb-3 whitespace-pre-wrap">${note.text}</p>
    ${note.links?.length ? `<h4 class="font-semibold">Links:</h4>
      <ul class="list-disc ml-6 mb-3">
        ${note.links.map(l => `<li><a href="${l}" target="_blank" rel="noopener noreferrer">${l}</a></li>`).join("")}
      </ul>` : ""}
    ${note.files?.length ? `<h4 class="font-semibold">Files:</h4>
      <ul class="list-disc ml-6 mb-3">
        ${note.files.map(f => `<li><a href="${f.url}" target="_blank" rel="noopener noreferrer">${f.name}</a></li>`).join("")}
      </ul>` : ""}
  `;
}

// ---------- NEW NOTE MODAL ----------
newNoteBtn.onclick = () => {
  tempLinks = [];
  linkList.innerHTML = "";
  noteTitleInput.value = "";
  noteTextInput.value = "";
  noteFilesInput.value = "";
  newNoteModal.classList.remove("hidden");
};

cancelNoteBtn.onclick = () => newNoteModal.classList.add("hidden");

addLinkBtn.onclick = () => {
  const val = noteLinkInput.value.trim();
  if (!val) return;
  const url = val.startsWith("http") ? val : `https://${val}`;
  tempLinks.push(url);
  renderLinkList();
  noteLinkInput.value = "";
};

function renderLinkList() {
  linkList.innerHTML = "";
  tempLinks.forEach((link, idx) => {
    const div = document.createElement("div");
    div.className = "link-item";
    div.innerHTML = `
      <span class="text-indigo-600 underline">${link}</span>
      <button class="text-red-500 font-bold">&times;</button>
    `;
    div.querySelector("button").onclick = () => {
      tempLinks.splice(idx, 1);
      renderLinkList();
    };
    linkList.appendChild(div);
  });
}

// ---------- SAVE NOTE ----------
saveNoteBtn.onclick = async () => {
  const title = noteTitleInput.value.trim();
  const text = noteTextInput.value.trim();
  const files = Array.from(noteFilesInput.files);

  if (!title || !text) return alert("Please enter title and text.");

  // Check file size
  for (const file of files) {
    if (file.size > MAX_FILE_SIZE) {
      return alert(`File ${file.name} exceeds 20MB limit.`);
    }
  }

  const noteId = doc(notesRef).id;
  let uploadedFiles = [];

  if (files.length > 0) {
    uploadedFiles = await Promise.all(files.map(async file => {
      const fileRef = ref(storage, `users/${currentUserId}/daily_notes/${noteId}/${file.name}`);
      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);
      return { name: file.name, url };
    }));
  }

  await setDoc(doc(notesRef, noteId), {
    title,
    text,
    links: tempLinks,
    files: uploadedFiles,
    createdAt: new Date()
  });

  newNoteModal.classList.add("hidden");
};

</script>
</body>
</html>