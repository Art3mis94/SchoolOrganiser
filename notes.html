<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
.note-box { @apply bg-white p-4 rounded-xl shadow-md border border-gray-200 flex justify-between items-center; cursor: pointer; }
.note-box:hover { @apply bg-indigo-50; }
.nav-active { @apply bg-white text-indigo-700 shadow-inner; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="curriculum_topics.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="signout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-6xl mx-auto p-6 mt-8 flex gap-6">

  <!-- Notes Sidebar -->
  <div class="w-1/3 space-y-4">
    <button id="addNoteBtn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition">Add New Note</button>
    <div id="notesList" class="space-y-3"></div>
  </div>

  <!-- Note Editor -->
  <div class="w-2/3 bg-white p-6 rounded-3xl shadow-2xl hidden" id="noteEditorContainer">
    <h2 class="text-2xl font-bold mb-4" id="editorTitle">New Note</h2>
    <input id="noteTitle" type="text" placeholder="Note Title..." class="w-full p-3 border rounded-lg mb-3">
    <textarea id="noteText" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3" rows="6"></textarea>

    <div class="mb-3">
      <h3 class="font-semibold mb-1">Links</h3>
      <div class="flex gap-2 mb-2">
        <input id="linkInput" type="text" placeholder="Enter link..." class="flex-1 p-2 border rounded-lg">
        <button id="addLinkBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add</button>
      </div>
      <ul id="linksList" class="list-disc ml-6 text-sm"></ul>
    </div>

    <div class="mb-3">
      <h3 class="font-semibold mb-1">Files (Max 20MB each)</h3>
      <input id="noteFiles" type="file" multiple class="w-full p-2 bg-white border rounded-lg mb-2">
      <ul id="filesList" class="list-disc ml-6 text-sm"></ul>
    </div>

    <div class="flex gap-3 mt-4">
      <button id="saveNoteBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700">Save Note</button>
      <button id="deleteNoteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700">Delete Note</button>
      <button id="cancelEditBtn" class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let editingNoteId = null;
const MAX_FILE_SIZE = 20 * 1024 * 1024;

const notesList = document.getElementById("notesList");
const addNoteBtn = document.getElementById("addNoteBtn");
const noteEditorContainer = document.getElementById("noteEditorContainer");
const noteTitle = document.getElementById("noteTitle");
const noteText = document.getElementById("noteText");
const linkInput = document.getElementById("linkInput");
const addLinkBtn = document.getElementById("addLinkBtn");
const linksList = document.getElementById("linksList");
const noteFiles = document.getElementById("noteFiles");
const filesList = document.getElementById("filesList");
const saveNoteBtn = document.getElementById("saveNoteBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const deleteNoteBtn = document.getElementById("deleteNoteBtn");
const signoutBtn = document.getElementById("signout-btn");

let currentLinks = [];
let currentFiles = [];

// ===== Auth =====
onAuthStateChanged(auth, user => {
  if (!user) return window.location.href="index.html";
  currentUser = user;
  listenNotes();
});

signoutBtn.onclick = () => signOut(auth);

// ===== Notes Collection =====
function notesRef() {
  return collection(db, "users", currentUser.uid, "daily_notes");
}

// ===== Listen Notes =====
function listenNotes() {
  onSnapshot(notesRef(), snapshot => {
    notesList.innerHTML = "";
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const noteDiv = document.createElement("div");
      noteDiv.className = "note-box";
      noteDiv.innerHTML = `<span>${data.title}</span> <i class="fas fa-edit text-gray-500"></i>`;
      noteDiv.onclick = () => openNote(docSnap.id, data);
      notesList.appendChild(noteDiv);
    });
  });
}

// ===== Open Note =====
function openNote(id, data) {
  editingNoteId = id;
  noteEditorContainer.classList.remove("hidden");
  noteTitle.value = data.title;
  noteText.value = data.text;
  currentLinks = data.links || [];
  currentFiles = data.files || [];
  renderLinks();
  renderFiles();
}

// ===== Render Links & Files =====
function renderLinks() {
  linksList.innerHTML = "";
  currentLinks.forEach((l,i)=>{
    const li=document.createElement("li");
    li.innerHTML=`<a href="${l}" target="_blank">${l}</a> <span class="text-red-600 cursor-pointer" onclick="removeLink(${i})">[x]</span>`;
    linksList.appendChild(li);
  });
}
window.removeLink=(i)=>{ currentLinks.splice(i,1); renderLinks(); }

function renderFiles() {
  filesList.innerHTML = "";
  currentFiles.forEach((f,i)=>{
    const li=document.createElement("li");
    li.innerHTML=`<a href="${f.url}" target="_blank">${f.name}</a> <span class="text-red-600 cursor-pointer" onclick="removeFile(${i})">[x]</span>`;
    filesList.appendChild(li);
  });
}
window.removeFile=(i)=>{ currentFiles.splice(i,1); renderFiles(); }

// ===== Add Link =====
addLinkBtn.onclick = ()=>{
  const val=linkInput.value.trim();
  if(!val) return;
  const url=val.startsWith("http")?val:"https://"+val;
  currentLinks.push(url);
  renderLinks();
  linkInput.value="";
}

// ===== Add New Note =====
addNoteBtn.onclick = ()=>{
  editingNoteId=null;
  noteEditorContainer.classList.remove("hidden");
  noteTitle.value="";
  noteText.value="";
  currentLinks=[];
  currentFiles=[];
  renderLinks();
  renderFiles();
}

// ===== Cancel =====
cancelEditBtn.onclick = ()=>{
  noteEditorContainer.classList.add("hidden");
  editingNoteId=null;
}

// ===== Save Note =====
saveNoteBtn.onclick=async()=>{
  if(!noteTitle.value.trim()||!noteText.value.trim()) return alert("Title & text required");
  saveNoteBtn.disabled=true;

  const filesArray=Array.from(noteFiles.files);
  const uploadedFiles=[];
  for(const file of filesArray){
    if(file.size>MAX_FILE_SIZE){
      alert(`${file.name} exceeds 20MB`);
      saveNoteBtn.disabled=false;
      return;
    }
    const noteIdTemp = editingNoteId || doc(notesRef()).id;
    const fileRef = ref(storage, `users/${currentUser.uid}/daily_notes/${noteIdTemp}/${file.name}`);
    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);
    uploadedFiles.push({name:file.name,url});
  }

  const noteData={
    title: noteTitle.value.trim(),
    text: noteText.value.trim(),
    links: currentLinks,
    files:[...currentFiles,...uploadedFiles],
    updatedAt:new Date()
  };

  if(editingNoteId){
    const noteDoc=doc(notesRef(),editingNoteId);
    await updateDoc(noteDoc,noteData);
  } else {
    await addDoc(notesRef(),noteData);
  }

  noteEditorContainer.classList.add("hidden");
  saveNoteBtn.disabled=false;
  noteTitle.value="";
  noteText.value="";
  noteFiles.value="";
  currentLinks=[];
  currentFiles=[];
  renderLinks();
  renderFiles();
}

// ===== Delete Note =====
deleteNoteBtn.onclick=async()=>{
  if(!editingNoteId) return;
  if(!confirm("Delete this note and all attached files?")) return;
  const noteDocRef = doc(notesRef(), editingNoteId);
  const docSnap = await getDoc(noteDocRef);
  if(docSnap.exists()){
    const data = docSnap.data();
    for(const f of data.files||[]){
      const fileRef = ref(storage, `users/${currentUser.uid}/daily_notes/${editingNoteId}/${f.name}`);
      await deleteObject(fileRef).catch(()=>{});
    }
    await deleteDoc(noteDocRef);
    noteEditorContainer.classList.add("hidden");
    editingNoteId=null;
  }
}

</script>
</body>
</html>