<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
  .note-box { @apply bg-white p-5 rounded-xl shadow-md border border-gray-200; }
  /* Ensure content shows transition for smoother toggle */
  .collapsible-content { transition: max-height 0.3s ease-out; overflow: hidden; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="curriculum_topics.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="signout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-4xl mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-8">
  <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Daily Notes üìù</h1>
  
  <!-- Loading Indicator -->
  <div id="loadingIndicator" class="hidden text-center p-4 bg-yellow-100 text-yellow-800 rounded-lg mb-4 font-semibold">
    <i class="fas fa-spinner fa-spin mr-2"></i> Uploading files and saving note...
  </div>

  <!-- Add Note (Collapsible) -->
  <div class="bg-indigo-50 p-5 rounded-xl mb-6">
    <div id="newNoteHeader" class="flex justify-between items-center cursor-pointer text-indigo-800 hover:text-indigo-900 transition">
      <h2 class="text-xl font-bold">Create a New Note</h2>
      <i id="toggleIcon" class="fa-solid fa-chevron-down"></i>
    </div>
    <div id="newNoteContent" class="collapsible-content mt-4 hidden">
      <input id="noteTitle" type="text" placeholder="Note Title..." class="w-full p-3 border rounded-lg mb-3">
      <textarea id="noteText" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3" rows="4"></textarea>

      <!-- File input with 15MB limit note -->
      <label class="font-semibold block mb-1 text-gray-700">Attach Files (Max 15MB each):</label>
      <input id="noteFiles" type="file" multiple class="w-full p-2 bg-white border rounded-lg mb-4">

      <label class="font-semibold block mb-1 text-gray-700">Add Links (optional):</label>
      <input id="noteLinks" type="text" placeholder="Comma-separated URLs (e.g. https://google.com)..." class="w-full p-3 border rounded-lg mb-4">

      <button id="saveNoteBtn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">
        Save Note
      </button>
    </div>
  </div>

  <!-- Notes List -->
  <div id="notesContainer" class="space-y-4">
    <p class="text-gray-500 italic text-center">Loading notes...</p>
  </div>
</div>

<script type="module">
// --- Firebase CDNs ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, onSnapshot, updateDoc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// --- Configuration and Constants ---
// 15 MB in bytes
const MAX_FILE_SIZE_BYTES = 15728640; 
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Safely parse the Firebase config string from the environment
let firebaseConfig = {};
try {
    const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    firebaseConfig = JSON.parse(configString);
} catch (e) {
    console.error("Error parsing __firebase_config:", e);
    // firebaseConfig remains an empty object
}

let auth, db, storage, NOTES_REF, currentUserId;

// --- DOM Elements ---
const notesContainer = document.getElementById("notesContainer");
const saveNoteBtn = document.getElementById("saveNoteBtn");
const loadingIndicator = document.getElementById("loadingIndicator");
const newNoteContent = document.getElementById("newNoteContent");
const toggleIcon = document.getElementById("toggleIcon");
const newNoteHeader = document.getElementById("newNoteHeader");


// --- Initialization and Authentication ---
async function initializeAndAuthenticate() {
  // Check if the configuration object is populated
  if (Object.keys(firebaseConfig).length === 0) {
    console.error("Firebase configuration object is empty. Check environment variables.");
    notesContainer.innerHTML = '<p class="text-red-600 text-center">Firebase configuration not loaded. Cannot load notes.</p>';
    return;
  }

  // Initialize Firebase services
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  storage = getStorage(app);

  try {
      // Authenticate using custom token or anonymously
      if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
      } else {
          await signInAnonymously(auth);
      }
  } catch(error) {
      console.error("Firebase Auth Error:", error);
  }

  // Set up authentication state listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUserId = user.uid;
      // Set the path to the user's private notes collection
      NOTES_REF = collection(db, "artifacts", appId, "users", currentUserId, "daily_notes");
      startNotesListener();
    } else {
      console.log("User signed out or failed to sign in.");
      currentUserId = null;
      notesContainer.innerHTML = '<p class="text-gray-500 italic text-center">Please sign in to view notes.</p>';
    }
  });
}

// --- Real-time Notes Listener ---
function startNotesListener() {
  if (!NOTES_REF) return;
  
  onSnapshot(NOTES_REF, snapshot => {
    notesContainer.innerHTML = "";
    if (snapshot.empty) {
      notesContainer.innerHTML = `<p class="text-gray-500 italic text-center">No notes yet. Start by creating one above!</p>`;
    }
    snapshot.forEach(docSnap => {
      notesContainer.appendChild(renderNote(docSnap.id, docSnap.data()));
    });
  }, error => {
      console.error("Firestore Snapshot Error:", error);
      notesContainer.innerHTML = `<p class="text-red-600 text-center">Error loading notes. Check console for details.</p>`;
  });
}

// --- File Management ---
/**
 * Uploads a file to Firebase Storage under the user's note path.
 * @returns {Promise<{name: string, url: string}>} Object containing the file name and its permanent download URL.
 */
async function uploadFile(file, noteId) {
    // Define the storage path: users/{userId}/daily_notes/{noteId}/{fileName}
    const fileRef = ref(storage, `users/${currentUserId}/daily_notes/${noteId}/${file.name}`);
    
    await uploadBytes(fileRef, file);
    
    // Get the permanent download URL
    const downloadURL = await getDownloadURL(fileRef);
    
    return { name: file.name, url: downloadURL };
}

/**
 * Deletes a file from Firebase Storage.
 */
async function deleteFileFromStorage(fileName, noteId) {
    try {
        const fileRef = ref(storage, `users/${currentUserId}/daily_notes/${noteId}/${fileName}`);
        await deleteObject(fileRef);
        console.log(`Successfully deleted file: ${fileName}`);
    } catch (error) {
        // If the file is already deleted (e.g., storage/object-not-found), ignore the error.
        console.warn(`Warning: Could not delete file ${fileName}.`, error.code);
    }
}


// --- DOM Interactions and Logic ---

// Render a single note element
function renderNote(docId, note) {
  const div = document.createElement("div");
  div.className = "note-box";
  const files = note.files || []; 

  div.innerHTML = `
    <div class="flex justify-between items-center cursor-pointer collapsible">
      <h3 class="text-xl font-semibold">${note.title}</h3>
      <i class="fa-solid fa-chevron-down"></i>
    </div>
    <div class="content mt-3 collapsible-content hidden">
      <p class="mb-3 whitespace-pre-wrap">${note.text}</p>
      
      <!-- Permanent Links Section -->
      ${note.links?.length ? `<h4 class="font-semibold text-gray-700">Links:</h4>
        <ul class="list-disc ml-6 mb-3 text-sm">
          ${note.links.map(l => {
              // Ensure link is treated as external
              const url = l.startsWith('http') ? l : `https://${l}`;
              return `<li><a class="text-indigo-600 hover:text-indigo-800 underline transition" href="${url}" target="_blank" rel="noopener noreferrer">${l}</a></li>`;
          }).join('')}
        </ul>` : ''}

      <!-- Files Section (uses permanent URLs from Storage) -->
      ${files.length ? `<h4 class="font-semibold text-gray-700">Files (Permanent Links):</h4>
        <ul class="list-disc ml-6 mb-3 text-sm">
          ${files.map(f => `<li><a class="text-indigo-600 hover:text-indigo-800 underline transition" href="${f.url}" target="_blank" rel="noopener noreferrer">${f.name}</a></li>`).join('')}
        </ul>` : ''}

      <div class="flex gap-2 mt-4">
        <button class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition" onclick="editNote('${docId}')">Edit</button>
        <button class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition" onclick="deleteNote('${docId}')">Delete</button>
      </div>
    </div>
  `;

  // collapsible toggle
  div.querySelector(".collapsible").addEventListener("click", () => {
    const content = div.querySelector(".content");
    const icon = div.querySelector(".collapsible i");
    content.classList.toggle("hidden");
    icon.classList.toggle('fa-chevron-up');
    icon.classList.toggle('fa-chevron-down');
  });

  return div;
}

// Expose functions to global scope for use in inline HTML click handlers
window.editNote = async (id) => {
  if (!currentUserId) return;
  const docRef = doc(db, "artifacts", appId, "users", currentUserId, "daily_notes", id);
  const docSnap = await getDoc(docRef);
  if (!docSnap.exists()) return;

  const newTitle = prompt("Edit Note Title:", docSnap.data().title);
  const newText = prompt("Edit Note Text:", docSnap.data().text);
  if (newTitle !== null && newText !== null) {
    await updateDoc(docRef, { title: newTitle, text: newText });
  }
}

window.deleteNote = async (id) => {
  if (!currentUserId) return;
  
  if (!window.confirm("Are you sure you want to delete this note and all attached files from Storage?")) return;
  
  const noteRef = doc(db, "artifacts", appId, "users", currentUserId, "daily_notes", id);
  
  try {
      const docSnap = await getDoc(noteRef);
      const noteData = docSnap.data();
      const filesToDelete = noteData?.files || [];
      
      // Delete all associated files from Storage
      const deletePromises = filesToDelete.map(f => deleteFileFromStorage(f.name, id));
      await Promise.all(deletePromises);

      // Delete the note from Firestore
      await deleteDoc(noteRef);
  } catch (error) {
      console.error("Error deleting note or associated files:", error);
      alert("An error occurred during deletion. Please check the console.");
  }
}


// Save Note (Main logic with 15MB size validation)
saveNoteBtn.onclick = async () => {
  if (!currentUserId || !NOTES_REF) return alert("User not authenticated.");

  const title = document.getElementById("noteTitle").value.trim();
  const text = document.getElementById("noteText").value.trim();
  const linkString = document.getElementById("noteLinks").value.trim();
  const filesInput = document.getElementById("noteFiles");
  const files = Array.from(filesInput.files);
  
  // --- 15MB Client-Side Size Check ---
  let fileTooLarge = false;
  for (const file of files) {
      if (file.size > MAX_FILE_SIZE_BYTES) {
          fileTooLarge = true;
          alert(`The file "${file.name}" is too large. Maximum size allowed is 15MB.`);
          break; 
      }
  }

  if (fileTooLarge) {
      return; // Stop if any file fails the size check
  }
  // -----------------------------------

  if (!title || !text) return alert("Please enter title and text.");

  saveNoteBtn.disabled = true;
  saveNoteBtn.textContent = 'Processing...';
  loadingIndicator.classList.remove('hidden');

  try {
    // 1. Get a unique ID before saving, to use in the file path
    const tempDocRef = doc(NOTES_REF);
    const noteId = tempDocRef.id;

    // 2. Upload all files to Storage
    const fileUploadPromises = files.map(file => uploadFile(file, noteId));
    const uploadedFileObjects = await Promise.all(fileUploadPromises); 
    
    // 3. Prepare external links (ensuring https:// protocol)
    const links = linkString 
        ? linkString.split(",").map(l => {
            const trimmed = l.trim();
            if (trimmed && !/^https?:\/\//i.test(trimmed)) {
                return `https://${trimmed}`;
            }
            return trimmed;
          }).filter(l => l)
        : [];

    // 4. Save the final note data (including permanent file URLs)
    await setDoc(tempDocRef, {
      title,
      text,
      links,
      files: uploadedFileObjects, // Permanent {name, url} objects
      createdAt: new Date(),
    });

    // Reset form and UI
    document.getElementById("noteTitle").value = "";
    document.getElementById("noteText").value = "";
    document.getElementById("noteFiles").value = "";
    document.getElementById("noteLinks").value = "";
    
    newNoteContent.classList.add('hidden');
    toggleIcon.classList.replace('fa-chevron-up', 'fa-chevron-down');

  } catch (error) {
    console.error("Error saving note or uploading files:", error);
    alert(`An error occurred while saving: ${error.message}`);
  } finally {
    saveNoteBtn.disabled = false;
    saveNoteBtn.textContent = "Save Note";
    loadingIndicator.classList.add('hidden');
  }
};

// --- Initial Setup ---
newNoteHeader.addEventListener('click', () => {
  newNoteContent.classList.toggle('hidden');
  toggleIcon.classList.toggle('fa-chevron-up');
  toggleIcon.classList.toggle('fa-chevron-down');
});

document.getElementById("signout-btn").onclick = () => signOut(auth);

// Start the application
initializeAndAuthenticate();

</script>
</body>
</html>

