<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
  .note-box { @apply bg-white p-5 rounded-xl shadow-md border border-gray-200; }
  .collapsible-content { transition: max-height 0.3s ease-out; overflow: hidden; }
  .link-item { display:flex; align-items:center; margin-bottom:0.25rem; gap:0.5rem; }
  /* Custom scrollbar for notes list */
  #notesList { max-height: 80vh; overflow-y: auto; }
  #notesList::-webkit-scrollbar { width: 6px; }
  #notesList::-webkit-scrollbar-thumb { background-color: #a5b4fc; border-radius: 3px; }
  #notesList::-webkit-scrollbar-track { background-color: #e0e7ff; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-5xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="curriculum_topics.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="signout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-5xl mx-auto p-6 mt-8 flex gap-6">

  <!-- Left Sidebar: Notes List -->
  <div class="w-1/3 space-y-4" id="notesList">
    <p class="text-gray-500 text-center">Loading notes...</p>
  </div>

  <!-- Right Sidebar: New Note -->
  <div class="w-2/3 bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold text-gray-800 mb-4">Create a New Note üìù</h1>
    <input id="noteTitle" type="text" placeholder="Note Title..." class="w-full p-3 border rounded-lg mb-3">
    <textarea id="noteText" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3" rows="5"></textarea>

    <!-- File Attachments -->
    <label class="font-semibold block mb-1 text-gray-700">Attach Files (Max 20MB each):</label>
    <input id="noteFiles" type="file" multiple class="w-full p-2 bg-white border rounded-lg mb-3">

    <!-- Links -->
    <label class="font-semibold block mb-1 text-gray-700">Add Links:</label>
    <div class="flex gap-2 mb-3">
      <input id="linkInput" type="text" placeholder="Paste link..." class="flex-1 p-2 border rounded-lg">
      <button id="addLinkBtn" class="bg-indigo-600 text-white px-3 rounded-lg hover:bg-indigo-700 transition">Add Link</button>
    </div>
    <div id="linksContainer" class="mb-3"></div>

    <button id="saveNoteBtn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">
      Save Note
    </button>
    <div id="loadingIndicator" class="hidden text-center p-2 mt-2 bg-yellow-100 text-yellow-800 rounded-lg font-semibold">
      <i class="fas fa-spinner fa-spin mr-2"></i> Saving...
    </div>
  </div>

</div>

<script type="module">
// --- Firebase CDNs ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// --- Configuration and Constants (MANDATORY ENVIRONMENT VARS) ---
const MAX_FILE_SIZE_BYTES = 20971520; // 20 MB (20 * 1024 * 1024)

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let firebaseConfig = {};
try {
    const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    firebaseConfig = JSON.parse(configString);
} catch (e) {
    console.error("Error parsing __firebase_config:", e);
}

let app, auth, db, storage, currentUserId, notesRef;

// --- DOM Elements ---
const notesList = document.getElementById("notesList");
const saveNoteBtn = document.getElementById("saveNoteBtn");
const loadingIndicator = document.getElementById("loadingIndicator");
const noteTitle = document.getElementById("noteTitle");
const noteText = document.getElementById("noteText");
const noteFiles = document.getElementById("noteFiles");
const linkInput = document.getElementById("linkInput");
const addLinkBtn = document.getElementById("addLinkBtn");
const linksContainer = document.getElementById("linksContainer");

let linksArray = [];

// --- Initialization and Authentication ---
async function initializeAndAuthenticate() {
  if (Object.keys(firebaseConfig).length === 0) {
    notesList.innerHTML = '<p class="text-red-600 text-center font-bold">Error: Firebase config missing. Please refresh the page.</p>';
    return;
  }
  
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  storage = getStorage(app);
  
  // Set up authentication using the provided token or anonymously
  try {
      if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
      } else {
          await signInAnonymously(auth);
      }
  } catch(error) {
      console.error("Firebase Auth Error:", error);
  }

  // Auth State Listener
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUserId = user.uid;
      // Define the collection path using the required /artifacts/{appId}/users/{userId}/... structure
      notesRef = collection(db, "artifacts", appId, "users", currentUserId, "daily_notes");
      loadNotes();
    } else {
      currentUserId = null;
      notesList.innerHTML = '<p class="text-red-500 text-center">Please log in to view notes.</p>';
    }
  });
}

// --- Sign Out ---
document.getElementById("signout-btn").onclick = () => signOut(auth);

// --- Add Link ---
addLinkBtn.onclick = () => {
  const url = linkInput.value.trim();
  if (!url) return;
  
  // Prepend protocol if missing
  const fullUrl = url.startsWith('http') ? url : `https://${url}`;

  linksArray.push(fullUrl);
  
  const div = document.createElement("div");
  div.className = "link-item text-sm";
  div.innerHTML = `<a href="${fullUrl}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 underline truncate flex-1">${url}</a>
                   <button class="text-red-600 font-bold hover:text-red-800 transition">x</button>`;
  
  div.querySelector("button").onclick = () => {
    // Remove link by matching the full URL
    linksArray = linksArray.filter(l => l !== fullUrl);
    linksContainer.removeChild(div);
  };
  linksContainer.appendChild(div);
  linkInput.value = "";
};

// --- Helper: Render Note ---
function renderNote(docId, note) {
  const div = document.createElement("div");
  div.className = "note-box";
  const files = note.files || [];
  const links = note.links || [];

  div.innerHTML = `
    <div class="flex justify-between items-center cursor-pointer collapsible">
      <h3 class="font-semibold text-gray-800">${note.title}</h3>
      <i class="fa-solid fa-chevron-down text-indigo-500"></i>
    </div>
    <div class="collapsible-content mt-2 hidden text-sm">
      <p class="mb-2 whitespace-pre-wrap text-gray-600">${note.text}</p>
      
      ${links.length ? `<h4 class="font-semibold mt-2 text-gray-700">Links:</h4>
      <ul class="list-disc ml-5">${links.map(l=>`<li><a href="${l}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline transition truncate block">${l.replace(/^https?:\/\//, '')}</a></li>`).join('')}</ul>` : ''}
      
      ${files.length ? `<h4 class="font-semibold mt-2 text-gray-700">Files:</h4>
      <ul class="list-disc ml-5">${files.map(f=>`<li><a href="${f.url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline transition truncate block">${f.name}</a></li>`).join('')}</ul>` : ''}
      
      <div class="flex gap-2 mt-3">
        <button class="bg-yellow-500 text-white px-3 py-1 rounded-lg font-semibold hover:bg-yellow-600 transition" onclick="editNote('${docId}')">Edit</button>
        <button class="bg-red-600 text-white px-3 py-1 rounded-lg font-semibold hover:bg-red-700 transition" onclick="deleteNote('${docId}')">Delete</button>
      </div>
    </div>
  `;
  const header = div.querySelector(".collapsible");
  const content = div.querySelector(".collapsible-content");
  const icon = header.querySelector("i");
  header.onclick = () => {
    content.classList.toggle("hidden");
    icon.classList.toggle("fa-chevron-down");
    icon.classList.toggle("fa-chevron-up");
  };
  return div;
}

// --- Load Notes ---
function loadNotes() {
  if (!notesRef) return;
  onSnapshot(notesRef, snapshot => {
    notesList.innerHTML = "";
    if (snapshot.empty) {
      notesList.innerHTML = '<p class="text-gray-500 text-center">No notes yet.</p>';
      return;
    }
    snapshot.forEach(docSnap => {
      notesList.appendChild(renderNote(docSnap.id, docSnap.data()));
    });
  }, error => {
      console.error("Error loading notes via onSnapshot:", error);
      notesList.innerHTML = '<p class="text-red-600 text-center">Failed to load notes. Check permissions.</p>';
  });
}

// --- File Upload ---
async function uploadFiles(noteId, files) {
  const uploaded = [];
  for (const file of files) {
    // Path: users/{userId}/daily_notes/{noteId}/{fileName}
    const storageRef = ref(storage, `users/${currentUserId}/daily_notes/${noteId}/${file.name}`);
    
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    uploaded.push({ name: file.name, url });
  }
  return uploaded;
}

// --- Save Note ---
saveNoteBtn.onclick = async () => {
  if (!noteTitle.value.trim() || !noteText.value.trim()) return alert("Title and text required.");
  if (!currentUserId) return alert("User is not authenticated.");

  saveNoteBtn.disabled = true;
  loadingIndicator.classList.remove("hidden");
  
  const files = Array.from(noteFiles.files);

  // --- 20MB Client-Side Size Check ---
  let fileTooLarge = false;
  for (const file of files) {
      if (file.size > MAX_FILE_SIZE_BYTES) {
          fileTooLarge = true;
          alert(`The file "${file.name}" is too large. Maximum size allowed is 20MB.`);
          break; 
      }
  }

  if (fileTooLarge) {
      saveNoteBtn.disabled = false;
      loadingIndicator.classList.add("hidden");
      return; 
  }
  // -----------------------------------
  
  const docRef = doc(notesRef); // Create a reference to a new document
  let uploadedFiles = [];
  
  try {
    // 1. Upload files first to get permanent URLs
    if (files.length) {
      uploadedFiles = await uploadFiles(docRef.id, files);
    }
    
    // 2. Save note metadata and permanent links to Firestore
    await setDoc(docRef, {
      title: noteTitle.value.trim(),
      text: noteText.value.trim(),
      links: linksArray,
      files: uploadedFiles,
      createdAt: new Date()
    });
    
    // Reset form
    noteTitle.value = "";
    noteText.value = "";
    noteFiles.value = "";
    linksArray = [];
    linksContainer.innerHTML = "";
    
  } catch(e) {
    console.error("Error saving note or uploading files:", e);
    alert("Error saving note. Check console for details.");
  } finally {
    saveNoteBtn.disabled = false;
    loadingIndicator.classList.add("hidden");
  }
};

// --- Edit & Delete (Exposed to Window Scope) ---
window.editNote = async (id) => {
  if (!notesRef) return;
  const docRef = doc(notesRef, id);
  const snap = await getDoc(docRef);
  if (!snap.exists()) return;
  const data = snap.data();
  
  // Note: Using prompt for simplicity; in a real app, use a modal.
  const newTitle = prompt("Edit Title:", data.title);
  const newText = prompt("Edit Text:", data.text);
  if (newTitle !== null && newText !== null) {
    await updateDoc(docRef, { title: newTitle, text: newText });
  }
};

window.deleteNote = async (id) => {
  if (!notesRef) return;
  // Note: Using confirm for simplicity; in a real app, use a modal.
  if (!window.confirm("Delete this note and all attached files?")) return;
  
  const docRef = doc(notesRef, id);
  
  try {
    const snap = await getDoc(docRef);
    if (!snap.exists()) return;
    const data = snap.data();
    
    // 1. Delete files from Storage
    if (data.files) {
      const deletePromises = data.files.map(f => {
        // Path: users/{userId}/daily_notes/{noteId}/{fileName}
        const fileRef = ref(storage, `users/${currentUserId}/daily_notes/${id}/${f.name}`);
        return deleteObject(fileRef).catch(e => console.warn("Failed to delete storage file:", e.code));
      });
      await Promise.all(deletePromises);
    }
    
    // 2. Delete the document from Firestore
    await deleteDoc(docRef);
    
  } catch(e) {
    console.error("Error deleting note:", e);
    alert("Error deleting note. Check console.");
  }
};

// Start the application
initializeAndAuthenticate();
</script>
</body>
</html>

