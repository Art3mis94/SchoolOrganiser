<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
  .note-box { @apply bg-white p-4 rounded-xl shadow-md border border-gray-200; cursor:pointer; }
  .sidebar { width: 300px; max-width: 100%; overflow-y:auto; }
  .content-area { flex:1; padding:1rem; }
  .link-item { display:flex; gap:0.5rem; margin-bottom:0.5rem; }
  .link-item button { flex-shrink:0; }
  .hidden { display:none; }
</style>
</head>
<body class="flex h-screen">

<!-- Sidebar -->
<div class="sidebar bg-indigo-50 p-4">
  <h2 class="text-xl font-bold mb-4">Notes üìù</h2>
  <div id="notesList" class="space-y-2 overflow-y-auto max-h-[calc(100vh-100px)]"></div>
  <button id="newNoteBtn" class="mt-4 w-full bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700">+ New Note</button>
</div>

<!-- Content Area -->
<div class="content-area bg-white rounded-l-3xl shadow-xl flex flex-col">
  <div id="noteEditor" class="p-4 hidden flex flex-col gap-2">
    <input id="noteTitle" placeholder="Title" class="p-2 border rounded-lg w-full" />
    <textarea id="noteText" placeholder="Write your note..." class="p-2 border rounded-lg w-full h-32"></textarea>

    <div>
      <label class="font-semibold">Links:</label>
      <div id="linksContainer" class="mb-2"></div>
      <input id="linkInput" placeholder="Enter link" class="p-2 border rounded-lg w-full" />
      <button id="addLinkBtn" class="mt-1 bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600">Add Link</button>
    </div>

    <div>
      <label class="font-semibold">Attach Files (Max 20MB each)</label>
      <input type="file" id="fileInput" multiple class="w-full mt-1" />
      <div id="fileList" class="mt-2"></div>
    </div>

    <div class="flex gap-2 mt-2">
      <button id="saveNoteBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Save</button>
      <button id="cancelNoteBtn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">Cancel</button>
    </div>

    <div id="uploadStatus" class="mt-2 text-sm text-gray-700"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// --- CONFIG ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- DOM ---
const notesList = document.getElementById('notesList');
const newNoteBtn = document.getElementById('newNoteBtn');
const noteEditor = document.getElementById('noteEditor');
const noteTitle = document.getElementById('noteTitle');
const noteText = document.getElementById('noteText');
const saveNoteBtn = document.getElementById('saveNoteBtn');
const cancelNoteBtn = document.getElementById('cancelNoteBtn');
const linkInput = document.getElementById('linkInput');
const addLinkBtn = document.getElementById('addLinkBtn');
const linksContainer = document.getElementById('linksContainer');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const uploadStatus = document.getElementById('uploadStatus');

let currentUserId = null;
let editingNoteId = null;
let linksArray = [];
let filesArray = [];
let uploadTasks = [];

// --- Helpers ---
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB

function renderLinks() {
  linksContainer.innerHTML = '';
  linksArray.forEach((link, idx)=>{
    const div = document.createElement('div');
    div.className='link-item';
    div.innerHTML=`<a href="${link}" target="_blank" class="text-indigo-600 underline">${link}</a>
                   <button data-idx="${idx}" class="bg-red-500 text-white px-1 rounded">X</button>`;
    div.querySelector('button').onclick = ()=>{ linksArray.splice(idx,1); renderLinks(); };
    linksContainer.appendChild(div);
  });
}

function renderFiles() {
  fileList.innerHTML='';
  filesArray.forEach((f,idx)=>{
    const div = document.createElement('div');
    div.textContent = f.name;
    const btn = document.createElement('button');
    btn.textContent='Remove';
    btn.className='ml-2 text-sm bg-red-500 text-white px-1 rounded';
    btn.onclick=()=>{ filesArray.splice(idx,1); renderFiles(); };
    div.appendChild(btn);
    fileList.appendChild(div);
  });
}

// --- Firebase Auth ---
onAuthStateChanged(auth,user=>{
  if(!user) window.location.href='index.html';
  currentUserId=user.uid;
  loadNotes();
});

// --- Notes ---
async function loadNotes(){
  notesList.innerHTML='';
  const notesCol = collection(db,'users',currentUserId,'daily_notes');
  const snapshot = await getDocs(notesCol);
  snapshot.forEach(docSnap=>{
    const note=docSnap.data();
    const id=docSnap.id;
    const div=document.createElement('div');
    div.className='note-box';
    div.textContent=note.title;
    div.onclick=()=>editNote(id,note);
    notesList.appendChild(div);
  });
}

function showEditor(note=null){
  noteEditor.classList.remove('hidden');
  if(note){
    editingNoteId=note.id;
    noteTitle.value=note.title;
    noteText.value=note.text;
    linksArray=note.links || [];
    filesArray=[]; // files must reattach
  } else {
    editingNoteId=null;
    noteTitle.value='';
    noteText.value='';
    linksArray=[];
    filesArray=[];
  }
  renderLinks();
  renderFiles();
}

newNoteBtn.onclick=()=>showEditor();
cancelNoteBtn.onclick=()=>noteEditor.classList.add('hidden');
addLinkBtn.onclick=()=>{
  if(linkInput.value.trim()){ linksArray.push(linkInput.value.trim()); linkInput.value=''; renderLinks();}
};

// Handle file selection
fileInput.onchange=(e)=>{
  for(const f of e.target.files){
    if(f.size>MAX_FILE_SIZE){ alert(f.name+' too big'); continue; }
    filesArray.push(f);
  }
  renderFiles();
};

// Upload file with progress
function uploadFile(file,noteId){
  return new Promise((resolve,reject)=>{
    const fileRef = ref(storage,`users/${currentUserId}/daily_notes/${noteId}/${file.name}`);
    const task = uploadBytesResumable(fileRef,file);
    uploadTasks.push(task);
    task.on('state_changed',
      snapshot=>uploadStatus.textContent=`Uploading ${file.name}: ${Math.round(snapshot.bytesTransferred/snapshot.totalBytes*100)}%`,
      err=>reject(err),
      async ()=>{ const url=await getDownloadURL(task.snapshot.ref); resolve({name:file.name,url}); }
    );
  });
}

// --- Edit Note ---
function editNote(id,note){
  note.id=id;
  showEditor(note);
}

// --- Delete Note ---
async function deleteNote(noteId){
  if(!confirm('Delete this note?')) return;
  const noteRef = doc(db,'users',currentUserId,'daily_notes',noteId);
  const noteSnap = await getDocs(collection(db,'users',currentUserId,'daily_notes'));
  try{ await deleteDoc(noteRef); } catch(e){ console.error(e); }
  loadNotes();
}

// --- Save Note ---
saveNoteBtn.onclick=async()=>{
  if(!noteTitle.value.trim() || !noteText.value.trim()) return alert('Enter title & text');
  saveNoteBtn.disabled=true;
  uploadStatus.textContent='Saving note...';

  const noteRef = editingNoteId ? doc(db,'users',currentUserId,'daily_notes',editingNoteId) : doc(collection(db,'users',currentUserId,'daily_notes'));
  const noteId = noteRef.id;

  // Upload files
  let uploadedFiles = [];
  for(const f of filesArray){
    try{ uploadedFiles.push(await uploadFile(f,noteId)); }
    catch(e){ console.error('File upload failed',f.name,e); }
  }

  await setDoc(noteRef,{
    title:noteTitle.value,
    text:noteText.value,
    links:linksArray,
    files:uploadedFiles,
    timestamp:new Date()
  });

  uploadStatus.textContent='Saved!';
  saveNoteBtn.disabled=false;
  noteEditor.classList.add('hidden');
  loadNotes();
};
</script>
</body>
</html>