<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .note-box { @apply bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition; }
  .collapsible-content { transition: max-height 0.35s ease; overflow: hidden; }
</style>
</head>
<body class="min-h-screen">

<nav class="bg-indigo-700 text-white p-4 shadow-lg">
  <div class="max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-5 py-2 rounded-lg hover:bg-indigo-600 transition">Home</a>
    <a href="curriculum_topics.html" class="px-5 py-2 rounded-lg hover:bg-indigo-600 transition">Topics</a>
    <a href="notes.html" class="px-5 py-2 bg-white text-indigo-700 font-bold rounded-lg">Notes</a>
    <a href="todo.html" class="px-5 py-2 rounded-lg hover:bg-indigo-600 transition">To-Do</a>
    <a href="resources.html" class="px-5 py-2 rounded-lg hover:bg-indigo-600 transition">Tools</a>
    <button id="signout-btn" class="px-5 py-2 bg-red-600 rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="max-w-4xl mx-auto p-6 mt-8">
  <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Daily Notes</h1>

  <!-- Create Note -->
  <div class="bg-indigo-50 rounded-xl p-6 mb-8">
    <div id="newNoteHeader" class="flex justify-between items-center cursor-pointer">
      <h2 class="text-2xl font-bold text-indigo-800">Create New Note</h2>
      <i id="toggleIcon" class="fa-solid fa-chevron-down text-xl"></i>
    </div>
    <div id="newNoteContent" class="mt-6 space-y-4 hidden">
      <input id="noteTitle" type="text" placeholder="Note Title" class="w-full p-3 border rounded-lg">
      <textarea id="noteText" placeholder="Your note..." rows="5" class="w-full p-3 border rounded-lg"></textarea>
      <input id="noteFiles" type="file" multiple class="w-full p-3 border rounded-lg bg-white">
      <input id="noteLinks" type="text" placeholder="Links (comma-separated)" class="w-full p-3 border rounded-lg mt-3">
      <button id="saveNoteBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">
        Save Note
      </button>
    </div>
  </div>

  <div id="notesContainer" class="space-y-6">
    <p class="text-center text-gray-500 italic">Loading your notes...</p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let NOTES_REF = null;

// Toggle create form
document.getElementById("newNoteHeader").onclick = () => {
  const content = document.getElementById("newNoteContent");
  const icon = document.getElementById("toggleIcon");
  content.classList.toggle("hidden");
  icon.classList.toggle("fa-chevron-down");
  icon.classList.toggle("fa-chevron-up");
};

// Render single note
function renderNote(id, data) {
  const div = document.createElement("div");
  div.className = "note-box";

  const filesHTML = (data.files || []).map(f => `
    <li>
      <a href="${f.url}" target="_blank" download="${f.name}" rel="noopener noreferrer"
         class="text-indigo-600 hover:underline font-medium">
        ${f.name}
      </a>
    </li>`).join('');

  const linksHTML = (data.links || []).map(l => `
    <li>
      <a href="${l}" target="_blank" rel="noopener noreferrer"
         class="text-indigo-600 hover:underline">
        ${l}
      </a>
    </li>`).join('');

  div.innerHTML = `
    <div class="flex justify-between items-center cursor-pointer collapsible">
      <h3 class="text-xl font-semibold text-gray-800">${data.title || "Untitled"}</h3>
      <i class="fa-solid fa-chevron-down text-gray-600"></i>
    </div>
    <div class="content mt-4 hidden space-y-4">
      <p class="text-gray-700 whitespace-pre-wrap">${data.text || ""}</p>
      ${data.links?.length ? `<div><strong>Links:</strong><ul class="list-disc ml-8 mt-2">${linksHTML}</ul></div>` : ''}
      ${data.files?.length ? `<div><strong>Files:</strong><ul class="list-disc ml-8 mt-2">${filesHTML}</ul></div>` : ''}
      <div class="flex gap-3 pt-4 border-t">
        <button onclick="editNote('${id}')" class="bg-yellow-500 text-white px-5 py-2 rounded-lg hover:bg-yellow-600">Edit</button>
        <button onclick="deleteNote('${id}', ${JSON.stringify(data.files || [])})" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700">Delete</button>
      </div>
    </div>
  `;

  div.querySelector(".collapsible").onclick = () => {
    div.querySelector(".content").classList.toggle("hidden");
    div.querySelector("i").classList.toggle("fa-chevron-down");
    div.querySelector("i").classList.toggle("fa-chevron-up");
  };

  return div;
}

// Edit note
window.editNote = async (id) => {
  const newTitle = prompt("Edit title:", "");
  const newText = prompt("Edit text:", "");
  if (newTitle !== null && newText !== null) {
    await updateDoc(doc(db, NOTES_REF.path, id), { title: newTitle, text: newText, updatedAt: serverTimestamp() });
  }
};

// Delete note + files from Storage
window.deleteNote = async (id, files) => {
  if (!confirm("Delete this note permanently?")) return;
  for (const f of files) {
    try { await deleteObject(ref(storage, f.path)); } catch(e) {}
  }
  await deleteDoc(doc(db, NOTES_REF.path, id));
};

// Save note with file upload
document.getElementById("saveNoteBtn").onclick = async () => {
  const title = document.getElementById("noteTitle").value.trim();
  const text = document.getElementById("noteText").value.trim();
  const links = document.getElementById("noteLinks").value.split(",").map(l => l.trim()).filter(Boolean);
  const files = document.getElementById("noteFiles").files;

  if (!title || !text) return alert("Title and text required");

  const btn = document.getElementById("saveNoteBtn");
  btn.disabled = true;
  btn.textContent = "Uploading...";

  const uploadedFiles = [];
  for (const file of files) {
    const path = `notes/${Date.now()}_${file.name}`;
    const storageRef = ref(storage, path);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    uploadedFiles.push({ name: file.name, url, path });
  }

  await addDoc(NOTES_REF, {
    title,
    text,
    links,
    files: uploadedFiles,
    createdAt: serverTimestamp()
  });

  // Reset form
  document.getElementById("noteTitle").value = "";
  document.getElementById("noteText").value = "";
  document.getElementById("noteLinks").value = "";
  document.getElementById("noteFiles").value = "";
  document.getElementById("newNoteContent").classList.add("hidden");
  document.getElementById("toggleIcon").classList.replace("fa-chevron-up", "fa-chevron-down");

  btn.disabled = false;
  btn.textContent = "Save Note";
};

// Auth & real-time listener
onAuthStateChanged(auth, user => {
  if (!user) return location.href = "index.html";

  NOTES_REF = collection(db, "users", user.uid, "daily_notes");

  onSnapshot(NOTES_REF, snapshot => {
    const container = document.getElementById("notesContainer");
    container.innerHTML = snapshot.empty
      ? `<p class="text-center text-gray-500 italic text-lg">No notes yet. Create one!</p>`
      : "";

    snapshot.docs
      .sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0))
      .forEach(doc => {
        container.appendChild(renderNote(doc.id, doc.data()));
      });
  });
});

document.getElementById("signout-btn").onclick = () => signOut(auth);
</script>
</body>
</html>