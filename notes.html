<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
  .note-box { @apply bg-white p-5 rounded-xl shadow-md border border-gray-200; }
  .collapsible-content { transition: max-height 0.3s ease-out; overflow: hidden; }
  .link-item { display:flex; gap:0.5rem; align-items:center; margin-bottom:0.25rem; }
  .link-item input { flex:1; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="curriculum_topics.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="signout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-5xl mx-auto p-6 mt-8 flex gap-6">
  <!-- Notes Sidebar -->
  <div class="w-1/3 space-y-4">
    <button id="newNoteBtn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">+ New Note</button>
    <div id="notesList" class="space-y-2">
      <p class="text-gray-500 text-center">Loading notes...</p>
    </div>
  </div>

  <!-- Note Preview / Editor -->
  <div class="w-2/3 bg-white p-5 rounded-3xl shadow-2xl hidden" id="noteEditor">
    <h2 class="text-2xl font-bold mb-4" id="editorTitle">New Note</h2>
    <input id="noteTitle" type="text" placeholder="Note Title..." class="w-full p-3 border rounded-lg mb-3">
    <textarea id="noteText" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3" rows="6"></textarea>

    <!-- Links -->
    <div class="mb-3">
      <label class="font-semibold text-gray-700">Links:</label>
      <div id="linksContainer" class="mt-1"></div>
      <div class="flex gap-2 mt-2">
        <input type="text" id="linkInput" placeholder="https://example.com" class="flex-1 p-2 border rounded-lg">
        <button id="addLinkBtn" class="bg-indigo-500 text-white px-3 rounded-lg hover:bg-indigo-600 transition">Add Link</button>
      </div>
    </div>

    <!-- Files -->
    <label class="font-semibold block mb-1 text-gray-700">Attach Files (Max 20MB each):</label>
    <input id="noteFiles" type="file" multiple class="w-full p-2 bg-white border rounded-lg mb-4">

    <div class="flex gap-2">
      <button id="saveNoteBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Save</button>
      <button id="deleteNoteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition hidden">Delete</button>
      <button id="cancelEditBtn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM Elements
const newNoteBtn = document.getElementById("newNoteBtn");
const notesList = document.getElementById("notesList");
const noteEditor = document.getElementById("noteEditor");
const noteTitle = document.getElementById("noteTitle");
const noteText = document.getElementById("noteText");
const noteFiles = document.getElementById("noteFiles");
const saveNoteBtn = document.getElementById("saveNoteBtn");
const deleteNoteBtn = document.getElementById("deleteNoteBtn");
const cancelEditBtn = document.getElementById("cancelEditBtn");
const editorTitle = document.getElementById("editorTitle");
const linksContainer = document.getElementById("linksContainer");
const linkInput = document.getElementById("linkInput");
const addLinkBtn = document.getElementById("addLinkBtn");
const MAX_FILE_SIZE_BYTES = 20 * 1024 * 1024;

let NOTES_REF = null;
let currentUserId = null;
let editingNoteId = null;
let noteLinks = [];

// --- Auth ---
onAuthStateChanged(auth, user => {
  if (!user) return window.location.href = "index.html";
  currentUserId = user.uid;
  NOTES_REF = collection(db, "users", currentUserId, "daily_notes");
  loadNotes();
});

// --- Load Notes ---
function loadNotes() {
  onSnapshot(NOTES_REF, snapshot => {
    notesList.innerHTML = "";
    if (snapshot.empty) notesList.innerHTML = `<p class="text-gray-500 text-center">No notes yet.</p>`;
    snapshot.forEach(docSnap => {
      const note = docSnap.data();
      const noteEl = document.createElement("div");
      noteEl.className = "p-3 bg-white rounded-lg shadow cursor-pointer hover:bg-indigo-50 transition";
      noteEl.innerHTML = `<strong>${note.title}</strong><br><small>${note.text.slice(0,50)}</small>`;
      noteEl.addEventListener("click", () => openNoteEditor(docSnap.id, note));
      notesList.appendChild(noteEl);
    });
  });
}

// --- Open Note Editor ---
function openNoteEditor(id=null, note=null) {
  noteEditor.classList.remove("hidden");
  editingNoteId = id;
  noteTitle.value = note?.title || "";
  noteText.value = note?.text || "";
  noteLinks = note?.links || [];
  renderLinks();
  editorTitle.textContent = id ? "Edit Note" : "New Note";
  deleteNoteBtn.classList.toggle("hidden", !id);
}

// --- Render Links ---
function renderLinks() {
  linksContainer.innerHTML = "";
  noteLinks.forEach((l, i) => {
    const div = document.createElement("div");
    div.className = "link-item";
    div.innerHTML = `<input type="text" value="${l}" readonly class="p-2 border rounded-lg flex-1"> <button data-index="${i}" class="bg-red-500 text-white px-2 rounded hover:bg-red-600">X</button>`;
    div.querySelector("button").addEventListener("click", e => {
      noteLinks.splice(e.target.dataset.index,1);
      renderLinks();
    });
    linksContainer.appendChild(div);
  });
}

// --- Add Link ---
addLinkBtn.addEventListener("click", () => {
  const val = linkInput.value.trim();
  if (val) {
    noteLinks.push(val);
    linkInput.value = "";
    renderLinks();
  }
});

// --- Cancel ---
cancelEditBtn.addEventListener("click", () => {
  noteEditor.classList.add("hidden");
  editingNoteId = null;
  noteLinks = [];
  noteTitle.value = "";
  noteText.value = "";
  noteFiles.value = "";
  linksContainer.innerHTML = "";
});

// --- Save Note ---
saveNoteBtn.addEventListener("click", async () => {
  const title = noteTitle.value.trim();
  const text = noteText.value.trim();
  if (!title || !text) return alert("Title and text required");

  const files = Array.from(noteFiles.files);
  for (const f of files) if (f.size > MAX_FILE_SIZE_BYTES) return alert(`${f.name} exceeds 20MB`);

  const noteId = editingNoteId || doc(NOTES_REF).id;
  const uploadedFiles = [];

  for (const file of files) {
    const fileRef = ref(storage, `users/${currentUserId}/daily_notes/${noteId}/${file.name}`);
    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);
    uploadedFiles.push({name:file.name,url});
  }

  await setDoc(doc(NOTES_REF, noteId), { title, text, links:noteLinks, files:uploadedFiles, timestamp:new Date() });

  // Reset
  noteEditor.classList.add("hidden");
  editingNoteId = null;
  noteLinks = [];
  noteTitle.value = "";
  noteText.value = "";
  noteFiles.value = "";
  linksContainer.innerHTML = "";
});

// --- Delete Note ---
deleteNoteBtn.addEventListener("click", async () => {
  if (!editingNoteId) return;
  if (!confirm("Delete this note?")) return;

  const noteDoc = doc(NOTES_REF, editingNoteId);
  const noteSnap = await getDoc(noteDoc);
  const noteData = noteSnap.data();
  const files = noteData?.files || [];
  for (const f of files) {
    try { await deleteObject(ref(storage, `users/${currentUserId}/daily_notes/${editingNoteId}/${f.name}`)); } catch(e){console.warn(e);}
  }
  await deleteDoc(noteDoc);
  cancelEditBtn.click();
});

// --- Sign Out ---
document.getElementById("signout-btn").addEventListener("click", () => signOut(auth));

newNoteBtn.addEventListener("click", () => openNoteEditor());

</script>
</body>
</html>