<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .note-box { @apply bg-white p-5 rounded-xl shadow-md border border-gray-200; }
  .collapsible-content { transition: max-height 0.3s ease-out; overflow: hidden; }
</style>
</head>
<body>

<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home</a>
    <a href="curriculum_topics.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics</a>
    <a href="notes.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools</a>
    <button id="signout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-4xl mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-8">
  <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Daily Notes</h1>

  <div class="bg-indigo-50 p-5 rounded-xl mb-6">
    <div id="newNoteHeader" class="flex justify-between items-center cursor-pointer text-indigo-800 hover:text-indigo-900 transition">
      <h2 class="text-xl font-bold">Create a New Note</h2>
      <i id="toggleIcon" class="fa-solid fa-chevron-down"></i>
    </div>
    <div id="newNoteContent" class="collapsible-content mt-4 hidden">
      <input id="noteTitle" type="text" placeholder="Note Title..." class="w-full p-3 border rounded-lg mb-3">
      <textarea id="noteText" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3" rows="4"></textarea>

      <label class="font-semibold block mb-1 text-gray-700">Attach Files (will open/download externally):</label>
      <input id="noteFiles" type="file" multiple class="w-full p-2 bg-white border rounded-lg mb-4">

      <label class="font-semibold block mb-1 text-gray-700">Add Links (optional):</label>
      <input id="noteLinks" type="text" placeholder="https://example.com, https://..." class="w-full p-3 border rounded-lg mb-4">

      <button id="saveNoteBtn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">
        Save Note
      </button>
    </div>
  </div>

  <div id="notesContainer" class="space-y-4"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = { /* your config */ };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let NOTES_REF = null;
const fileMap = new Map(); // docId â†’ [{name, blobURL, file}]

document.getElementById("newNoteHeader").addEventListener("click", () => {
  document.getElementById("newNoteContent").classList.toggle("hidden");
  document.getElementById("toggleIcon").classList.toggle("fa-chevron-down");
  document.getElementById("toggleIcon").classList.toggle("fa-chevron-up");
});

function renderNote(id, data) {
  const div = document.createElement("div");
  div.className = "note-box";

  const files = fileMap.get(id) || [];
  const links = data.links || [];

  div.innerHTML = `
    <div class="flex justify-between items-center cursor-pointer collapsible">
      <h3 class="text-xl font-semibold">${data.title || "Untitled"}</h3>
      <i class="fa-solid fa-chevron-down"></i>
    </div>
    <div class="content mt-3 collapsible-content hidden">
      <p class="mb-3 whitespace-pre-wrap">${data.text || ""}</p>

      ${links.length ? `<h4 class="font-semibold text-gray-700 mb-1">Links:</h4>
        <ul class="list-disc ml-6 mb-4 text-sm">
          ${links.map(l => `<li><a href="${l}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">${l}</a></li>`).join('')}
        </ul>` : ''}

      ${files.length ? `<h4 class="font-semibold text-gray-700 mb-1">Files:</h4>
        <ul class="list-disc ml-6 mb-4 text-sm">
          ${files.map(f => `
            <li>
              <a href="${f.blobURL}" 
                 download="${f.name}" 
                 target="_blank" 
                 rel="noopener noreferrer"
                 class="text-indigo-600 hover:underline">
                ${f.name}
              </a>
            </li>`).join('')}
        </ul>` : ''}

      <div class="flex gap-2 mt-4">
        <button onclick="editNote('${id}')" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">Edit</button>
        <button onclick="deleteNote('${id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
      </div>
    </div>
  `;

  div.querySelector(".collapsible").addEventListener("click", () => {
    const c = div.querySelector(".content");
    const i = div.querySelector("i");
    c.classList.toggle("hidden");
    i.classList.toggle("fa-chevron-down");
    i.classList.toggle("fa-chevron-up");
  });

  return div;
}

window.editNote = async (id) => {
  const ref = doc(NOTES_REF, id);
  const snap = await ref.get();
  const d = snap.data();
  const title = prompt("New title", d.title);
  const text = prompt("New text", d.text);
  if (title !== null && text !== null) {
    await updateDoc(ref, { title, text });
  }
};

window.deleteNote = async (id) => {
  if (!confirm("Delete this note?")) return;
  fileMap.get(id)?.forEach(f => URL.revokeObjectURL(f.blobURL));
  fileMap.delete(id);
  await deleteDoc(doc(NOTES_REF, id));
};

document.getElementById("saveNoteBtn").onclick = async () => {
  const title = document.getElementById("noteTitle").value.trim();
  const text = document.getElementById("noteText").value.trim();
  const links = document.getElementById("noteLinks").value.split(",").map(s => s.trim()).filter(Boolean);
  const files = Array.from(document.getElementById("noteFiles").files);

  if (!title || !text) return alert("Title and text required");

  const btn = document.getElementById("saveNoteBtn");
  btn.disabled = true;
  btn.textContent = "Saving...";

  const fileEntries = files.map(file => ({
    name: file.name,
    blobURL: URL.createObjectURL(file),
    file
  }));

  const docRef = await addDoc(NOTES_REF, {
    title,
    text,
    links,
    fileNames: fileEntries.map(f => f.name) // only names saved
  });

  fileMap.set(docRef.id, fileEntries);

  // reset
  document.getElementById("noteTitle").value = "";
  document.getElementById("noteText").value = "";
  document.getElementById("noteLinks").value = "";
  document.getElementById("noteFiles").value = "";
  document.getElementById("newNoteContent").classList.add("hidden");
  document.getElementById("toggleIcon").classList.replace("fa-chevron-up", "fa-chevron-down");

  btn.disabled = false;
  btn.textContent = "Save Note";
};

onAuthStateChanged(auth, user => {
  if (!user) return location.href = "index.html";
  NOTES_REF = collection(db, "users", user.uid, "daily_notes");

  onSnapshot(NOTES_REF, snap => {
    document.getElementById("notesContainer").innerHTML = snap.empty
      ? `<p class="text-gray-500 italic text-center">No notes yet.</p>`
      : "";
    snap.forEach(d => {
      document.getElementById("notesContainer").appendChild(renderNote(d.id, d.data()));
    });
  });
});

document.getElementById("signout-btn").onclick = () => signOut(auth);
</script>
</body>
</html>