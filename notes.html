<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
    .note-box { @apply bg-white p-5 rounded-xl shadow-md border border-gray-200; }
    /* Added transition for smooth collapsing, though `hidden` overwrites it */
    .collapsible-content { transition: max-height 0.3s ease-out; overflow: hidden; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
    <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
        <a href="dashboard.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
        <a href="curriculum_topics.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
        <a href="notes.html" class="px-4 py-2 nav-active font-bold rounded-lg transition">Notes üìù</a>
        <a href="todo.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">To-Do List ‚úÖ</a>
        <a href="resources.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    </div>
</nav>

<!-- Page Content -->
<div class="container max-w-4xl mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-8">

    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Daily Notes üìù</h1>

    <!-- Add Note (Collapsible Section) -->
    <div class="bg-indigo-50 p-5 rounded-xl mb-6">
        
        <!-- Collapsible Header -->
        <div id="newNoteHeader" 
             class="flex justify-between items-center cursor-pointer text-indigo-800 hover:text-indigo-900 transition">
            <h2 class="text-xl font-bold">Create a New Note</h2>
            <i id="toggleIcon" class="fa-solid fa-chevron-down"></i>
        </div>

        <!-- Collapsible Content (Starts Hidden) -->
        <div id="newNoteContent" class="collapsible-content mt-4 hidden">
            
            <input id="noteTitle" type="text" placeholder="Note Title..." 
                   class="w-full p-3 border rounded-lg mb-3">

            <textarea id="noteText" placeholder="Write your note..." 
                      class="w-full p-3 border rounded-lg mb-3" rows="4"></textarea>

            <!-- Add Files -->
            <label class="font-semibold block mb-1 text-gray-700">Attach Files:</label>
            <input id="noteFiles" type="file" multiple class="w-full p-2 bg-white border rounded-lg mb-4">

            <!-- Add Links -->
            <label class="font-semibold block mb-1 text-gray-700">Add Links (optional):</label>
            <input id="noteLinks" type="text" placeholder="Comma-separated URLs..." 
                   class="w-full p-3 border rounded-lg mb-4">

            <button id="saveNoteBtn" 
                    class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">
                Save Note
            </button>
        </div>
    </div>

    <!-- Notes List -->
    <div id="notesContainer" class="space-y-4">
        <p class="text-gray-500 italic text-center">Loading notes...</p>
    </div>

</div>

<!-- Firebase Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
    getFirestore, 
    collection, 
    doc,
    addDoc,
    // updateDoc, // Not used yet
    deleteDoc,
    onSnapshot 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

import { 
    getStorage, 
    ref, 
    uploadBytes, 
    getDownloadURL 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let NOTES_REF = null;

// New DOM elements for collapse functionality
const newNoteHeader = document.getElementById("newNoteHeader");
const newNoteContent = document.getElementById("newNoteContent");
const toggleIcon = document.getElementById("toggleIcon");

const notesContainer = document.getElementById("notesContainer");
const saveNoteBtn = document.getElementById("saveNoteBtn");

// --- COLLAPSE HANDLER ---
newNoteHeader.addEventListener('click', () => {
    newNoteContent.classList.toggle('hidden');
    // Toggle the arrow icon direction
    if (newNoteContent.classList.contains('hidden')) {
        toggleIcon.classList.replace('fa-chevron-up', 'fa-chevron-down');
    } else {
        toggleIcon.classList.replace('fa-chevron-down', 'fa-chevron-up');
    }
});


// Convert file list to uploaded URLs
async function uploadFiles(uid, dateId, files) {
    const urls = [];

    for (const file of files) {
        const storageRef = ref(storage, `notes/${uid}/${dateId}/${file.name}`);
        // Add a simple loading state feedback for the button
        saveNoteBtn.textContent = `Uploading ${file.name}...`; 
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        urls.push({ name: file.name, url });
    }
    saveNoteBtn.textContent = `Upload complete. Saving note...`;
    return urls;
}

// Render a single note item
function renderNote(docId, note) {
    const div = document.createElement("div");
    div.className = "note-box";

    div.innerHTML = `
        <div class="flex justify-between items-center cursor-pointer collapsible">
            <h3 class="text-xl font-semibold">${note.title}</h3>
            <i class="fa-solid fa-chevron-down"></i>
        </div>

        <div class="content mt-3 collapsible-content hidden">
            <p class="mb-3 whitespace-pre-wrap">${note.text}</p>

            <!-- Links -->
            ${note.links.length > 0 ? `
                <h4 class="font-semibold text-gray-700">Links:</h4>
                <ul class="list-disc ml-6 mb-3 text-sm">
                    ${note.links.map(l => `<li><a class="text-indigo-600 hover:text-indigo-800 underline transition" href="${l}" target="_blank">${l}</a></li>`).join("")}
                </ul>
            ` : ''}

            <!-- Files -->
            ${note.files.length > 0 ? `
                <h4 class="font-semibold text-gray-700">Files:</h4>
                <ul class="list-disc ml-6 mb-3 text-sm">
                    ${note.files.map(f => `<li><a class="text-indigo-600 hover:text-indigo-800 underline transition" href="${f.url}" target="_blank">${f.name}</a></li>`).join("")}
                </ul>
            ` : ''}

            <div class="flex gap-2 mt-4">
                <button class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition"
                        onclick="editNote('${docId}')">Edit</button>
                <button class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition"
                        onclick="deleteNote('${docId}')">Delete</button>
            </div>
        </div>
    `;

    // Collapsible handler for the note content
    div.querySelector(".collapsible").addEventListener("click", (e) => {
        const content = div.querySelector(".content");
        const icon = div.querySelector(".collapsible i");
        
        content.classList.toggle("hidden");
        
        if (content.classList.contains('hidden')) {
            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        } else {
            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        }
    });

    return div;
}

// Edit Note (Placeholder)
window.editNote = (id) => {
    // Replaced alert() with a custom message box simulation
    const noteToEdit = document.querySelector(`.note-box[data-id="${id}"]`);
    if (noteToEdit) {
      alert("Editing functionality will be added in a future step!");
    }
};

// Delete Note (Using console logging instead of confirm())
window.deleteNote = async (id) => {
    try {
        if (!NOTES_REF) return console.error("Notes collection reference not initialized.");
        
        // In a real app, this would be a custom confirmation modal
        console.log(`Attempting to delete note: ${id}.`);
        await deleteDoc(doc(NOTES_REF, id));
        console.log("Note deleted successfully.");

    } catch(e) {
        console.error("Error deleting note:", e);
    }
};

// Save Note
saveNoteBtn.onclick = async () => {
    const title = document.getElementById("noteTitle").value.trim();
    const text = document.getElementById("noteText").value.trim();
    const linkString = document.getElementById("noteLinks").value.trim();
    const files = document.getElementById("noteFiles").files;

    if (!title || !text) return alert("Please enter title and text.");

    // Disable button and show loading text
    saveNoteBtn.disabled = true;
    saveNoteBtn.textContent = 'Processing...';

    const dateId = Date.now().toString();

    let uploadedFiles = [];
    try {
        if (files.length > 0) {
            uploadedFiles = await uploadFiles(auth.currentUser.uid, dateId, files);
        }

        const links = linkString ? linkString.split(",").map(x => x.trim()).filter(x => x.length > 0) : [];

        await addDoc(NOTES_REF, {
            title,
            text,
            files: uploadedFiles,
            links,
            timestamp: new Date().toISOString()
        });

        // Clear inputs and reset button
        document.getElementById("noteTitle").value = "";
        document.getElementById("noteText").value = "";
        document.getElementById("noteLinks").value = "";
        document.getElementById("noteFiles").value = "";
        saveNoteBtn.textContent = 'Save Note';
        saveNoteBtn.disabled = false;
        
        // Collapse the note creation form after successful save
        newNoteContent.classList.add('hidden');
        toggleIcon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        
    } catch (e) {
        console.error("Error saving note:", e);
        saveNoteBtn.textContent = 'Error Saving (See console)';
        saveNoteBtn.disabled = false;
    }
};

// Auth + load notes
onAuthStateChanged(auth, (user) => {
    if (!user) {
        // Simple redirection back to login if unauthenticated
        setTimeout(() => window.location.href = "index.html", 50); 
        return;
    }

    NOTES_REF = collection(db, "artifacts", "school-organiser-5f512", "users", user.uid, "daily_notes");

    onSnapshot(NOTES_REF, (snapshot) => {
        notesContainer.innerHTML = "";
        if (snapshot.empty) {
            notesContainer.innerHTML = `<p class="text-gray-500 italic text-center">No notes yet.</p>`;
            return;
        }

        snapshot.forEach(docSnap => {
            const element = renderNote(docSnap.id, docSnap.data());
            notesContainer.appendChild(element);
        });
    });
});
</script>

</body>
</html>

