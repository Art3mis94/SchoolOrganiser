<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
  .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
  .note-box { @apply bg-white p-4 rounded-lg shadow-md border border-gray-200 mb-3; }
  .collapsible-content { transition: max-height 0.3s ease-out; overflow: hidden; }
  .sidebar { @apply bg-indigo-50 p-4 rounded-xl space-y-2 w-64 min-w-[250px]; }
  .link-item { @apply flex items-center gap-2 text-indigo-600 hover:text-indigo-800 transition cursor-pointer; }
  .file-item { @apply flex items-center gap-2 text-green-600 hover:text-green-800 transition; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-6xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home ğŸ </a>
    <a href="curriculum_topics.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics ğŸ§ </a>
    <a href="notes.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes ğŸ“</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do âœ…</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools ğŸ› ï¸</a>
    <button id="signout-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-6xl mx-auto flex mt-6 gap-6">

  <!-- Sidebar for Notes List -->
  <div class="sidebar">
    <h2 class="text-xl font-bold text-indigo-800 mb-4">Your Notes</h2>
    <div id="notesList" class="space-y-2">
      <p class="text-gray-500 italic text-center">Loading notes...</p>
    </div>
  </div>

  <!-- Main Panel -->
  <div class="flex-1 bg-white rounded-3xl shadow-2xl p-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Create a New Note ğŸ“</h1>

    <input id="noteTitle" type="text" placeholder="Note Title..." class="w-full p-3 border rounded-lg mb-3">

    <textarea id="noteText" placeholder="Write your note..." class="w-full p-3 border rounded-lg mb-3" rows="4"></textarea>

    <!-- File Input -->
    <label class="font-semibold block mb-1 text-gray-700">Attach Files (Max 20MB each)</label>
    <input id="noteFiles" type="file" multiple class="w-full p-2 bg-white border rounded-lg mb-4">

    <!-- Links Input -->
    <label class="font-semibold block mb-1 text-gray-700">Add a Link</label>
    <div class="flex gap-2 mb-4">
      <input id="linkInput" type="text" placeholder="https://example.com" class="w-full p-2 border rounded-lg">
      <button id="addLinkBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Add Link</button>
    </div>
    <ul id="linksList" class="mb-4"></ul>

    <button id="saveNoteBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition shadow-lg">
      Save Note
    </button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

// --- Initialization ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUserId = null;
let NOTES_REF = null;
let tempLinks = [];

// DOM
const notesList = document.getElementById("notesList");
const saveNoteBtn = document.getElementById("saveNoteBtn");
const noteTitleInput = document.getElementById("noteTitle");
const noteTextInput = document.getElementById("noteText");
const noteFilesInput = document.getElementById("noteFiles");
const linkInput = document.getElementById("linkInput");
const addLinkBtn = document.getElementById("addLinkBtn");
const linksList = document.getElementById("linksList");

// --- Auth ---
onAuthStateChanged(auth, async user => {
  if (!user) return window.location.href = "index.html";
  currentUserId = user.uid;
  NOTES_REF = collection(db, "users", currentUserId, "daily_notes");

  // Migrate old notes automatically
  const oldNotesRef = collection(db, "daily_notes_old", currentUserId, "notes");
  const oldSnapshot = await getDocs(oldNotesRef);
  for (const docSnap of oldSnapshot.docs) {
    const data = docSnap.data();
    await setDoc(doc(NOTES_REF, docSnap.id), data);
    await doc(db, "daily_notes_old", currentUserId, "notes", docSnap.id); // optional: delete old after migration
  }

  loadNotes();
});

// --- Links Management ---
addLinkBtn.addEventListener("click", () => {
  const link = linkInput.value.trim();
  if (!link) return;
  const url = link.startsWith("http") ? link : `https://${link}`;
  tempLinks.push(url);
  renderLinks();
  linkInput.value = "";
});

function renderLinks() {
  linksList.innerHTML = tempLinks.map((l, i) => `<li class="link-item">${l} <i class="fa fa-trash cursor-pointer" onclick="removeLink(${i})"></i></li>`).join("");
}
window.removeLink = (i) => { tempLinks.splice(i,1); renderLinks(); }

// --- Upload Files ---
async function uploadFiles(noteId) {
  const files = Array.from(noteFilesInput.files);
  const uploaded = [];
  for (const f of files) {
    if (f.size > 20*1024*1024) { alert(`File ${f.name} exceeds 20MB`); continue; }
    const storageRef = ref(storage, `users/${currentUserId}/daily_notes/${noteId}/${f.name}`);
    await uploadBytes(storageRef, f);
    const url = await getDownloadURL(storageRef);
    uploaded.push({ name: f.name, url });
  }
  return uploaded;
}

// --- Save Note ---
saveNoteBtn.addEventListener("click", async () => {
  if (!noteTitleInput.value.trim() || !noteTextInput.value.trim()) return alert("Title and text required");
  const noteId = doc(NOTES_REF).id;
  const files = await uploadFiles(noteId);
  await setDoc(doc(NOTES_REF, noteId), {
    title: noteTitleInput.value,
    text: noteTextInput.value,
    files,
    links: tempLinks,
    createdAt: new Date()
  });
  // reset inputs
  noteTitleInput.value = "";
  noteTextInput.value = "";
  noteFilesInput.value = "";
  tempLinks = [];
  renderLinks();
});

// --- Load Notes ---
function loadNotes() {
  onSnapshot(NOTES_REF, snapshot => {
    notesList.innerHTML = "";
    snapshot.forEach(docSnap => {
      const note = docSnap.data();
      const div = document.createElement("div");
      div.className = "note-box cursor-pointer";
      div.innerHTML = `
        <h3 class="font-semibold">${note.title}</h3>
        <div class="text-sm mt-1 collapsible-content hidden">
          <p class="whitespace-pre-wrap">${note.text}</p>
          ${note.links?.length ? `<h4 class="font-semibold mt-2">Links:</h4><ul>${note.links.map(l => `<li><a href="${l}" target="_blank" rel="noopener noreferrer">${l}</a></li>`).join("")}</ul>` : ""}
          ${note.files?.length ? `<h4 class="font-semibold mt-2">Files:</h4><ul>${note.files.map(f => `<li><a href="${f.url}" target="_blank" rel="noopener noreferrer">${f.name}</a></li>`).join("")}</ul>` : ""}
        </div>
      `;
      div.querySelector("h3").addEventListener("click", () => {
        const content = div.querySelector(".collapsible-content");
        content.classList.toggle("hidden");
      });
      notesList.appendChild(div);
    });
  });
}

// --- Sign Out ---
document.getElementById("signout-btn").addEventListener("click", () => signOut(auth));

</script>
</body>
</html>