<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Educator Hub - Notes (Option C)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  body { font-family: 'Inter', sans-serif; background:#f3f4f6; }
  .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
  .note-item:hover { transform: translateX(4px); }
  .disabled { opacity: .6; pointer-events: none; }
</style>
</head>
<body class="min-h-screen">

<!-- NAVBAR -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-6xl mx-auto flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <a href="dashboard.html" class="px-3 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
      <a href="curriculum_topics.html" class="px-3 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Topics üß†</a>
      <a href="notes.html" class="px-3 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Notes üìù</a>
      <a href="todo.html" class="px-3 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
      <a href="resources.html" class="px-3 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    </div>
    <div class="flex items-center gap-3">
      <button id="newNoteBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
        <i class="fa-solid fa-plus mr-2"></i> New Note
      </button>
      <button id="signoutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="container max-w-6xl mx-auto p-6 mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">

  <!-- LEFT: Notes List -->
  <aside class="lg:col-span-1 bg-white rounded-2xl shadow-lg p-4 h-[70vh] overflow-y-auto">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-bold text-indigo-700">Your Notes</h2>
      <input id="searchInput" type="search" placeholder="Search..." class="px-2 py-1 border rounded-lg" />
    </div>

    <div id="notesList" class="space-y-3">
      <p class="text-gray-500 italic text-center">Loading notes...</p>
    </div>
  </aside>

  <!-- RIGHT: Viewer / Editor -->
  <main class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 h-[70vh] overflow-y-auto">
    <div id="emptyView" class="h-full flex flex-col items-center justify-center text-center text-gray-500">
      <i class="fa-solid fa-sticky-note text-6xl text-indigo-200 mb-4"></i>
      <p class="text-xl font-semibold">Select a note or create a new one</p>
      <p class="text-sm mt-2">Your notes sync automatically with the cloud.</p>
    </div>

    <div id="noteView" class="hidden">
      <!-- Display mode -->
      <div id="displayMode" class="">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h3 id="viewTitle" class="text-2xl font-bold text-indigo-800"></h3>
            <p id="viewDate" class="text-xs text-gray-400 mt-1"></p>
          </div>
          <div class="flex gap-2">
            <button id="editBtn" class="px-3 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Edit</button>
            <button id="deleteBtn" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
          </div>
        </div>

        <div class="mt-4">
          <p id="viewText" class="whitespace-pre-wrap text-gray-800"></p>

          <div id="viewLinks" class="mt-4 space-y-1"></div>
          <div id="viewFiles" class="mt-4 space-y-1"></div>
        </div>
      </div>

      <!-- Edit mode -->
      <div id="editMode" class="hidden">
        <div class="flex items-center justify-between gap-4">
          <h3 class="text-xl font-bold text-indigo-700">Edit Note</h3>
          <div class="flex gap-2">
            <button id="saveBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
            <button id="cancelBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
          </div>
        </div>

        <div class="mt-4 space-y-3">
          <input id="editTitle" class="w-full p-3 border rounded-md" placeholder="Title" />
          <textarea id="editText" rows="8" class="w-full p-3 border rounded-md" placeholder="Write your note..."></textarea>

          <!-- Links area -->
          <div>
            <label class="font-semibold text-gray-700">Links</label>
            <div class="flex gap-2 mt-2">
              <input id="linkInput" type="url" placeholder="Paste link and click Add" class="flex-1 p-2 border rounded-md" />
              <button id="addLinkBtn" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Add Link</button>
            </div>
            <div id="linksList" class="mt-2 space-y-2"></div>
          </div>

          <!-- Files area -->
          <div>
            <label class="font-semibold text-gray-700">Files (multiple)</label>
            <input id="fileInput" type="file" multiple class="mt-2" />
            <div id="filesList" class="mt-3 space-y-2"></div>
            <p class="text-xs text-gray-400 mt-2">Each file must be ‚â§ 20 MB. Files are uploaded to Firebase Storage and saved to the note.</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Toast / status -->
<div id="toast" class="fixed bottom-6 right-6 hidden bg-black text-white px-4 py-2 rounded-md shadow-lg"></div>

<!-- FIREBASE + LOGIC -->
<script type="module">
/* ========== CONFIG ========== */
/* Replace with your firebase config (or inject as you prefer) */
const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, collection, doc, onSnapshot, addDoc, setDoc,
  updateDoc, deleteDoc, query, orderBy
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

/* ========== Constants ========== */
const MAX_FILE_BYTES = 20 * 1024 * 1024; // 20 MB

/* ========== Init ========== */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ========== UI Refs ========== */
const notesList = document.getElementById('notesList');
const searchInput = document.getElementById('searchInput');
const newNoteBtn = document.getElementById('newNoteBtn');
const signoutBtn = document.getElementById('signoutBtn');

const emptyView = document.getElementById('emptyView');
const noteView = document.getElementById('noteView');

const displayMode = document.getElementById('displayMode');
const editMode = document.getElementById('editMode');

const viewTitle = document.getElementById('viewTitle');
const viewDate = document.getElementById('viewDate');
const viewText = document.getElementById('viewText');
const viewLinks = document.getElementById('viewLinks');
const viewFiles = document.getElementById('viewFiles');

const editTitle = document.getElementById('editTitle');
const editText = document.getElementById('editText');
const linkInput = document.getElementById('linkInput');
const addLinkBtn = document.getElementById('addLinkBtn');
const linksList = document.getElementById('linksList');

const fileInput = document.getElementById('fileInput');
const filesList = document.getElementById('filesList');

const editBtn = document.getElementById('editBtn');
const deleteBtn = document.getElementById('deleteBtn');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');

const toastEl = document.getElementById('toast');

/* ========== State ========== */
let currentUser = null;
let notesSnapshotUnsub = null;
let notes = []; // local cache array of { id, ...data }
let selectedNoteId = null;
let isEditing = false;

/* Local staged arrays for edit mode */
let stagedLinks = []; // array of strings
let stagedFilesToUpload = []; // File objects selected but not yet uploaded
let stagedExistingFiles = []; // [{name, url}] existing files that remain or to delete

/* ========== Helpers ========== */
function showToast(msg, timeout = 3000) {
  toastEl.textContent = msg;
  toastEl.classList.remove('hidden');
  setTimeout(()=> toastEl.classList.add('hidden'), timeout);
}

function formatDate(ts) {
  try {
    const d = ts?.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString();
  } catch(e){
    return '';
  }
}

/* Creates note list item DOM */
function createNoteListItem(note) {
  const div = document.createElement('div');
  div.className = 'p-3 rounded-lg border border-gray-100 hover:shadow-md note-item cursor-pointer flex justify-between items-start gap-2';
  const left = document.createElement('div');
  left.className = 'flex-1 min-w-0';
  const title = document.createElement('div');
  title.className = 'font-semibold text-indigo-700 truncate';
  title.textContent = note.title || 'Untitled';
  const preview = document.createElement('div');
  preview.className = 'text-sm text-gray-500 truncate';
  const textPreview = (note.text || '').slice(0,120);
  preview.textContent = textPreview + (note.text && note.text.length > 120 ? '‚Ä¶' : '');
  left.appendChild(title);
  left.appendChild(preview);

  const right = document.createElement('div');
  right.className = 'text-right text-xs text-gray-400';
  right.textContent = formatDate(note.createdAt || note.updatedAt || new Date());

  div.appendChild(left);
  div.appendChild(right);

  div.onclick = () => {
    selectNote(note.id);
  };

  return div;
}

/* ========== Rendering ========== */

function renderNotesList(filter = '') {
  notesList.innerHTML = '';
  const filtered = notes.filter(n => {
    const s = (n.title + ' ' + (n.text || '')).toLowerCase();
    return s.includes(filter.toLowerCase());
  });
  if (filtered.length === 0) {
    notesList.innerHTML = '<p class="text-gray-500 italic text-center">No notes found.</p>';
    return;
  }
  filtered.forEach(n => notesList.appendChild(createNoteListItem(n)));
}

function showNotePanel(show) {
  if (show) {
    emptyView.classList.add('hidden');
    noteView.classList.remove('hidden');
  } else {
    emptyView.classList.remove('hidden');
    noteView.classList.add('hidden');
  }
}

/* Display mode render */
function renderSelectedNote() {
  const note = notes.find(n => n.id === selectedNoteId);
  if (!note) { showNotePanel(false); return; }
  showNotePanel(true);
  displayMode.classList.remove('hidden');
  editMode.classList.add('hidden');
  isEditing = false;
  // populate display
  viewTitle.textContent = note.title || 'Untitled';
  viewDate.textContent = formatDate(note.createdAt || note.updatedAt || new Date());
  viewText.textContent = note.text || '';

  // links
  viewLinks.innerHTML = '';
  const links = note.links || [];
  if (links.length) {
    const heading = document.createElement('h4');
    heading.className = 'font-semibold text-gray-700';
    heading.textContent = 'Links';
    viewLinks.appendChild(heading);
    links.forEach(l => {
      const p = document.createElement('p');
      p.className = 'text-sm';
      const a = document.createElement('a');
      a.href = /^https?:\/\//i.test(l) ? l : ('https://' + l);
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.className = 'text-indigo-600 hover:text-indigo-800 underline';
      a.textContent = l;
      p.appendChild(a);
      viewLinks.appendChild(p);
    });
  }

  // files
  viewFiles.innerHTML = '';
  const files = note.files || [];
  if (files.length) {
    const heading = document.createElement('h4');
    heading.className = 'font-semibold text-gray-700';
    heading.textContent = 'Files';
    viewFiles.appendChild(heading);
    files.forEach(f => {
      const p = document.createElement('p');
      p.className = 'text-sm';
      const a = document.createElement('a');
      a.href = f.url;
      a.textContent = f.name;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.className = 'text-indigo-600 hover:text-indigo-800 underline';
      p.appendChild(a);
      viewFiles.appendChild(p);
    });
  }
}

/* ========== Selecting / Snapshot ========== */

function selectNote(id) {
  selectedNoteId = id;
  renderSelectedNote();
}

/* ========== Firestore / Storage logic ========== */

function listenToNotesForUser(uid) {
  // unsubscribe previous
  if (notesSnapshotUnsub) notesSnapshotUnsub();

  const notesRef = collection(db, 'users', uid, 'daily_notes');
  const q = query(notesRef, orderBy('createdAt', 'desc'));
  notesSnapshotUnsub = onSnapshot(q, snapshot => {
    notes = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    renderNotesList(searchInput.value || '');
    // If selected note still exists, refresh display
    if (selectedNoteId) {
      const exists = notes.some(n => n.id === selectedNoteId);
      if (!exists) {
        selectedNoteId = null;
        showNotePanel(false);
      } else {
        renderSelectedNote();
      }
    }
  }, err => {
    console.error('Notes listener error:', err);
    showToast('Failed to load notes (see console)', 4000);
  });
}

/* Create a new blank note and open edit mode */
async function createNewNote() {
  if (!currentUser) return;
  const notesRef = collection(db, 'users', currentUser.uid, 'daily_notes');
  // create a basic doc with timestamps so we have an id for uploads
  const newDocRef = doc(notesRef); // create random id reference
  const id = newDocRef.id;
  const now = new Date();
  await setDoc(newDocRef, {
    title: 'New note',
    text: '',
    links: [],
    files: [],
    createdAt: now,
    updatedAt: now
  });
  // select and go to edit
  selectedNoteId = id;
  // Small delay to allow snapshot to reflect; will be handled by listener too
  setTimeout(() => enterEditMode(), 200);
}

/* Enter edit mode for selectedNoteId */
function enterEditMode() {
  if (!selectedNoteId) return;
  const note = notes.find(n => n.id === selectedNoteId);
  if (!note) return;
  // staged copies
  stagedLinks = Array.isArray(note.links) ? [...note.links] : [];
  stagedExistingFiles = Array.isArray(note.files) ? [...note.files] : [];
  stagedFilesToUpload = [];

  // populate edit UI
  editTitle.value = note.title || '';
  editText.value = note.text || '';
  renderLinksList();
  renderFilesList();

  // Show edit mode
  displayMode.classList.add('hidden');
  editMode.classList.remove('hidden');
  isEditing = true;
}

/* Render staged links as removable chips */
function renderLinksList() {
  linksList.innerHTML = '';
  if (stagedLinks.length === 0) {
    linksList.innerHTML = '<p class="text-sm text-gray-500 italic">No links added yet.</p>';
    return;
  }
  stagedLinks.forEach((l, idx) => {
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between gap-2 bg-gray-50 border p-2 rounded-md';
    const a = document.createElement('a');
    a.href = /^https?:\/\//i.test(l) ? l : ('https://' + l);
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = l;
    a.className = 'text-indigo-600 hover:underline truncate';
    const rm = document.createElement('button');
    rm.className = 'text-red-500 px-2';
    rm.textContent = 'Remove';
    rm.onclick = () => {
      stagedLinks.splice(idx, 1);
      renderLinksList();
    };
    div.appendChild(a);
    div.appendChild(rm);
    linksList.appendChild(div);
  });
}

/* Render staged files (existing + newly selected) */
function renderFilesList() {
  filesList.innerHTML = '';
  // existing files
  if (stagedExistingFiles.length) {
    const heading = document.createElement('div');
    heading.className = 'text-sm font-semibold mb-1';
    heading.textContent = 'Existing files';
    filesList.appendChild(heading);
    stagedExistingFiles.forEach((f, idx) => {
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between gap-2 p-2 bg-gray-50 rounded-md';
      const left = document.createElement('div'); left.className = 'truncate';
      const a = document.createElement('a');
      a.href = f.url; a.textContent = f.name; a.target = '_blank'; a.rel = 'noopener noreferrer';
      a.className = 'text-indigo-600 hover:underline';
      left.appendChild(a);
      const rm = document.createElement('button');
      rm.className = 'text-red-500 px-2';
      rm.textContent = 'Remove';
      rm.onclick = () => {
        // Remove existing file (and schedule deletion from storage)
        // We'll delete it immediately from Storage when user saves or we can delete immediately.
        // Here we remove from stagedExistingFiles and mark to delete on save
        stagedExistingFiles.splice(idx, 1);
        renderFilesList();
      };
      row.appendChild(left);
      row.appendChild(rm);
      filesList.appendChild(row);
    });
  }

  // new files to upload
  if (stagedFilesToUpload.length) {
    const heading = document.createElement('div');
    heading.className = 'text-sm font-semibold mt-3 mb-1';
    heading.textContent = 'New files to upload';
    filesList.appendChild(heading);
    stagedFilesToUpload.forEach((f, idx) => {
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between gap-2 p-2 bg-gray-50 rounded-md';
      const left = document.createElement('div'); left.className = 'truncate';
      left.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
      const rm = document.createElement('button');
      rm.className = 'text-red-500 px-2';
      rm.textContent = 'Remove';
      rm.onclick = () => {
        stagedFilesToUpload.splice(idx, 1);
        renderFilesList();
      };
      row.appendChild(left);
      row.appendChild(rm);
      filesList.appendChild(row);
    });
  }
}

/* Upload a single file to Storage with path users/{uid}/daily_notes/{noteId}/{filename} */
async function uploadSingleFile(file, uid, noteId) {
  const path = `users/${uid}/daily_notes/${noteId}/${file.name.replace(/\s+/g,'_')}`;
  const storageRef = ref(storage, path);
  await uploadBytes(storageRef, file);
  const url = await getDownloadURL(storageRef);
  return { name: file.name, url };
}

/* Save edits (append uploaded files to existing files, update links/title/text) */
async function saveEdits() {
  if (!currentUser || !selectedNoteId) return showToast('No user or note selected');

  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';
  try {
    const noteRef = doc(db, 'users', currentUser.uid, 'daily_notes', selectedNoteId);
    // 1. Upload new files (if any)
    const uploadedObjects = [];
    for (const file of stagedFilesToUpload) {
      if (file.size > MAX_FILE_BYTES) {
        throw new Error(`File ${file.name} exceeds ${MAX_FILE_BYTES/(1024*1024)} MB limit`);
      }
      const obj = await uploadSingleFile(file, currentUser.uid, selectedNoteId);
      uploadedObjects.push(obj);
    }

    // 2. The final file list is stagedExistingFiles + uploadedObjects
    const finalFiles = [...stagedExistingFiles, ...uploadedObjects];

    // 3. Normalize links (no need to force https in storage; display keeps original)
    const finalLinks = stagedLinks.map(l => l.trim()).filter(Boolean);

    // 4. Update Firestore doc
    await updateDoc(noteRef, {
      title: editTitle.value.trim(),
      text: editText.value,
      links: finalLinks,
      files: finalFiles,
      updatedAt: new Date()
    });

    // reset staged
    stagedFilesToUpload = [];
    showToast('Saved');
    // leave edit mode
    isEditing = false;
    // display mode render will update from listener
    editMode.classList.add('hidden');
    displayMode.classList.remove('hidden');
  } catch (err) {
    console.error('Save error', err);
    showToast('Save failed: ' + (err.message || err), 5000);
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save';
  }
}

/* Delete note and its files from Storage */
async function deleteCurrentNote() {
  if (!currentUser || !selectedNoteId) return;
  if (!confirm('Delete this note and its files? This cannot be undone.')) return;
  try {
    const noteRef = doc(db, 'users', currentUser.uid, 'daily_notes', selectedNoteId);
    // fetch doc to get file list
    const snapshot = await noteRef.get ? await noteRef.get() : null;
    // Because using modular SDK, getDoc preferred
    // But to avoid importing getDoc repeatedly, do:
    // (we'll import getDoc at top if needed). Use getDoc now:
    const { getDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
    const docSnap = await getDoc(noteRef);
    const data = docSnap.data();
    const files = data?.files || [];
    // delete each file in storage
    for (const f of files) {
      const path = `users/${currentUser.uid}/daily_notes/${selectedNoteId}/${f.name.replace(/\s+/g,'_')}`;
      try {
        const fileRef = ref(storage, path);
        await deleteObject(fileRef);
      } catch (e) {
        console.warn('Could not delete file from storage', e);
      }
    }
    // delete firestore doc
    await deleteDoc(noteRef);
    selectedNoteId = null;
    showToast('Note deleted');
  } catch (err) {
    console.error('Delete error', err);
    showToast('Delete failed: ' + (err.message || ''), 5000);
  }
}

/* ========== Event wiring ========== */

newNoteBtn.onclick = () => createNewNote();
signoutBtn.onclick = () => signOut(auth);

searchInput.oninput = (e) => renderNotesList(e.target.value);

// add link action in edit mode
addLinkBtn.onclick = () => {
  const v = (linkInput.value || '').trim();
  if (!v) return;
  stagedLinks.push(v);
  linkInput.value = '';
  renderLinksList();
};

// file input change handler
fileInput.onchange = (e) => {
  const files = Array.from(e.target.files || []);
  for (const f of files) {
    if (f.size > MAX_FILE_BYTES) {
      showToast(`File "${f.name}" exceeds 20MB and was not added`, 4000);
      continue;
    }
    stagedFilesToUpload.push(f);
  }
  renderFilesList();
};

// edit / cancel / save / delete
editBtn.onclick = () => enterEditMode();
cancelBtn.onclick = () => {
  // simply return to display mode (staged changes discarded)
  isEditing = false;
  editMode.classList.add('hidden');
  displayMode.classList.remove('hidden');
};
saveBtn.onclick = () => saveEdits();
deleteBtn.onclick = () => deleteCurrentNote();

/* ========== Authentication state & listener start ========== */
onAuthStateChanged(auth, user => {
  if (!user) {
    // not signed in -> redirect to login or show message
    // If you want automatic anonymous sign-in, implement here.
    window.location.href = 'index.html';
    return;
  }
  currentUser = user;
  listenToNotesForUser(user.uid);
});

/* ========== Utility: initial UI state ========== */
showNotePanel(false);
renderNotesList();

/* ========== End of module ========== */
</script>
</body>
</html>