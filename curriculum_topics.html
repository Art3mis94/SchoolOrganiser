<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curriculum | Educator Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .open { max-height: 5000px; transition: max-height 0.5s ease-in; }
    .rotate-icon { transform: rotate(180deg); }
    .year-card { border-radius: 2rem; background: white; border: 1px solid #e5e7eb; margin-bottom: 1.5rem; }
    .class-card { border-left: 5px solid #10b981; margin-bottom: 1rem; }
  </style>
</head>
<body>

<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-5xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="topics.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-5xl mx-auto px-4 mt-10 pb-24">
  <div class="flex justify-between items-end mb-8">
      <h1 class="text-4xl font-black text-gray-900 uppercase">Curriculum</h1>
      <button onclick="openModal('yearGroup')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg">
          + New Year
      </button>
  </div>
  
  <div id="yearGroupContainer" class="space-y-4"></div>
</div>

<div id="universalModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden p-4">
  <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
    <h3 id="modalTitle" class="text-2xl font-black mb-6 uppercase italic">Add Item</h3>
    <form id="universalForm" class="space-y-4">
      <input type="text" id="mainInput" placeholder="Name" class="w-full p-4 border rounded-2xl outline-none focus:border-indigo-500" required>
      <div id="lessonExtras" class="hidden space-y-4">
          <textarea id="subInput" placeholder="Objectives" class="w-full p-4 border rounded-2xl"></textarea>
          <input type="file" id="fileInput" class="text-sm">
      </div>
      <div class="flex gap-2">
        <button type="button" onclick="closeModal()" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold">Cancel</button>
        <button type="submit" id="saveBtn" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold">Save</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDocs, query, orderBy, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let currentUser, activeYearId, activeClassId, activeTopicId, modalMode;

onAuthStateChanged(auth, user => { 
    if(user){ currentUser = user; loadYearGroups(); } 
    else { window.location.href = 'index.html'; }
});

// --- PERFORMANCE FIX: Fetch once instead of constant listening ---

async function loadYearGroups() {
    const q = query(collection(db, 'users', currentUser.uid, 'yearGroups'), orderBy('createdAt', 'asc'));
    const snap = await getDocs(q);
    const container = document.getElementById('yearGroupContainer');
    container.innerHTML = '';
    snap.forEach(d => {
        const yr = {id: d.id, ...d.data()};
        const div = document.createElement('div');
        div.className = "year-card overflow-hidden";
        div.innerHTML = `
            <div class="p-6 flex justify-between items-center cursor-pointer" onclick="handleYearToggle('${yr.id}')">
                <h2 class="text-3xl font-black text-indigo-900 uppercase italic">${yr.name}</h2>
                <i id="icon-year-${yr.id}" class="fa-solid fa-chevron-down text-indigo-300"></i>
            </div>
            <div id="year-${yr.id}" class="collapsible-content">
                <div class="p-6 bg-gray-50 border-t">
                    <div class="flex justify-between mb-4">
                        <span class="text-xs font-bold text-gray-400 uppercase">Classes</span>
                        <button onclick="openModal('class', '${yr.id}')" class="text-indigo-600 text-xs font-bold">+ Add Class</button>
                    </div>
                    <div id="classes-for-${yr.id}" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>`;
        container.appendChild(div);
    });
}

window.handleYearToggle = async (id) => {
    const el = document.getElementById(`year-${id}`);
    const isOpen = el.classList.toggle('open');
    document.getElementById(`icon-year-${id}`).classList.toggle('rotate-icon');
    if(isOpen) {
        const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', id, 'classes'), orderBy('createdAt', 'asc'));
        const snap = await getDocs(q);
        const list = document.getElementById(`classes-for-${id}`);
        list.innerHTML = '';
        snap.forEach(d => {
            const cls = {id: d.id, ...d.data()};
            const cDiv = document.createElement('div');
            cDiv.className = "bg-white p-4 rounded-xl shadow-sm class-card";
            cDiv.innerHTML = `
                <div class="flex justify-between items-center cursor-pointer" onclick="handleClassToggle('${id}', '${cls.id}')">
                    <span class="font-bold text-emerald-800">${cls.name}</span>
                    <button onclick="event.stopPropagation(); openModal('topic', '${id}', '${cls.id}')" class="text-emerald-500 text-[10px] font-bold">+ Topic</button>
                </div>
                <div id="class-${cls.id}" class="collapsible-content mt-2 space-y-2"></div>`;
            list.appendChild(cDiv);
        });
    }
};

window.handleClassToggle = async (yrId, clsId) => {
    const el = document.getElementById(`class-${clsId}`);
    const isOpen = el.classList.toggle('open');
    if(isOpen) {
        const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', yrId, 'classes', clsId, 'topics'), orderBy('createdAt', 'asc'));
        const snap = await getDocs(q);
        el.innerHTML = '';
        snap.forEach(d => {
            const top = {id: d.id, ...d.data()};
            const tDiv = document.createElement('div');
            tDiv.className = "p-2 bg-gray-50 rounded-lg border";
            tDiv.innerHTML = `
                <div class="flex justify-between items-center cursor-pointer" onclick="handleTopicToggle('${yrId}', '${clsId}', '${top.id}')">
                    <span class="text-xs font-bold text-gray-600">${top.name}</span>
                    <button onclick="event.stopPropagation(); openModal('lesson', '${yrId}', '${clsId}', '${top.id}')" class="text-indigo-400 text-[10px]">+ Lesson</button>
                </div>
                <div id="topic-${top.id}" class="collapsible-content space-y-1 mt-2"></div>`;
            el.appendChild(tDiv);
        });
    }
};

window.handleTopicToggle = async (yrId, clsId, topId) => {
    const el = document.getElementById(`topic-${topId}`);
    const isOpen = el.classList.toggle('open');
    if(isOpen) {
        const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', yrId, 'classes', clsId, 'topics', topId, 'lessons'), orderBy('createdAt', 'asc'));
        const snap = await getDocs(q);
        el.innerHTML = '';
        snap.forEach(d => {
            const les = d.data();
            const lDiv = document.createElement('div');
            lDiv.className = "text-[10px] p-2 bg-white rounded border flex justify-between";
            lDiv.innerHTML = `<span>${les.title}</span> ${les.fileUrl ? `<a href="${les.fileUrl}" target="_blank" class="text-indigo-600 font-bold">File</a>` : ''}`;
            el.appendChild(lDiv);
        });
    }
};

// --- Modal & Form (Sync Optimized) ---

window.openModal = (mode, yr=null, cls=null, top=null) => {
    modalMode = mode; activeYearId = yr; activeClassId = cls; activeTopicId = top;
    document.getElementById('lessonExtras').classList.toggle('hidden', mode !== 'lesson');
    document.getElementById('universalModal').classList.remove('hidden');
};

document.getElementById('universalForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.innerText = "Syncing...";
    
    let path;
    const data = { createdAt: serverTimestamp(), name: document.getElementById('mainInput').value };

    if(modalMode === 'yearGroup') path = collection(db, 'users', currentUser.uid, 'yearGroups');
    else if(modalMode === 'class') path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes');
    else if(modalMode === 'topic') path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes', activeClassId, 'topics');
    else if(modalMode === 'lesson') {
        path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes', activeClassId, 'topics', activeTopicId, 'lessons');
        data.title = data.name; delete data.name;
        data.content = document.getElementById('subInput').value;
        const file = document.getElementById('fileInput').files[0];
        if(file) {
            const sRef = ref(storage, `curriculum/${currentUser.uid}/${Date.now()}`);
            await uploadBytes(sRef, file);
            data.fileUrl = await getDownloadURL(sRef);
        }
    }

    await addDoc(path, data);
    closeModal();
    btn.disabled = false; btn.innerText = "Save";
    loadYearGroups(); // Refresh after add
};

window.closeModal = () => document.getElementById('universalModal').classList.add('hidden');
document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => window.location.href = 'index.html');
</script>
</body>
</html>
