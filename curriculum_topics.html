<script type="module">
import { auth, db } from './firebase-config.js';
import { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

let currentUser = null;

// UI refs
const topicModal = document.getElementById('topicModal');
const lessonModal = document.getElementById('lessonModal');
const topicForm = document.getElementById('topicForm');
const topicName = document.getElementById('topicName');
const lessonForm = document.getElementById('lessonForm');
const lessonTitle = document.getElementById('lessonTitle');
const lessonContent = document.getElementById('lessonContent');
const lessonFilesContainer = document.getElementById('lessonFilesContainer');
const lessonLinksContainer = document.getElementById('lessonLinksContainer');
const newTopicBtn = document.getElementById('newTopicBtn');
const closeTopicModal = document.getElementById('closeTopicModal');
const closeLessonModal = document.getElementById('closeLessonModal');
const addFileBtn = document.getElementById('addFileBtn');
const addLinkBtn = document.getElementById('addLinkBtn');

let editingTopicId = null;
let editingLessonId = null;
let currentTopicId = null;

// Firestore reference
function topicsRef() {
    return collection(db, 'users', currentUser.uid, 'topics');
}

// Auth guard
onAuthStateChanged(auth, user => {
    if (!user) window.location.href = 'login.html';
    currentUser = user;
    loadTopics();
});

// Logout
document.getElementById('logoutBtn').onclick = async () => { 
    await signOut(auth); 
    window.location.href = 'login.html'; 
};

// Modal controls
newTopicBtn.onclick = () => { editingTopicId = null; topicForm.reset(); topicModal.classList.remove('hidden'); };
closeTopicModal.onclick = () => topicModal.classList.add('hidden');
closeLessonModal.onclick = () => lessonModal.classList.add('hidden');

// Add dynamic file/link inputs
addFileBtn.onclick = () => {
    const div = document.createElement('div');
    div.className = 'flex gap-2';
    div.innerHTML = `<input type="text" placeholder="File URL" class="flex-1 p-2 border rounded-md" required>
                     <button type="button" class="removeBtn text-red-600 px-2">Remove</button>`;
    lessonFilesContainer.appendChild(div);
    div.querySelector('.removeBtn').onclick = () => div.remove();
};

addLinkBtn.onclick = () => {
    const div = document.createElement('div');
    div.className = 'flex gap-2';
    div.innerHTML = `<input type="url" placeholder="Link URL" class="flex-1 p-2 border rounded-md" required>
                     <button type="button" class="removeBtn text-red-600 px-2">Remove</button>`;
    lessonLinksContainer.appendChild(div);
    div.querySelector('.removeBtn').onclick = () => div.remove();
};

// Load topics and lessons
function loadTopics() {
    const q = query(topicsRef(), orderBy('createdAt', 'asc'));
    onSnapshot(q, snapshot => {
        const topicTree = document.getElementById('topicTree');
        topicTree.innerHTML = '';
        snapshot.docs.forEach(docSnap => {
            const topic = { ...docSnap.data(), id: docSnap.id };
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl shadow hover:shadow-lg transition';
            div.innerHTML = `
                <div class="flex justify-between items-center p-4 cursor-pointer">
                  <h3 class="font-bold text-indigo-700">${topic.name}</h3>
                  <div class="flex gap-2">
                    <button class="addLessonBtn text-green-600"><i class="fa-solid fa-book-medical"></i></button>
                    <button class="editTopicBtn text-blue-600"><i class="fa-solid fa-pen"></i></button>
                    <button class="deleteTopicBtn text-red-600"><i class="fa-solid fa-trash"></i></button>
                    <button class="collapseBtn text-gray-600"><i class="fa-solid fa-chevron-down"></i></button>
                  </div>
                </div>
                <div class="lessonContainer px-4 py-2 space-y-2 hidden"></div>
            `;
            topicTree.appendChild(div);

            const collapseBtn = div.querySelector('.collapseBtn');
            const lessonContainer = div.querySelector('.lessonContainer');
            collapseBtn.onclick = () => {
                lessonContainer.classList.toggle('hidden');
                collapseBtn.querySelector('i').classList.toggle('fa-chevron-down');
                collapseBtn.querySelector('i').classList.toggle('fa-chevron-up');
            };

            // Topic buttons
            div.querySelector('.editTopicBtn').onclick = () => {
                editingTopicId = topic.id; topicName.value = topic.name; topicModal.classList.remove('hidden');
            };
            div.querySelector('.deleteTopicBtn').onclick = async () => {
                if (confirm('Delete this topic?')) await deleteDoc(doc(topicsRef(), topic.id));
            };
            div.querySelector('.addLessonBtn').onclick = () => {
                editingLessonId = null; currentTopicId = topic.id; lessonForm.reset();
                lessonFilesContainer.innerHTML = ''; lessonLinksContainer.innerHTML = '';
                lessonModal.classList.remove('hidden');
            };

            // Load lessons
            const lessonsRef = collection(topicsRef(), topic.id, 'lessons');
            onSnapshot(query(lessonsRef, orderBy('createdAt', 'asc')), snap => {
                lessonContainer.innerHTML = '';
                snap.docs.forEach(lDoc => {
                    const lesson = { ...lDoc.data(), id: lDoc.id };
                    const lDiv = document.createElement('div');
                    lDiv.className = 'p-2 border rounded-lg flex flex-col gap-1 bg-indigo-50';
                    const filesHtml = (lesson.files || []).map(f => `<p class="text-purple-600"><a href="${f}" target="_blank">Open File</a></p>`).join('');
                    const linksHtml = (lesson.links || []).map(l => `<p class="text-blue-600"><a href="${l}" target="_blank">${l}</a></p>`).join('');
                    lDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                          <div>
                            <h4 class="font-semibold">${lesson.title}</h4>
                            <p class="text-gray-700 text-sm">${lesson.content||''}</p>
                            ${filesHtml}${linksHtml}
                          </div>
                          <div class="flex gap-1">
                            <button class="editLessonBtn text-blue-600"><i class="fa-solid fa-pen"></i></button>
                            <button class="deleteLessonBtn text-red-600"><i class="fa-solid fa-trash"></i></button>
                          </div>
                        </div>
                    `;
                    lessonContainer.appendChild(lDiv);

                    lDiv.querySelector('.editLessonBtn').onclick = () => {
                        editingLessonId = lesson.id; currentTopicId = topic.id;
                        lessonTitle.value = lesson.title; lessonContent.value = lesson.content || '';
                        lessonFilesContainer.innerHTML = ''; lessonLinksContainer.innerHTML = '';
                        (lesson.files || []).forEach(f => { addDynamicInput(lessonFilesContainer, f); });
                        (lesson.links || []).forEach(l => { addDynamicInput(lessonLinksContainer, l); });
                        lessonModal.classList.remove('hidden');
                    };
                    lDiv.querySelector('.deleteLessonBtn').onclick = async () => {
                        if (confirm('Delete this lesson?')) await deleteDoc(doc(lessonsRef, lesson.id));
                    };
                });
            });
        });
    });
}

// Helper for dynamically creating inputs
function addDynamicInput(container, value='') {
    const div = document.createElement('div');
    div.className = 'flex gap-2';
    div.innerHTML = `<input type="text" value="${value}" class="flex-1 p-2 border rounded-md" required>
                     <button type="button" class="removeBtn text-red-600 px-2">Remove</button>`;
    container.appendChild(div);
    div.querySelector('.removeBtn').onclick = () => div.remove();
}

// Topic form submit
topicForm.onsubmit = async e => {
    e.preventDefault();
    const data = { name: topicName.value, createdAt: new Date() };
    if (editingTopicId) await updateDoc(doc(topicsRef(), editingTopicId), data);
    else await addDoc(topicsRef(), data);
    topicForm.reset(); topicModal.classList.add('hidden');
};

// Lesson form submit
lessonForm.onsubmit = async e => {
    e.preventDefault();
    const files = [...lessonFilesContainer.querySelectorAll('input')].map(i => i.value).filter(v => v);
    const links = [...lessonLinksContainer.querySelectorAll('input')].map(i => i.value).filter(v => v);
    const data = { title: lessonTitle.value, content: lessonContent.value||'', files, links, createdAt: new Date() };
    const lessonsRef = collection(topicsRef(), currentTopicId, 'lessons');
    if (editingLessonId) await updateDoc(doc(lessonsRef, editingLessonId), data);
    else await addDoc(lessonsRef, data);
    lessonForm.reset(); lessonFilesContainer.innerHTML = ''; lessonLinksContainer.innerHTML = ''; lessonModal.classList.add('hidden');
};
</script>