<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curriculum Topics | Educator Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .open { max-height: 3000px; transition: max-height 0.5s ease-in; }
    .rotate-icon { transform: rotate(180deg); }
    .year-card { border-left: 6px solid #4f46e5; }
    .dropzone { border: 2px dashed #4f46e5; border-radius:0.5rem; padding:1rem; text-align:center; cursor:pointer; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-5xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="topics.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-5xl mx-auto p-6 mt-6">
  <h1 class="text-3xl font-bold text-indigo-700 mb-6">Curriculum by Year Group</h1>
  
  <div id="yearGroupContainer" class="space-y-6">
    </div>
</div>

<div id="topicModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
    <h3 id="topicModalTitle" class="text-2xl font-bold text-indigo-700 border-b pb-3 mb-4">Add Topic</h3>
    <form id="topicForm" class="space-y-4">
      <input type="text" id="topicName" placeholder="Topic Name (e.g. Algebra)" class="w-full p-2 border rounded-md" required>
      <div class="flex gap-2">
        <button type="button" onclick="closeModal('topicModal')" class="flex-1 py-2 bg-gray-200 rounded-lg">Cancel</button>
        <button type="submit" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save Topic</button>
      </div>
    </form>
  </div>
</div>

<div id="lessonModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
    <h3 class="text-2xl font-bold text-green-700 border-b pb-3 mb-4">Add Lesson</h3>
    <form id="lessonForm" class="space-y-4">
      <input type="text" id="lessonTitle" placeholder="Lesson Title" class="w-full p-2 border rounded-md" required>
      <textarea id="lessonContent" rows="3" placeholder="Learning outcomes..." class="w-full p-2 border rounded-md"></textarea>
      <div id="lessonDropzone" class="dropzone" onclick="document.getElementById('lessonFile').click()">
        <span id="fileLabel">Drag & Drop File or Click</span>
        <input type="file" id="lessonFile" class="hidden">
      </div>
      <input type="url" id="lessonLink" placeholder="External Link (URL)" class="w-full p-2 border rounded-md">
      <div class="flex gap-2">
        <button type="button" onclick="closeModal('lessonModal')" class="flex-1 py-2 bg-gray-200 rounded-lg">Cancel</button>
        <button type="submit" id="saveLessonBtn" class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save Lesson</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let currentUser = null;
let currentYear = null;
let currentTopicId = null;
let editingTopicId = null;

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    renderYearGroups();
  } else {
    window.location.href = 'index.html';
  }
});

// --- UI Logic ---
function renderYearGroups() {
  const container = document.getElementById('yearGroupContainer');
  container.innerHTML = '';
  [7, 8, 9, 10, 11].forEach(year => {
    const div = document.createElement('div');
    div.className = "bg-white rounded-xl shadow-md year-card overflow-hidden mb-4";
    div.innerHTML = `
      <div class="flex justify-between items-center p-5 bg-indigo-50 cursor-pointer" onclick="toggleSection('year-${year}')">
        <h2 class="text-2xl font-bold text-indigo-800">Year ${year}</h2>
        <div class="flex items-center gap-3">
          <button onclick="event.stopPropagation(); openTopicModal('${year}')" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-indigo-700">+ Add Topic</button>
          <i id="icon-year-${year}" class="fa-solid fa-chevron-down text-indigo-400 transition-transform"></i>
        </div>
      </div>
      <div id="year-${year}" class="collapsible-content">
        <div id="topics-list-${year}" class="p-4 space-y-4 bg-gray-50"></div>
      </div>
    `;
    container.appendChild(div);
    loadTopics(year);
  });
}

function loadTopics(year) {
  const q = query(collection(db, 'users', currentUser.uid, 'years', year.toString(), 'topics'), orderBy('createdAt', 'asc'));
  onSnapshot(q, snapshot => {
    const list = document.getElementById(`topics-list-${year}`);
    list.innerHTML = '';
    snapshot.forEach(docSnap => {
      const topic = { id: docSnap.id, ...docSnap.data() };
      const topicDiv = document.createElement('div');
      topicDiv.className = "bg-white border rounded-lg shadow-sm";
      topicDiv.innerHTML = `
        <div class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50" onclick="toggleSection('topic-${topic.id}')">
          <span class="font-bold text-gray-700">${topic.name}</span>
          <div class="flex items-center gap-3">
            <button onclick="event.stopPropagation(); openLessonModal('${year}', '${topic.id}')" class="text-green-600"><i class="fa-solid fa-plus-circle"></i></button>
            <button onclick="event.stopPropagation(); deleteTopic('${year}', '${topic.id}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
            <i id="icon-topic-${topic.id}" class="fa-solid fa-caret-down text-gray-400 transition-transform"></i>
          </div>
        </div>
        <div id="topic-${topic.id}" class="collapsible-content border-t bg-white">
          <div id="lessons-list-${topic.id}" class="p-4 space-y-2"></div>
        </div>
      `;
      list.appendChild(topicDiv);
      loadLessons(year, topic.id);
    });
  });
}

function loadLessons(year, topicId) {
  const q = query(collection(db, 'users', currentUser.uid, 'years', year.toString(), 'topics', topicId, 'lessons'), orderBy('createdAt', 'asc'));
  onSnapshot(q, snapshot => {
    const list = document.getElementById(`lessons-list-${topicId}`);
    list.innerHTML = snapshot.empty ? '<p class="text-gray-400 text-sm italic">No lessons added yet.</p>' : '';
    snapshot.forEach(lDoc => {
      const lesson = { id: lDoc.id, ...lDoc.data() };
      const item = document.createElement('div');
      item.className = "p-3 bg-indigo-50 border rounded-lg flex justify-between items-center";
      item.innerHTML = `
        <div>
          <h4 class="font-semibold text-gray-800">${lesson.title}</h4>
          <div class="flex gap-3 mt-1 text-sm">
            ${lesson.fileUrl ? `<a href="${lesson.fileUrl}" target="_blank" class="text-purple-600"><i class="fa-solid fa-file-pdf"></i> File</a>` : ''}
            ${lesson.link ? `<a href="${lesson.link}" target="_blank" class="text-blue-600"><i class="fa-solid fa-link"></i> Link</a>` : ''}
          </div>
        </div>
        <button onclick="deleteLesson('${year}', '${topicId}', '${lesson.id}')" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      `;
      list.appendChild(item);
    });
  });
}

// --- Sync Logic ---
document.getElementById('topicForm').onsubmit = async (e) => {
  e.preventDefault();
  const name = document.getElementById('topicName').value;
  await addDoc(collection(db, 'users', currentUser.uid, 'years', currentYear, 'topics'), { name, createdAt: new Date() });
  closeModal('topicModal');
};

document.getElementById('lessonForm').onsubmit = async (e) => {
  e.preventDefault();
  const btn = document.getElementById('saveLessonBtn');
  btn.disabled = true; btn.innerText = "Uploading...";

  let fileUrl = null;
  const file = document.getElementById('lessonFile').files[0];
  if (file) {
    const storageRef = ref(storage, `users/${currentUser.uid}/curriculum/${Date.now()}_${file.name}`);
    const snapshot = await uploadBytes(storageRef, file);
    fileUrl = await getDownloadURL(snapshot.ref);
  }

  const data = {
    title: document.getElementById('lessonTitle').value,
    content: document.getElementById('lessonContent').value,
    link: document.getElementById('lessonLink').value || null,
    fileUrl: fileUrl,
    createdAt: new Date()
  };

  await addDoc(collection(db, 'users', currentUser.uid, 'years', currentYear, 'topics', currentTopicId, 'lessons'), data);
  btn.disabled = false; btn.innerText = "Save Lesson";
  closeModal('lessonModal');
};

// --- Helpers ---
window.toggleSection = (id) => {
  const content = document.getElementById(id);
  const icon = document.getElementById('icon-' + id);
  content.classList.toggle('open');
  if (icon) icon.classList.toggle('rotate-icon');
};

window.openTopicModal = (year) => {
  currentYear = year;
  document.getElementById('topicForm').reset();
  document.getElementById('topicModal').classList.remove('hidden');
};

window.openLessonModal = (year, topicId) => {
  currentYear = year;
  currentTopicId = topicId;
  document.getElementById('lessonForm').reset();
  document.getElementById('fileLabel').innerText = "Drag & Drop File or Click";
  document.getElementById('lessonModal').classList.remove('hidden');
};

window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

window.deleteTopic = async (year, id) => { if (confirm("Delete this topic?")) await deleteDoc(doc(db, 'users', currentUser.uid, 'years', year, 'topics', id)); };

window.deleteLesson = async (year, tId, lId) => { if (confirm("Delete this lesson?")) await deleteDoc(doc(db, 'users', currentUser.uid, 'years', year, 'topics', tId, 'lessons', lId)); };

document.getElementById('logoutBtn').onclick = () => signOut(auth);

document.getElementById('lessonFile').onchange = (e) => { if (e.target.files[0]) document.getElementById('fileLabel').innerText = "Selected: " + e.target.files[0].name; };
</script>
</body>
</html>
