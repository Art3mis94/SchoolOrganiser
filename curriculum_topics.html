<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curriculum | Educator Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .open { max-height: 5000px; transition: max-height 0.5s ease-in; }
    .rotate-icon { transform: rotate(180deg); transition: 0.3s; }
    .year-card { border-left: 6px solid #4338ca; }
    .class-card { border-left: 4px solid #10b981; }
    .dropzone { border: 2px dashed #4338ca; border-radius: 1rem; padding: 1.5rem; text-align: center; cursor: pointer; background: #f5f3ff; }
  </style>
</head>
<body>

<nav class="bg-indigo-700 p-4 shadow-2xl">
  <div class="container max-w-5xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="topics.html" class="px-4 py-2 bg-white text-indigo-700 font-bold rounded-lg shadow-inner">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">To-Do ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Sign Out</button>
  </div>
</nav>

<div class="container max-w-5xl mx-auto p-6 mt-6 pb-24">
  <div class="flex justify-between items-end mb-8">
      <h1 class="text-4xl font-black text-indigo-900 uppercase tracking-tighter">Curriculum</h1>
      <button onclick="openModal('yearGroup')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg">+ New Year</button>
  </div>
  
  <div id="yearGroupContainer" class="space-y-6"></div>
</div>

<div id="universalModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden p-4">
  <div class="bg-white rounded-3xl w-full max-w-md p-8 shadow-2xl">
    <h3 id="modalTitle" class="text-2xl font-black mb-6 uppercase italic text-indigo-700">Add Item</h3>
    <form id="universalForm" class="space-y-4">
      <input type="text" id="mainInput" placeholder="Name" class="w-full p-4 border rounded-2xl outline-none focus:border-indigo-500" required>
      <div id="lessonExtras" class="hidden space-y-4">
          <textarea id="subInput" placeholder="Learning Outcomes" class="w-full p-4 border rounded-2xl"></textarea>
          <div class="dropzone" onclick="document.getElementById('fileInput').click()">
              <p id="fileStatus" class="text-sm font-bold text-indigo-900">Click to upload materials</p>
              <input type="file" id="fileInput" class="hidden">
          </div>
      </div>
      <div class="flex gap-2">
        <button type="button" onclick="closeModal()" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold">Cancel</button>
        <button type="submit" id="saveBtn" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-bold">Save</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDocs, query, orderBy, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let currentUser, activeYearId, activeClassId, activeTopicId, modalMode;

onAuthStateChanged(auth, user => { 
    if(user){ currentUser = user; loadYearGroups(); } 
    else { window.location.href = 'index.html'; }
});

// --- Level 1: Years ---
async function loadYearGroups() {
    const q = query(collection(db, 'users', currentUser.uid, 'yearGroups'), orderBy('createdAt', 'asc'));
    const snap = await getDocs(q);
    const container = document.getElementById('yearGroupContainer');
    container.innerHTML = '';
    snap.forEach(d => {
        const yr = {id: d.id, ...d.data()};
        const div = document.createElement('div');
        div.className = "bg-white rounded-2xl shadow-sm year-card overflow-hidden";
        div.innerHTML = `
            <div class="p-6 flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="toggleYear('${yr.id}')">
                <h2 class="text-2xl font-black text-indigo-900 uppercase">${yr.name}</h2>
                <div class="flex gap-4 items-center">
                    <button onclick="event.stopPropagation(); openModal('class', '${yr.id}')" class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-lg text-xs font-bold">+ Class</button>
                    <i id="icon-year-${yr.id}" class="fa-solid fa-chevron-down text-indigo-300"></i>
                </div>
            </div>
            <div id="year-${yr.id}" class="collapsible-content bg-gray-50 border-t">
                <div id="classes-for-${yr.id}" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>`;
        container.appendChild(div);
    });
}

window.toggleYear = async (id) => {
    const el = document.getElementById(`year-${id}`);
    const isOpen = el.classList.toggle('open');
    document.getElementById(`icon-year-${id}`).classList.toggle('rotate-icon');
    if(isOpen && document.getElementById(`classes-for-${id}`).innerHTML === '') {
        const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', id, 'classes'), orderBy('createdAt', 'asc'));
        const snap = await getDocs(q);
        const list = document.getElementById(`classes-for-${id}`);
        snap.forEach(d => {
            const cls = {id: d.id, ...d.data()};
            const cDiv = document.createElement('div');
            cDiv.className = "bg-white p-4 rounded-xl shadow-sm class-card";
            cDiv.innerHTML = `
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleClass('${id}', '${cls.id}')">
                    <span class="font-bold text-emerald-800">${cls.name}</span>
                    <button onclick="event.stopPropagation(); openModal('topic', '${id}', '${cls.id}')" class="text-emerald-500 text-[10px] font-bold">+ Topic</button>
                </div>
                <div id="class-${cls.id}" class="collapsible-content mt-3 space-y-3"></div>`;
            list.appendChild(cDiv);
        });
    }
};

window.toggleClass = async (yrId, clsId) => {
    const el = document.getElementById(`class-${clsId}`);
    const isOpen = el.classList.toggle('open');
    if(isOpen && el.innerHTML === '') {
        const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', yrId, 'classes', clsId, 'topics'), orderBy('createdAt', 'asc'));
        const snap = await getDocs(q);
        snap.forEach(d => {
            const top = {id: d.id, ...d.data()};
            const tDiv = document.createElement('div');
            tDiv.className = "p-3 bg-gray-50 rounded-lg border";
            tDiv.innerHTML = `
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleTopic('${yrId}', '${clsId}', '${top.id}')">
                    <span class="text-xs font-bold text-gray-700">${top.name}</span>
                    <button onclick="event.stopPropagation(); openModal('lesson', '${yrId}', '${clsId}', '${top.id}')" class="text-indigo-500 text-[10px]">+ Lesson</button>
                </div>
                <div id="topic-${top.id}" class="collapsible-content space-y-2 mt-2"></div>`;
            el.appendChild(tDiv);
        });
    }
};

window.toggleTopic = async (yrId, clsId, topId) => {
    const el = document.getElementById(`topic-${topId}`);
    const isOpen = el.classList.toggle('open');
    if(isOpen && el.innerHTML === '') {
        const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', yrId, 'classes', clsId, 'topics', topId, 'lessons'), orderBy('createdAt', 'asc'));
        const snap = await getDocs(q);
        snap.forEach(d => {
            const les = d.data();
            const lDiv = document.createElement('div');
            lDiv.className = "text-[11px] p-2 bg-white rounded border border-indigo-100 flex justify-between items-center";
            lDiv.innerHTML = `
                <span class="font-medium text-gray-800">${les.title}</span>
                <div class="flex gap-2">
                    ${les.fileUrl ? `<a href="${les.fileUrl}" target="_blank" class="text-indigo-600"><i class="fa-solid fa-file-arrow-down"></i></a>` : ''}
                    <button onclick="deleteDoc(doc(db, 'users', '${currentUser.uid}', 'lessons', '${d.id}'))" class="text-red-300"><i class="fa-solid fa-xmark"></i></button>
                </div>`;
            el.appendChild(lDiv);
        });
    }
};

// --- Modal Logic ---
window.openModal = (mode, yr=null, cls=null, top=null) => {
    modalMode = mode; activeYearId = yr; activeClassId = cls; activeTopicId = top;
    document.getElementById('modalTitle').innerText = "Add " + mode.replace(/([A-Z])/g, ' $1');
    document.getElementById('lessonExtras').classList.toggle('hidden', mode !== 'lesson');
    document.getElementById('universalModal').classList.remove('hidden');
};

document.getElementById('universalForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.innerText = "Syncing...";
    
    let path;
    const name = document.getElementById('mainInput').value;
    const data = { createdAt: serverTimestamp() };

    if(modalMode === 'yearGroup') { path = collection(db, 'users', currentUser.uid, 'yearGroups'); data.name = name; }
    else if(modalMode === 'class') { path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes'); data.name = name; }
    else if(modalMode === 'topic') { path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes', activeClassId, 'topics'); data.name = name; }
    else if(modalMode === 'lesson') {
        path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes', activeClassId, 'topics', activeTopicId, 'lessons');
        data.title = name; data.content = document.getElementById('subInput').value;
        const file = document.getElementById('fileInput').files[0];
        if(file) {
            const sRef = ref(storage, `curriculum/${currentUser.uid}/${Date.now()}`);
            await uploadBytes(sRef, file);
            data.fileUrl = await getDownloadURL(sRef);
        }
    }

    await addDoc(path, data);
    closeModal();
    btn.disabled = false; btn.innerText = "Save";
    loadYearGroups(); // Soft refresh
};

window.closeModal = () => document.getElementById('universalModal').classList.add('hidden');
document.getElementById('logoutBtn').onclick = () => signOut(auth);
document.getElementById('fileInput').onchange = (e) => { if(e.target.files[0]) document.getElementById('fileStatus').innerText = "Selected: " + e.target.files[0].name; };
</script>
</body>
</html>
