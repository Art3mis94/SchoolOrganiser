<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Educator Hub - Curriculum Topics</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
.nav-active { @apply bg-white text-indigo-700 shadow-inner; }
.topic-status-tag { @apply px-2 py-0.5 rounded-full text-xs font-semibold; }
.completed { @apply line-through text-gray-500; }
.lesson, .topic { @apply p-4 bg-white rounded-xl shadow hover:shadow-md transition; }
.subtopics { @apply ml-6 mt-2 space-y-2; }
button { @apply transition duration-200; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
<div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
    <a href="dashboard.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
    <a href="curriculum_topics.html" class="px-4 py-2 nav-active font-bold rounded-lg transition">Topics üß†</a>
    <a href="notes.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Notes üìù</a>
    <a href="todo.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">To-Do List ‚úÖ</a>
    <a href="resources.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
</div>
</nav>

<div class="container max-w-4xl mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-8 space-y-8">
<h1 class="text-3xl font-bold text-center text-gray-800">Curriculum Planner üß†</h1>
<p id="userIdDisplay" class="text-center text-gray-500 mb-4">User ID: Loading...</p>

<!-- Add Topic/Lesson Form -->
<div class="bg-indigo-50 p-6 rounded-xl shadow-inner">
<form id="addForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <input type="text" id="topicName" placeholder="Topic Name" class="p-3 border border-gray-300 rounded-lg">
    <input type="text" id="lessonTitle" placeholder="Lesson Title (Optional)" class="p-3 border border-gray-300 rounded-lg">
    <select id="parentTopic" class="p-3 border border-gray-300 rounded-lg col-span-1">
        <option value="">-- No Parent --</option>
    </select>
    <button type="submit" id="addBtn" class="p-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-md col-span-1">
        <i class="fa-solid fa-plus mr-2"></i> Add Item
    </button>
</form>
<p id="formMessage" class="mt-3 text-center font-medium hidden"></p>
</div>

<!-- Curriculum Display -->
<div id="curriculumTree" class="space-y-4 pt-4"></div>
</div>

<!-- Firebase Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userId = null;
let curriculumData = { topics: [], lessons: [] };

const userIdDisplay = document.getElementById('userIdDisplay');
const addForm = document.getElementById('addForm');
const topicNameInput = document.getElementById('topicName');
const lessonTitleInput = document.getElementById('lessonTitle');
const parentTopicSelect = document.getElementById('parentTopic');
const formMessage = document.getElementById('formMessage');
const curriculumTree = document.getElementById('curriculumTree');

const CURRICULUM_DOC_REF = (uid) => doc(db, 'artifacts', 'school-organiser-5f512', 'users', uid, 'curriculum_planner', 'curriculum_data');

function showMessage(element, message, isError = false){
    element.textContent = message;
    element.className = `mt-3 text-center font-medium p-2 rounded ${isError?'bg-red-200 text-red-800':'bg-green-200 text-green-800'}`;
    element.classList.remove('hidden');
    setTimeout(()=>element.classList.add('hidden'),5000);
}

function renderCurriculum() {
    curriculumTree.innerHTML = '';
    if(curriculumData.topics.length===0){
        curriculumTree.innerHTML='<p class="text-gray-500 italic text-center p-6">No topics added yet!</p>';
        return;
    }

    function buildTopicHTML(topic){
        const linkedLessons = curriculumData.lessons.filter(l => l.topicId === topic.id);
        return `
        <div class="topic">
            <div class="flex justify-between items-center pr-2">
                <div class="flex items-center gap-2">
                    <button onclick="toggleCompletion('${topic.id}','topic')" class="text-xl ${topic.completed?'text-green-500':'text-gray-300 hover:text-green-400'}">
                        <i class="fa-solid ${topic.completed?'fa-square-check':'fa-square'}"></i>
                    </button>
                    <span class="${topic.completed?'completed':'text-gray-800'} font-semibold">${topic.name}</span>
                    <span class="topic-status-tag ${topic.completed?'bg-green-100 text-green-700':'bg-indigo-100 text-indigo-700'}">${topic.completed?'Completed':'Active'}</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="deleteItem('${topic.id}','topic')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="subtopics">
                ${linkedLessons.map(l=>`
                <div class="lesson flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <button onclick="toggleCompletion('${l.id}','lesson')" class="text-lg ${l.completed?'text-green-500':'text-gray-300 hover:text-green-400'}">
                            <i class="fa-solid ${l.completed?'fa-check-circle':'fa-circle'}"></i>
                        </button>
                        <span class="${l.completed?'completed':'text-gray-700'}">${l.title}</span>
                    </div>
                    <button onclick="deleteItem('${l.id}','lesson')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash-can"></i></button>
                </div>`).join('')}
            </div>
        </div>
        `;
    }

    curriculumData.topics.forEach(t=>curriculumTree.innerHTML+=buildTopicHTML(t));
}

async function saveCurriculum(){
    if(!userId) return;
    await setDoc(CURRICULUM_DOC_REF(userId), curriculumData);
}

addForm.addEventListener('submit',async e=>{
    e.preventDefault();
    const topicName = topicNameInput.value.trim();
    const lessonTitle = lessonTitleInput.value.trim();
    const parentId = parentTopicSelect.value || null;
    const newId = Date.now().toString();

    if(topicName){
        const newTopic = {id:newId,name:topicName,completed:false};
        curriculumData.topics.push(newTopic);
        if(lessonTitle){
            curriculumData.lessons.push({id:newId+'-L',topicId:newId,title:lessonTitle,completed:false});
        }
        showMessage(formMessage,'Topic added!');
    } else if(lessonTitle && parentId){
        curriculumData.lessons.push({id:newId+'-L',topicId:parentId,title:lessonTitle,completed:false});
        showMessage(formMessage,'Lesson added!');
    } else {
        showMessage(formMessage,'Provide Topic or Lesson with parent.','true');
        return;
    }

    await saveCurriculum();
    addForm.reset();
    renderCurriculum();
});

window.deleteItem = async (id,type)=>{
    if(!confirm('Are you sure?')) return;
    if(type==='topic'){
        curriculumData.topics=curriculumData.topics.filter(t=>t.id!==id);
        curriculumData.lessons=curriculumData.lessons.filter(l=>l.topicId!==id);
    } else curriculumData.lessons=curriculumData.lessons.filter(l=>l.id!==id);
    await saveCurriculum();
    renderCurriculum();
};

window.toggleCompletion = async (id,type)=>{
    if(type==='topic'){
        const t = curriculumData.topics.find(t=>t.id===id);
        if(t) t.completed=!t.completed;
    } else {
        const l = curriculumData.lessons.find(l=>l.id===id);
        if(l) l.completed=!l.completed;
    }
    await saveCurriculum();
    renderCurriculum();
};

onAuthStateChanged(auth,user=>{
    if(user){
        userId=user.uid;
        userIdDisplay.textContent=`User ID: ${userId}`;
        onSnapshot(CURRICULUM_DOC_REF(userId),docSnap=>{
            if(docSnap.exists()) curriculumData=docSnap.data();
            else curriculumData={topics:[],lessons:[]};
            renderCurriculum();
        });
    } else userIdDisplay.textContent='User not authenticated';
});

signInAnonymously(auth);
</script>
</body>
</html>