<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Curriculum Topics & Lessons</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .nav-active { @apply bg-white text-indigo-700 shadow-inner; }
    .section-box { @apply bg-white p-5 rounded-xl shadow-lg border border-gray-200; }
    .lesson-box { @apply bg-indigo-50 border border-indigo-200 rounded-lg p-4 mt-2 shadow-sm; }
    .collapsible-header { @apply flex justify-between items-center cursor-pointer py-3; }
    .hidden-section { display: none; }
</style>
</head>
<body>

<!-- NAV BAR -->
<nav class="bg-indigo-700 p-4 shadow-2xl">
    <div class="container max-w-4xl mx-auto flex flex-wrap justify-center gap-4">
        <a href="dashboard.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Home üè†</a>
        <a href="curriculum_topics.html" class="px-4 py-2 nav-active font-bold rounded-lg transition">Topics üß†</a>
        <a href="notes.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Notes üìù</a>
        <a href="todo.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">To-Do List ‚úÖ</a>
        <a href="resources.html" class="px-4 py-2 text-white font-semibold rounded-lg hover:bg-indigo-600 transition">Tools üõ†Ô∏è</a>
    </div>
</nav>

<!-- PAGE CONTENT -->
<div class="container max-w-4xl mx-auto p-6 mt-8 space-y-8">

    <h1 class="text-3xl font-bold text-gray-800 text-center">Curriculum Topics & Lessons</h1>

    <!-- ADD TOPIC -->
    <div class="section-box">
        <div class="collapsible-header" onclick="toggleSection('addTopicSection')">
            <h2 class="text-xl font-bold text-indigo-700">+ Create New Topic</h2>
            <i class="fa-solid fa-chevron-down text-indigo-600"></i>
        </div>

        <div id="addTopicSection" class="hidden-section mt-4">
            <input id="topicTitleInput" type="text" placeholder="Topic title"
                class="w-full p-3 border rounded-lg mb-3">

            <button onclick="addTopic()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg font-semibold">
                Add Topic
            </button>
        </div>
    </div>

    <!-- TOPICS DISPLAY -->
    <div id="topicsList"></div>

</div>

<!-- FIREBASE LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
    getFirestore, collection, addDoc, doc, deleteDoc,
    updateDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userId = null;

function toggleSection(id){
    document.getElementById(id).classList.toggle("hidden-section");
}

/* --------------------------
      REALTIME TOPICS
---------------------------*/
onAuthStateChanged(auth, user => {
    if (!user) return (window.location = "index.html");

    userId = user.uid;

    const topicsRef = collection(db, "artifacts", "school-organiser-5f512", "users", userId, "curriculum_topics");

    onSnapshot(topicsRef, snap => {
        const list = document.getElementById("topicsList");
        list.innerHTML = "";

        snap.forEach(docSnap => {
            const data = docSnap.data();
            list.appendChild(renderTopic(docSnap.id, data));
        });
    });
});

/* --------------------------
        ADD TOPIC
---------------------------*/
async function addTopic() {
    const title = document.getElementById("topicTitleInput").value.trim();
    if (!title) return;

    const topicsRef = collection(db, "artifacts", "school-organiser-5f512", "users", userId, "curriculum_topics");

    await addDoc(topicsRef, {
        title,
        lessons: []
    });

    document.getElementById("topicTitleInput").value = "";
}

/* --------------------------
       RENDER TOPIC
---------------------------*/
function renderTopic(id, topic){
    const div = document.createElement("div");
    div.className = "section-box";

    div.innerHTML = `
        <div class="flex justify-between items-center">
            <h2 class="font-bold text-xl text-indigo-700">${topic.title}</h2>
            <button class="text-red-500" onclick="deleteTopic('${id}')">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>

        <div class="mt-3">
            ${topic.lessons.map((l, i) => renderLesson(id, i, l)).join("")}
        </div>

        <!-- ADD LESSON -->
        <div class="mt-4 p-3 bg-gray-50 border rounded-lg">
            <h3 class="font-semibold mb-2 text-indigo-600">Add Lesson</h3>
            <input id="lessonTitle-${id}" placeholder="Lesson title"
                class="w-full p-2 border rounded mb-2">

            <textarea id="lessonNotes-${id}" placeholder="Notes..."
                class="w-full p-2 border rounded mb-2"></textarea>

            <input id="lessonLinks-${id}" placeholder="Links (comma separated)"
                class="w-full p-2 border rounded mb-2">

            <input type="file" id="lessonFiles-${id}" multiple class="mb-2">

            <button onclick="addLesson('${id}')"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded">
                Add Lesson
            </button>
        </div>
    `;

    return div;
}

/* --------------------------
      RENDER LESSON
---------------------------*/
function renderLesson(topicId, index, lesson){
    return `
        <div class="lesson-box">
            <div class="collapsible-header" onclick="toggleLesson('${topicId}-${index}')">
                <h3 class="font-bold text-indigo-800">${lesson.title}</h3>
                <i class="fa-solid fa-chevron-down text-indigo-700"></i>
            </div>

            <div id="lessonContent-${topicId}-${index}" class="hidden-section mt-2">

                <p class="text-gray-700 mb-3">${lesson.notes || ""}</p>

                <h4 class="font-semibold">Links:</h4>
                <ul class="mb-3">
                    ${lesson.links?.map(l => `<li><a href="${l}" target="_blank" class="text-indigo-600 underline">${l}</a></li>`).join("") || "None"}
                </ul>

                <h4 class="font-semibold">Attachments:</h4>
                <ul class="mb-3">
                    ${lesson.attachments?.map(a => `<li>${a}</li>`).join("") || "None"}
                </ul>

                <button onclick="deleteLesson('${topicId}', ${index})"
                    class="text-red-600 font-semibold mt-3">
                    Delete Lesson
                </button>
            </div>
        </div>
    `;
}

window.toggleLesson = (id)=>{
    document.getElementById("lessonContent-" + id).classList.toggle("hidden-section");
};

/* --------------------------
    ADD LESSON TO TOPIC
---------------------------*/
window.addLesson = async (topicId)=>{
    const title = document.getElementById(`lessonTitle-${topicId}`).value.trim();
    const notes = document.getElementById(`lessonNotes-${topicId}`).value.trim();
    const linksRaw = document.getElementById(`lessonLinks-${topicId}`).value.trim();
    const filesInput = document.getElementById(`lessonFiles-${topicId}`);

    if(!title) return;

    const links = linksRaw ? linksRaw.split(",").map(x=>x.trim()) : [];

    const attachments = [...filesInput.files].map(f => f.name);

    const ref = doc(db, "artifacts", "school-organiser-5f512", "users", userId, "curriculum_topics", topicId);

    const snap = await (await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js")).getDoc(ref);
    const data = snap.data();

    data.lessons.push({title, notes, links, attachments});

    await updateDoc(ref, data);

    document.getElementById(`lessonTitle-${topicId}`).value="";
    document.getElementById(`lessonNotes-${topicId}`).value="";
    document.getElementById(`lessonLinks-${topicId}`).value="";
    filesInput.value="";
};

/* --------------------------
    DELETE LESSON
---------------------------*/
window.deleteLesson = async (topicId, index)=>{
    const ref = doc(db, "artifacts", "school-organiser-5f512", "users", userId, "curriculum_topics", topicId);

    const snap = await (await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js")).getDoc(ref);
    const data = snap.data();

    data.lessons.splice(index, 1);

    await updateDoc(ref, data);
};

/* --------------------------
    DELETE TOPIC
---------------------------*/
window.deleteTopic = async (topicId)=>{
    const ref = doc(db, "artifacts", "school-organiser-5f512", "users", userId, "curriculum_topics", topicId);
    await deleteDoc(ref);
};
</script>

</body>
</html>