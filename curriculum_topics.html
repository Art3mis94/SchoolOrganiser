<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curriculum Hub | Educator Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Collapsible Logic */
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0, 1, 0, 1); }
    .open { max-height: 5000px; transition: max-height 0.8s ease-in-out; }
    .rotate-icon { transform: rotate(180deg); transition: transform 0.3s; }
    
    /* Styling */
    .year-header { transition: background 0.3s; border-radius: 1.5rem; }
    .year-header:hover { background: #f3f4f6; }
    .class-card { border-left: 5px solid #10b981; }
    .dropzone { border: 2px dashed #4338ca; border-radius: 1rem; padding: 1.5rem; text-align: center; cursor: pointer; background: #f5f3ff; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen pb-24">

<nav class="bg-indigo-700 p-4 shadow-2xl mb-10">
    <div class="container max-w-6xl mx-auto flex justify-between items-center text-white">
        <h2 class="font-black tracking-tighter text-xl italic">EDUCATOR<span class="text-indigo-300">HUB</span></h2>
        <div class="flex gap-6 font-semibold">
            <a href="dashboard.html" class="hover:text-indigo-200 transition">Dashboard</a>
            <a href="topics.html" class="border-b-2 border-white pb-1">Curriculum</a>
            <a href="resources.html" class="hover:text-indigo-200 transition">Tools</a>
        </div>
        <button id="logoutBtn" class="bg-indigo-800 px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition">Sign Out</button>
    </div>
</nav>

<div class="container max-w-5xl mx-auto px-4">
  <div class="flex justify-between items-end mb-12">
      <div>
          <h1 class="text-5xl font-black text-gray-900 uppercase tracking-tighter">Academic Year</h1>
          <p class="text-gray-500 font-medium">Click a Year Group to view classes</p>
      </div>
      <button onclick="openModal('yearGroup')" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition">
          <i class="fa-solid fa-plus mr-2"></i> New Section
      </button>
  </div>
  
  <div id="yearGroupContainer" class="space-y-6">
    </div>
</div>

<div id="universalModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
  <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8">
    <div class="flex justify-between items-center mb-6">
        <h3 id="modalTitle" class="text-2xl font-black text-gray-800 uppercase italic">Add Item</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    
    <form id="universalForm" class="space-y-5">
      <div>
          <label id="inputLabel" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">Name</label>
          <input type="text" id="mainInput" class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-indigo-500 outline-none transition" required>
      </div>
      
      <div id="lessonExtras" class="hidden space-y-5">
          <textarea id="subInput" class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-indigo-500 outline-none transition" placeholder="Learning objectives..."></textarea>
          <div class="dropzone" onclick="document.getElementById('fileInput').click()">
              <i class="fa-solid fa-cloud-arrow-up text-indigo-500 text-2xl mb-2"></i>
              <p id="fileStatus" class="text-sm font-bold text-indigo-900">Upload lesson materials</p>
              <input type="file" id="fileInput" class="hidden">
          </div>
      </div>

      <div class="flex gap-3 pt-4">
        <button type="button" onclick="closeModal()" class="flex-1 py-4 bg-gray-100 text-gray-600 rounded-2xl font-black uppercase tracking-widest">Cancel</button>
        <button type="submit" id="saveBtn" class="flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-lg">Save</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyChZSrBTGv0pjjSG-3XVOEI4eTXCQyk9cw",
  authDomain: "school-organiser-5f512.firebaseapp.com",
  projectId: "school-organiser-5f512",
  storageBucket: "school-organiser-5f512.appspot.com",
  messagingSenderId: "567803400438",
  appId: "1:567803400438:web:56ea2010e2d2a54fcc5cd7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let currentUser, activeYearId, activeClassId, activeTopicId, modalMode;

onAuthStateChanged(auth, user => { 
    if(user){ currentUser = user; loadYearGroups(); } 
    else { window.location.href = 'index.html'; }
});

// 1. Load Year Groups
function loadYearGroups() {
    const q = query(collection(db, 'users', currentUser.uid, 'yearGroups'), orderBy('createdAt', 'asc'));
    onSnapshot(q, snap => {
        const container = document.getElementById('yearGroupContainer');
        container.innerHTML = '';
        snap.forEach(d => {
            const yr = {id: d.id, ...d.data()};
            const div = document.createElement('div');
            div.className = "bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden";
            div.innerHTML = `
                <div class="year-header p-8 flex justify-between items-center cursor-pointer" onclick="toggle('year-${yr.id}')">
                    <h2 class="text-4xl font-black text-indigo-900 uppercase italic tracking-tighter">${yr.name}</h2>
                    <div class="flex gap-4 items-center">
                        <button onclick="event.stopPropagation(); deleteItem('yearGroups', '${yr.id}')" class="text-red-200 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                        <i id="icon-year-${yr.id}" class="fa-solid fa-chevron-down text-indigo-300 transition-transform text-2xl"></i>
                    </div>
                </div>
                <div id="year-${yr.id}" class="collapsible-content border-t border-gray-50">
                    <div class="p-8 bg-gray-50/30">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-sm font-black text-indigo-400 uppercase tracking-widest">Assigned Classes</h4>
                            <button onclick="openModal('class', '${yr.id}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold text-xs">+ Add Class</button>
                        </div>
                        <div id="classes-for-${yr.id}" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            loadClasses(yr.id);
        });
    });
}

// 2. Load Classes
function loadClasses(yearId) {
    const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', yearId, 'classes'), orderBy('createdAt', 'asc'));
    onSnapshot(q, snap => {
        const list = document.getElementById(`classes-for-${yearId}`);
        list.innerHTML = '';
        snap.forEach(d => {
            const cls = {id: d.id, ...d.data()};
            const div = document.createElement('div');
            div.className = "bg-white rounded-2xl shadow-sm border border-gray-100 class-card overflow-hidden";
            div.innerHTML = `
                <div class="p-5 flex justify-between items-center cursor-pointer hover:bg-emerald-50/50" onclick="toggle('class-${cls.id}')">
                    <h3 class="text-xl font-black text-emerald-900 uppercase tracking-tight">${cls.name}</h3>
                    <div class="flex gap-4 items-center">
                        <button onclick="event.stopPropagation(); openModal('topic', '${yearId}', '${cls.id}')" class="text-emerald-600 font-bold text-sm">+ Topic</button>
                        <i id="icon-class-${cls.id}" class="fa-solid fa-chevron-down text-emerald-200 transition-transform"></i>
                    </div>
                </div>
                <div id="class-${cls.id}" class="collapsible-content border-t border-emerald-50">
                    <div id="topics-for-${cls.id}" class="p-4 space-y-4 bg-gray-50/50"></div>
                </div>
            `;
            list.appendChild(div);
            loadTopics(yearId, cls.id);
        });
    });
}

// 3. Load Topics
function loadTopics(yearId, classId) {
    const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', yearId, 'classes', classId, 'topics'), orderBy('createdAt', 'asc'));
    onSnapshot(q, snap => {
        const list = document.getElementById(`topics-for-${classId}`);
        list.innerHTML = '';
        snap.forEach(d => {
            const top = {id: d.id, ...d.data()};
            const div = document.createElement('div');
            div.className = "bg-white border-2 border-gray-100 rounded-xl overflow-hidden";
            div.innerHTML = `
                <div class="p-3 flex justify-between items-center cursor-pointer" onclick="toggle('topic-${top.id}')">
                    <span class="font-bold text-gray-700 uppercase text-xs tracking-wide">${top.name}</span>
                    <button onclick="event.stopPropagation(); openModal('lesson', '${yearId}', '${classId}', '${top.id}')" class="text-indigo-500 font-bold text-[10px] uppercase border border-indigo-100 px-2 py-1 rounded-md hover:bg-indigo-50">+ Lesson</button>
                </div>
                <div id="topic-${top.id}" class="collapsible-content border-t bg-white">
                    <div id="lessons-for-${top.id}" class="p-4 space-y-3"></div>
                </div>
            `;
            list.appendChild(div);
            loadLessons(yearId, classId, top.id);
        });
    });
}

// 4. Load Lessons
function loadLessons(yrId, clsId, topId) {
    const q = query(collection(db, 'users', currentUser.uid, 'yearGroups', yrId, 'classes', clsId, 'topics', topId, 'lessons'), orderBy('createdAt', 'asc'));
    onSnapshot(q, snap => {
        const list = document.getElementById(`lessons-for-${topId}`);
        list.innerHTML = snap.empty ? '<p class="text-gray-300 text-[10px] uppercase font-bold italic">No lessons registered.</p>' : '';
        snap.forEach(d => {
            const les = d.data();
            const div = document.createElement('div');
            div.className = "flex justify-between items-center p-3 bg-indigo-50/50 rounded-xl border border-indigo-100";
            div.innerHTML = `
                <div>
                    <p class="font-bold text-indigo-900 text-sm">${les.title}</p>
                    <p class="text-xs text-indigo-400 mt-1 line-clamp-1">${les.content || ''}</p>
                </div>
                ${les.fileUrl ? `<a href="${les.fileUrl}" target="_blank" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 transition">View</a>` : ''}
            `;
            list.appendChild(div);
        });
    });
}

// Global UI Controls
window.toggle = (id) => {
    document.getElementById(id).classList.toggle('open');
    const icon = document.getElementById('icon-' + id);
    if(icon) icon.classList.toggle('rotate-icon');
};

window.openModal = (mode, yr = null, cls = null, top = null) => {
    modalMode = mode; activeYearId = yr; activeClassId = cls; activeTopicId = top;
    document.getElementById('universalForm').reset();
    document.getElementById('modalTitle').innerText = `Add New ${mode}`;
    document.getElementById('lessonExtras').classList.toggle('hidden', mode !== 'lesson');
    document.getElementById('universalModal').classList.remove('hidden');
};

document.getElementById('universalForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.innerText = "Syncing...";
    let path;
    const name = document.getElementById('mainInput').value;
    const data = { createdAt: new Date() };

    if(modalMode === 'yearGroup') { path = collection(db, 'users', currentUser.uid, 'yearGroups'); data.name = name; }
    else if (modalMode === 'class') { path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes'); data.name = name; }
    else if (modalMode === 'topic') { path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes', activeClassId, 'topics'); data.name = name; }
    else if (modalMode === 'lesson') {
        path = collection(db, 'users', currentUser.uid, 'yearGroups', activeYearId, 'classes', activeClassId, 'topics', activeTopicId, 'lessons');
        data.title = name; data.content = document.getElementById('subInput').value;
        const file = document.getElementById('fileInput').files[0];
        if(file) {
            const sRef = ref(storage, `curriculum/${currentUser.uid}/${Date.now()}_${file.name}`);
            await uploadBytes(sRef, file);
            data.fileUrl = await getDownloadURL(sRef);
        }
    }
    await addDoc(path, data);
    closeModal();
    btn.disabled = false; btn.innerText = "Save";
};

window.deleteItem = async (col, id) => { if(confirm("Confirm deletion?")) await deleteDoc(doc(db, 'users', currentUser.uid, col, id)); };
window.closeModal = () => document.getElementById('universalModal').classList.add('hidden');
document.getElementById('logoutBtn').onclick = () => signOut(auth);
</script>
</body>
</html>
